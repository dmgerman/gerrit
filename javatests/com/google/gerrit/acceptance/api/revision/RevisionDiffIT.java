begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|// Copyright (C) 2017 The Android Open Source Project
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Licensed under the Apache License, Version 2.0 (the "License");
end_comment

begin_comment
comment|// you may not use this file except in compliance with the License.
end_comment

begin_comment
comment|// You may obtain a copy of the License at
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// http://www.apache.org/licenses/LICENSE-2.0
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Unless required by applicable law or agreed to in writing, software
end_comment

begin_comment
comment|// distributed under the License is distributed on an "AS IS" BASIS,
end_comment

begin_comment
comment|// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
end_comment

begin_comment
comment|// See the License for the specific language governing permissions and
end_comment

begin_comment
comment|// limitations under the License.
end_comment

begin_package
DECL|package|com.google.gerrit.acceptance.api.revision
package|package
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|api
operator|.
name|revision
package|;
end_package

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|truth
operator|.
name|Truth
operator|.
name|assertThat
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|truth
operator|.
name|TruthJUnit
operator|.
name|assume
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|entities
operator|.
name|Patch
operator|.
name|COMMIT_MSG
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|testing
operator|.
name|DiffInfoSubject
operator|.
name|assertThat
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|testing
operator|.
name|FileInfoSubject
operator|.
name|assertThat
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|git
operator|.
name|ObjectIds
operator|.
name|abbreviateName
import|;
end_import

begin_import
import|import static
name|java
operator|.
name|util
operator|.
name|stream
operator|.
name|Collectors
operator|.
name|joining
import|;
end_import

begin_import
import|import static
name|java
operator|.
name|util
operator|.
name|stream
operator|.
name|Collectors
operator|.
name|toMap
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Joiner
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ImmutableList
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ImmutableMap
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|AbstractDaemonTest
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|GitUtil
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|PushOneCommit
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|PushOneCommit
operator|.
name|Result
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|RawInputUtil
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|changes
operator|.
name|FileApi
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|changes
operator|.
name|RebaseInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|changes
operator|.
name|ReviewInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|changes
operator|.
name|ReviewInput
operator|.
name|CommentInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|Comment
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|DiffPreferencesInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|ChangeType
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|DiffInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|FileInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|BinaryResult
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|RestApiException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|testing
operator|.
name|ConfigSuite
import|;
end_import

begin_import
import|import
name|java
operator|.
name|awt
operator|.
name|image
operator|.
name|BufferedImage
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|text
operator|.
name|SimpleDateFormat
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Locale
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|function
operator|.
name|Function
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|stream
operator|.
name|IntStream
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|imageio
operator|.
name|ImageIO
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|Config
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|ObjectId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|PersonIdent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|revwalk
operator|.
name|RevCommit
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Before
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_class
DECL|class|RevisionDiffIT
specifier|public
class|class
name|RevisionDiffIT
extends|extends
name|AbstractDaemonTest
block|{
comment|// @RunWith(Parameterized.class) can't be used as AbstractDaemonTest is annotated with another
comment|// runner. Using different configs is a workaround to achieve the same.
DECL|field|TEST_PARAMETER_MARKER
specifier|private
specifier|static
specifier|final
name|String
name|TEST_PARAMETER_MARKER
init|=
literal|"test_only_parameter"
decl_stmt|;
DECL|field|CURRENT
specifier|private
specifier|static
specifier|final
name|String
name|CURRENT
init|=
literal|"current"
decl_stmt|;
DECL|field|FILE_NAME
specifier|private
specifier|static
specifier|final
name|String
name|FILE_NAME
init|=
literal|"some_file.txt"
decl_stmt|;
DECL|field|FILE_NAME2
specifier|private
specifier|static
specifier|final
name|String
name|FILE_NAME2
init|=
literal|"another_file.txt"
decl_stmt|;
DECL|field|FILE_CONTENT
specifier|private
specifier|static
specifier|final
name|String
name|FILE_CONTENT
init|=
name|IntStream
operator|.
name|rangeClosed
argument_list|(
literal|1
argument_list|,
literal|100
argument_list|)
operator|.
name|mapToObj
argument_list|(
name|number
lambda|->
name|String
operator|.
name|format
argument_list|(
literal|"Line %d\n"
argument_list|,
name|number
argument_list|)
argument_list|)
operator|.
name|collect
argument_list|(
name|joining
argument_list|()
argument_list|)
decl_stmt|;
DECL|field|FILE_CONTENT2
specifier|private
specifier|static
specifier|final
name|String
name|FILE_CONTENT2
init|=
literal|"1st line\n2nd line\n3rd line\n"
decl_stmt|;
DECL|field|intraline
specifier|private
name|boolean
name|intraline
decl_stmt|;
DECL|field|commit1
specifier|private
name|ObjectId
name|commit1
decl_stmt|;
DECL|field|changeId
specifier|private
name|String
name|changeId
decl_stmt|;
DECL|field|initialPatchSetId
specifier|private
name|String
name|initialPatchSetId
decl_stmt|;
annotation|@
name|ConfigSuite
operator|.
name|Config
DECL|method|intralineConfig ()
specifier|public
specifier|static
name|Config
name|intralineConfig
parameter_list|()
block|{
name|Config
name|config
init|=
operator|new
name|Config
argument_list|()
decl_stmt|;
name|config
operator|.
name|setBoolean
argument_list|(
name|TEST_PARAMETER_MARKER
argument_list|,
literal|null
argument_list|,
literal|"intraline"
argument_list|,
literal|true
argument_list|)
expr_stmt|;
return|return
name|config
return|;
block|}
annotation|@
name|Before
DECL|method|setUp ()
specifier|public
name|void
name|setUp
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Reduce flakiness of tests. (If tests aren't fast enough, we would use a fall-back
comment|// computation, which might yield different results.)
name|baseConfig
operator|.
name|setString
argument_list|(
literal|"cache"
argument_list|,
literal|"diff"
argument_list|,
literal|"timeout"
argument_list|,
literal|"1 minute"
argument_list|)
expr_stmt|;
name|baseConfig
operator|.
name|setString
argument_list|(
literal|"cache"
argument_list|,
literal|"diff_intraline"
argument_list|,
literal|"timeout"
argument_list|,
literal|"1 minute"
argument_list|)
expr_stmt|;
name|intraline
operator|=
name|baseConfig
operator|.
name|getBoolean
argument_list|(
name|TEST_PARAMETER_MARKER
argument_list|,
literal|"intraline"
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|ObjectId
name|headCommit
init|=
name|testRepo
operator|.
name|getRepository
argument_list|()
operator|.
name|resolve
argument_list|(
literal|"HEAD"
argument_list|)
decl_stmt|;
name|commit1
operator|=
name|addCommit
argument_list|(
name|headCommit
argument_list|,
name|ImmutableMap
operator|.
name|of
argument_list|(
name|FILE_NAME
argument_list|,
name|FILE_CONTENT
argument_list|,
name|FILE_NAME2
argument_list|,
name|FILE_CONTENT2
argument_list|)
argument_list|)
expr_stmt|;
name|Result
name|result
init|=
name|createEmptyChange
argument_list|()
decl_stmt|;
name|changeId
operator|=
name|result
operator|.
name|getChangeId
argument_list|()
expr_stmt|;
name|initialPatchSetId
operator|=
name|result
operator|.
name|getPatchSetId
argument_list|()
operator|.
name|getId
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|diff ()
specifier|public
name|void
name|diff
parameter_list|()
throws|throws
name|Exception
block|{
comment|// The assertions assume that intraline is false.
name|assume
argument_list|()
operator|.
name|that
argument_list|(
name|intraline
argument_list|)
operator|.
name|isFalse
argument_list|()
expr_stmt|;
name|String
name|fileName
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"First line\nSecond line\n"
decl_stmt|;
name|PushOneCommit
operator|.
name|Result
name|result
init|=
name|createChange
argument_list|(
literal|"Add a file"
argument_list|,
name|fileName
argument_list|,
name|fileContent
argument_list|)
decl_stmt|;
name|assertDiffForNewFile
argument_list|(
name|result
argument_list|,
name|fileName
argument_list|,
name|fileContent
argument_list|)
expr_stmt|;
name|assertDiffForNewFile
argument_list|(
name|result
argument_list|,
name|COMMIT_MSG
argument_list|,
name|result
operator|.
name|getCommit
argument_list|()
operator|.
name|getFullMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedFileIsIncludedInDiff ()
specifier|public
name|void
name|deletedFileIsIncludedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|deleteFile
argument_list|(
name|FILE_NAME
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|FILE_NAME
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|numberOfLinesInDiffOfDeletedFileWithoutNewlineAtEndIsCorrect ()
specifier|public
name|void
name|numberOfLinesInDiffOfDeletedFileWithoutNewlineAtEndIsCorrect
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|deleteFile
argument_list|(
name|filePath
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|numberOfLinesInFileInfoOfDeletedFileWithoutNewlineAtEndIsCorrect ()
specifier|public
name|void
name|numberOfLinesInFileInfoOfDeletedFileWithoutNewlineAtEndIsCorrect
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|deleteFile
argument_list|(
name|filePath
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|filePath
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|filePath
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|numberOfLinesInDiffOfDeletedFileWithNewlineAtEndIsCorrect ()
specifier|public
name|void
name|numberOfLinesInDiffOfDeletedFileWithNewlineAtEndIsCorrect
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|deleteFile
argument_list|(
name|filePath
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|numberOfLinesInFileInfoOfDeletedFileWithNewlineAtEndIsCorrect ()
specifier|public
name|void
name|numberOfLinesInFileInfoOfDeletedFileWithNewlineAtEndIsCorrect
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|deleteFile
argument_list|(
name|filePath
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|filePath
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
comment|// Inherited from Git: An empty last line is ignored in the count.
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|filePath
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedFileWithoutNewlineAtEndResultsInOneDiffEntry ()
specifier|public
name|void
name|deletedFileWithoutNewlineAtEndResultsInOneDiffEntry
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|deleteFile
argument_list|(
name|filePath
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|onlyElement
argument_list|()
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|,
literal|"Line 2"
argument_list|,
literal|"Line 3"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedFileWithNewlineAtEndResultsInOneDiffEntry ()
specifier|public
name|void
name|deletedFileWithNewlineAtEndResultsInOneDiffEntry
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|deleteFile
argument_list|(
name|filePath
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|onlyElement
argument_list|()
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|,
literal|"Line 2"
argument_list|,
literal|"Line 3"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedFileIsIncludedInDiff ()
specifier|public
name|void
name|addedFileIsIncludedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFilePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|newFileContent
init|=
literal|"arbitrary content"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|newFilePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|newFileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|newFilePath
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|numberOfLinesInDiffOfAddedFileWithoutNewlineAtEndIsCorrect ()
specifier|public
name|void
name|numberOfLinesInDiffOfAddedFileWithoutNewlineAtEndIsCorrect
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine2\nLine 3"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|numberOfLinesInFileInfoOfAddedFileWithoutNewlineAtEndIsCorrect ()
specifier|public
name|void
name|numberOfLinesInFileInfoOfAddedFileWithoutNewlineAtEndIsCorrect
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine2\nLine 3"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|filePath
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|filePath
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|numberOfLinesInDiffOfAddedFileWithNewlineAtEndIsCorrect ()
specifier|public
name|void
name|numberOfLinesInDiffOfAddedFileWithNewlineAtEndIsCorrect
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine2\nLine 3\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|numberOfLinesInFileInfoOfAddedFileWithNewlineAtEndIsCorrect ()
specifier|public
name|void
name|numberOfLinesInFileInfoOfAddedFileWithNewlineAtEndIsCorrect
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine2\nLine 3\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
comment|// Inherited from Git: An empty last line is ignored in the count.
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|filePath
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|filePath
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedFileWithoutNewlineAtEndResultsInOneDiffEntry ()
specifier|public
name|void
name|addedFileWithoutNewlineAtEndResultsInOneDiffEntry
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|onlyElement
argument_list|()
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|,
literal|"Line 2"
argument_list|,
literal|"Line 3"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedFileWithNewlineAtEndResultsInOneDiffEntry ()
specifier|public
name|void
name|addedFileWithNewlineAtEndResultsInOneDiffEntry
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|onlyElement
argument_list|()
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|,
literal|"Line 2"
argument_list|,
literal|"Line 3"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|renamedFileIsIncludedInDiff ()
specifier|public
name|void
name|renamedFileIsIncludedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFilePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|FILE_NAME
argument_list|,
name|newFilePath
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|newFilePath
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|copiedFileTreatedAsAddedFileInDiff ()
specifier|public
name|void
name|copiedFileTreatedAsAddedFileInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|copyFilePath
init|=
literal|"copy_of_some_file.txt"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|copyFilePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|FILE_CONTENT
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|copyFilePath
argument_list|)
expr_stmt|;
comment|// If this ever changes, please add tests which cover copied files.
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|copyFilePath
argument_list|)
argument_list|)
operator|.
name|status
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|'A'
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|copyFilePath
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|copyFilePath
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedBinaryFileIsIncludedInDiff ()
specifier|public
name|void
name|addedBinaryFileIsIncludedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|imageFileName
init|=
literal|"an_image.png"
decl_stmt|;
name|byte
index|[]
name|imageBytes
init|=
name|createRgbImage
argument_list|(
literal|255
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|imageFileName
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|imageBytes
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|imageFileName
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|modifiedBinaryFileIsIncludedInDiff ()
specifier|public
name|void
name|modifiedBinaryFileIsIncludedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|imageFileName
init|=
literal|"an_image.png"
decl_stmt|;
name|byte
index|[]
name|imageBytes1
init|=
name|createRgbImage
argument_list|(
literal|255
argument_list|,
literal|100
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|imageFileName
argument_list|,
name|imageBytes1
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|byte
index|[]
name|imageBytes2
init|=
name|createRgbImage
argument_list|(
literal|0
argument_list|,
literal|100
argument_list|,
literal|255
argument_list|)
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|imageFileName
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|imageBytes2
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|imageFileName
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|diffOnMergeCommitChange ()
specifier|public
name|void
name|diffOnMergeCommitChange
parameter_list|()
throws|throws
name|Exception
block|{
name|PushOneCommit
operator|.
name|Result
name|r
init|=
name|createMergeCommitChange
argument_list|(
literal|"refs/for/master"
argument_list|)
decl_stmt|;
name|DiffInfo
name|diff
decl_stmt|;
comment|// automerge
name|diff
operator|=
name|getDiffRequest
argument_list|(
name|r
operator|.
name|getChangeId
argument_list|()
argument_list|,
name|r
operator|.
name|getCommit
argument_list|()
operator|.
name|name
argument_list|()
argument_list|,
literal|"foo"
argument_list|)
operator|.
name|get
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaA
operator|.
name|lines
argument_list|)
operator|.
name|isEqualTo
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaB
operator|.
name|lines
argument_list|)
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|diff
operator|=
name|getDiffRequest
argument_list|(
name|r
operator|.
name|getChangeId
argument_list|()
argument_list|,
name|r
operator|.
name|getCommit
argument_list|()
operator|.
name|name
argument_list|()
argument_list|,
literal|"bar"
argument_list|)
operator|.
name|get
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaA
operator|.
name|lines
argument_list|)
operator|.
name|isEqualTo
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaB
operator|.
name|lines
argument_list|)
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|// parent 1
name|diff
operator|=
name|getDiffRequest
argument_list|(
name|r
operator|.
name|getChangeId
argument_list|()
argument_list|,
name|r
operator|.
name|getCommit
argument_list|()
operator|.
name|name
argument_list|()
argument_list|,
literal|"bar"
argument_list|)
operator|.
name|withParent
argument_list|(
literal|1
argument_list|)
operator|.
name|get
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaA
operator|.
name|lines
argument_list|)
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaB
operator|.
name|lines
argument_list|)
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|// parent 2
name|diff
operator|=
name|getDiffRequest
argument_list|(
name|r
operator|.
name|getChangeId
argument_list|()
argument_list|,
name|r
operator|.
name|getCommit
argument_list|()
operator|.
name|name
argument_list|()
argument_list|,
literal|"foo"
argument_list|)
operator|.
name|withParent
argument_list|(
literal|2
argument_list|)
operator|.
name|get
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaA
operator|.
name|lines
argument_list|)
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaB
operator|.
name|lines
argument_list|)
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|diffOfUnmodifiedFileMarksAllLinesAsCommon ()
specifier|public
name|void
name|diffOfUnmodifiedFileMarksAllLinesAsCommon
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyCommitMessage
argument_list|(
literal|"An unchanged patchset"
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|onlyElement
argument_list|()
operator|.
name|commonLines
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|,
literal|"Line 2"
argument_list|,
literal|"Line 3"
argument_list|,
literal|""
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|onlyElement
argument_list|()
operator|.
name|linesOfA
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|onlyElement
argument_list|()
operator|.
name|linesOfB
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|diffOfUnmodifiedFileWithNewlineAtEndHasEmptyLineAtEnd ()
specifier|public
name|void
name|diffOfUnmodifiedFileWithNewlineAtEndHasEmptyLineAtEnd
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyCommitMessage
argument_list|(
literal|"An unchanged patchset"
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|onlyElement
argument_list|()
operator|.
name|commonLines
argument_list|()
operator|.
name|lastElement
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|diffOfUnmodifiedFileWithoutNewlineAtEndEndsWithLastLineContent ()
specifier|public
name|void
name|diffOfUnmodifiedFileWithoutNewlineAtEndEndsWithLastLineContent
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyCommitMessage
argument_list|(
literal|"An unchanged patchset"
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|onlyElement
argument_list|()
operator|.
name|commonLines
argument_list|()
operator|.
name|lastElement
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|"Line 3"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|diffOfModifiedFileWithNewlineAtEndHasEmptyLineAtEnd ()
specifier|public
name|void
name|diffOfModifiedFileWithNewlineAtEndHasEmptyLineAtEnd
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|filePath
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 1\n"
argument_list|,
literal|"Line one\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|lastElement
argument_list|()
operator|.
name|commonLines
argument_list|()
operator|.
name|lastElement
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|diffOfModifiedFileWithoutNewlineAtEndEndsWithLastLineContent ()
specifier|public
name|void
name|diffOfModifiedFileWithoutNewlineAtEndEndsWithLastLineContent
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|filePath
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 1\n"
argument_list|,
literal|"Line one\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|lastElement
argument_list|()
operator|.
name|commonLines
argument_list|()
operator|.
name|lastElement
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|"Line 3"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|diffOfModifiedLastLineWithNewlineAtEndHasEmptyLineAtEnd ()
specifier|public
name|void
name|diffOfModifiedLastLineWithNewlineAtEndHasEmptyLineAtEnd
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|filePath
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 3\n"
argument_list|,
literal|"Line three\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|lastElement
argument_list|()
operator|.
name|commonLines
argument_list|()
operator|.
name|lastElement
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|diffOfModifiedLastLineWithoutNewlineAtEndEndsWithLastLineContent ()
specifier|public
name|void
name|diffOfModifiedLastLineWithoutNewlineAtEndEndsWithLastLineContent
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|filePath
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 3"
argument_list|,
literal|"Line three"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|lastElement
argument_list|()
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 3"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|lastElement
argument_list|()
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line three"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedNewlineAtEndOfFileIsMarkedInDiffWhenWhitespaceIsConsidered ()
specifier|public
name|void
name|addedNewlineAtEndOfFileIsMarkedInDiffWhenWhitespaceIsConsidered
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_NONE
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 101"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 101"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|101
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|102
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedNewlineAtEndOfFileIsMarkedInDiffWhenWhitespaceIsIgnored ()
specifier|public
name|void
name|addedNewlineAtEndOfFileIsMarkedInDiffWhenWhitespaceIsIgnored
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_ALL
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|101
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|102
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedNewlineAtEndOfFileMeansOneModifiedLine ()
specifier|public
name|void
name|addedNewlineAtEndOfFileMeansOneModifiedLine
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"\n"
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedNewlineAtEndOfFileIsMarkedInDiffWhenOtherwiseOnlyEditsDueToRebaseExist ()
specifier|public
name|void
name|addedNewlineAtEndOfFileIsMarkedInDiffWhenOtherwiseOnlyEditsDueToRebaseExist
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newBaseFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 70\n"
argument_list|,
literal|"Line seventy\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newBaseFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_NONE
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isNotNull
argument_list|()
expr_stmt|;
comment|// Line 70 modification
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 101"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 101"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|101
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|102
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
comment|// TODO: Fix this issue. This test documents the current behavior and ensures that we at least
comment|//  don't run into an internal server error.
DECL|method|addedNewlineAtEndOfFileIsNotIdentifiedAsDueToRebaseEvenThoughItShould ()
specifier|public
name|void
name|addedNewlineAtEndOfFileIsNotIdentifiedAsDueToRebaseEvenThoughItShould
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|baseFileContent
init|=
name|FILE_CONTENT
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|baseFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
comment|// Add a comment so that file contents are not 'skipped'. To be able to add a comment, touch
comment|// (= modify) the file in the change.
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 2\n"
argument_list|,
literal|"Line two\n"
argument_list|)
argument_list|)
expr_stmt|;
name|CommentInput
name|comment
init|=
name|createCommentInput
argument_list|(
literal|3
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|"Comment to not skip file content."
argument_list|)
decl_stmt|;
name|addCommentTo
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|,
name|comment
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newBaseFileContent
init|=
name|baseFileContent
operator|.
name|concat
argument_list|(
literal|"\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit3
init|=
name|addCommit
argument_list|(
name|commit2
argument_list|,
name|FILE_NAME
argument_list|,
name|newBaseFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit3
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_ALL
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|""
argument_list|)
expr_stmt|;
comment|// This should actually be isDueToRebase().
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
DECL|method|addedNewlineAtEndOfFileIsMarkedWhenEditDueToRebaseIncreasedLineCountAndWhitespaceConsidered ()
name|addedNewlineAtEndOfFileIsMarkedWhenEditDueToRebaseIncreasedLineCountAndWhitespaceConsidered
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newBaseFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 70\n"
argument_list|,
literal|"Line 70\nLine 70.5\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newBaseFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_NONE
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isNotNull
argument_list|()
expr_stmt|;
comment|// Line 70.5 insertion
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 101"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 101"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|101
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|103
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
comment|// TODO: Fix this issue. This test documents the current behavior and ensures that we at least
comment|//  don't run into an internal server error.
specifier|public
name|void
DECL|method|addedNewlineAtEndOfFileIsNotMarkedWhenEditDueToRebaseIncreasedLineCountAndWhitespaceIgnoredEvenThoughItShould ()
name|addedNewlineAtEndOfFileIsNotMarkedWhenEditDueToRebaseIncreasedLineCountAndWhitespaceIgnoredEvenThoughItShould
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newBaseFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 70\n"
argument_list|,
literal|"Line 70\nLine 70.5\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newBaseFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_ALL
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|numberOfSkippedLines
argument_list|()
operator|.
name|isGreaterThan
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedLastLineWithoutNewlineBeforeAndAfterwardsIsMarkedInDiff ()
specifier|public
name|void
name|addedLastLineWithoutNewlineBeforeAndAfterwardsIsMarkedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"\nLine 102"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_NONE
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 101"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 101"
argument_list|,
literal|"Line 102"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|101
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|102
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedLastLineWithoutNewlineBeforeAndAfterwardsMeansTwoModifiedLines ()
specifier|public
name|void
name|addedLastLineWithoutNewlineBeforeAndAfterwardsMeansTwoModifiedLines
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"\nLine 102"
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedLastLineWithoutNewlineBeforeButWithOneAfterwardsIsMarkedInDiff ()
specifier|public
name|void
name|addedLastLineWithoutNewlineBeforeButWithOneAfterwardsIsMarkedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"\nLine 102\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_NONE
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 101"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 101"
argument_list|,
literal|"Line 102"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|101
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|103
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedLastLineWithoutNewlineBeforeButWithOneAfterwardsMeansTwoModifiedLines ()
specifier|public
name|void
name|addedLastLineWithoutNewlineBeforeButWithOneAfterwardsMeansTwoModifiedLines
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"\nLine 102\n"
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
comment|// Inherited from Git: An empty last line is ignored in the count.
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedLastLineWithNewlineBeforeAndAfterwardsIsMarkedInDiff ()
specifier|public
name|void
name|addedLastLineWithNewlineBeforeAndAfterwardsIsMarkedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 101"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|101
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|102
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedLastLineWithNewlineBeforeAndAfterwardsMeansOneInsertedLine ()
specifier|public
name|void
name|addedLastLineWithNewlineBeforeAndAfterwardsMeansOneInsertedLine
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101\n"
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedLastLineWithNewlineBeforeButWithoutOneAfterwardsIsMarkedInDiff ()
specifier|public
name|void
name|addedLastLineWithNewlineBeforeButWithoutOneAfterwardsIsMarkedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 101"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|101
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|101
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedLastLineWithNewlineBeforeButWithoutOneAfterwardsMeansOneInsertedLine ()
specifier|public
name|void
name|addedLastLineWithNewlineBeforeButWithoutOneAfterwardsMeansOneInsertedLine
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|// Inherited from Git: An empty last line is ignored in the count.
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|hunkForModifiedLastLineIsCombinedWithHunkForAddedNewlineAtEnd ()
specifier|public
name|void
name|hunkForModifiedLastLineIsCombinedWithHunkForAddedNewlineAtEnd
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 101"
argument_list|,
literal|"Line one oh one\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 101"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line one oh one"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|intralineEditsForModifiedLastLineArePreservedWhenNewlineIsAlsoAddedAtEnd ()
specifier|public
name|void
name|intralineEditsForModifiedLastLineArePreservedWhenNewlineIsAlsoAddedAtEnd
parameter_list|()
throws|throws
name|Exception
block|{
name|assume
argument_list|()
operator|.
name|that
argument_list|(
name|intraline
argument_list|)
operator|.
name|isTrue
argument_list|()
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 101"
argument_list|,
literal|"Line one oh one\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|intralineEditsOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
name|ImmutableList
operator|.
name|of
argument_list|(
literal|5
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|intralineEditsOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
name|ImmutableList
operator|.
name|of
argument_list|(
literal|5
argument_list|,
literal|11
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|hunkForModifiedSecondToLastLineIsNotCombinedWithHunkForAddedNewlineAtEnd ()
specifier|public
name|void
name|hunkForModifiedSecondToLastLineIsNotCombinedWithHunkForAddedNewlineAtEnd
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line one hundred\n"
argument_list|)
operator|.
name|concat
argument_list|(
literal|"\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 100"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line one hundred"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|""
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedNewlineAtEndOfFileIsMarkedInDiffWhenWhitespaceIsConsidered ()
specifier|public
name|void
name|deletedNewlineAtEndOfFileIsMarkedInDiffWhenWhitespaceIsConsidered
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line 100"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_NONE
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 100"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 100"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|101
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedNewlineAtEndOfFileIsMarkedInDiffWhenWhitespaceIsIgnored ()
specifier|public
name|void
name|deletedNewlineAtEndOfFileIsMarkedInDiffWhenWhitespaceIsIgnored
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line 100"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_ALL
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|101
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedNewlineAtEndOfFileMeansOneModifiedLine ()
specifier|public
name|void
name|deletedNewlineAtEndOfFileMeansOneModifiedLine
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line 100"
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedLastLineWithoutNewlineBeforeAndAfterwardsIsMarkedInDiff ()
specifier|public
name|void
name|deletedLastLineWithoutNewlineBeforeAndAfterwardsIsMarkedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line 100"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"\nLine 100"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_NONE
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 99"
argument_list|,
literal|"Line 100"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 99"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|99
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedLastLineWithoutNewlineBeforeAndAfterwardsMeansTwoModifiedLines ()
specifier|public
name|void
name|deletedLastLineWithoutNewlineBeforeAndAfterwardsMeansTwoModifiedLines
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line 100"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"\nLine 100"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedLastLineWithoutNewlineBeforeButWithOneAfterwardsIsMarkedInDiff ()
specifier|public
name|void
name|deletedLastLineWithoutNewlineBeforeButWithOneAfterwardsIsMarkedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line 100"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_NONE
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 100"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedLastLineWithoutNewlineBeforeButWithOneAfterwardsMeansOneDeletedLine ()
specifier|public
name|void
name|deletedLastLineWithoutNewlineBeforeButWithOneAfterwardsMeansOneDeletedLine
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line 100"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
comment|// Inherited from Git: An empty last line is ignored in the count.
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedLastLineWithNewlineBeforeAndAfterwardsIsMarkedInDiff ()
specifier|public
name|void
name|deletedLastLineWithNewlineBeforeAndAfterwardsIsMarkedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_NONE
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 100"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|101
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedLastLineWithNewlineBeforeAndAfterwardsMeansOneDeletedLine ()
specifier|public
name|void
name|deletedLastLineWithNewlineBeforeAndAfterwardsMeansOneDeletedLine
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedLastLineWithNewlineBeforeButWithoutOneAfterwardsIsMarkedInDiff ()
specifier|public
name|void
name|deletedLastLineWithNewlineBeforeButWithoutOneAfterwardsIsMarkedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"\nLine 100\n"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_NONE
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 99"
argument_list|,
literal|"Line 100"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 99"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaA
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|101
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|metaB
argument_list|()
operator|.
name|totalLineCount
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|99
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedLastLineWithNewlineBeforeButWithoutOneAfterwardsMeansTwoModifiedLines ()
specifier|public
name|void
name|deletedLastLineWithNewlineBeforeButWithoutOneAfterwardsMeansTwoModifiedLines
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"\nLine 100\n"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|hunkForModifiedLastLineIsCombinedWithHunkForDeletedNewlineAtEnd ()
specifier|public
name|void
name|hunkForModifiedLastLineIsCombinedWithHunkForDeletedNewlineAtEnd
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line one hundred"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 100"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line one hundred"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|intralineEditsForModifiedLastLineArePreservedWhenNewlineIsAlsoDeletedAtEnd ()
specifier|public
name|void
name|intralineEditsForModifiedLastLineArePreservedWhenNewlineIsAlsoDeletedAtEnd
parameter_list|()
throws|throws
name|Exception
block|{
name|assume
argument_list|()
operator|.
name|that
argument_list|(
name|intraline
argument_list|)
operator|.
name|isTrue
argument_list|()
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line one hundred"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|intralineEditsOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
name|ImmutableList
operator|.
name|of
argument_list|(
literal|5
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|intralineEditsOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
name|ImmutableList
operator|.
name|of
argument_list|(
literal|5
argument_list|,
literal|11
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|hunkForModifiedSecondToLastLineIsNotCombinedWithHunkForDeletedNewlineAtEnd ()
specifier|public
name|void
name|hunkForModifiedSecondToLastLineIsNotCombinedWithHunkForDeletedNewlineAtEnd
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 99\n"
argument_list|,
literal|"Line ninety-nine\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line 100"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 99"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line ninety-nine"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedUnrelatedFileIsIgnored_ForPatchSetDiffWithRebase ()
specifier|public
name|void
name|addedUnrelatedFileIsIgnored_ForPatchSetDiffWithRebase
parameter_list|()
throws|throws
name|Exception
block|{
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
literal|"file_added_in_another_commit.txt"
argument_list|,
literal|"Some file content"
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
literal|"Another line\n"
operator|::
name|concat
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|FILE_NAME
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|removedUnrelatedFileIsIgnored_ForPatchSetDiffWithRebase ()
specifier|public
name|void
name|removedUnrelatedFileIsIgnored_ForPatchSetDiffWithRebase
parameter_list|()
throws|throws
name|Exception
block|{
name|ObjectId
name|commit2
init|=
name|addCommitRemovingFiles
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME2
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
literal|"Another line\n"
operator|::
name|concat
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|FILE_NAME
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|renamedUnrelatedFileIsIgnored_ForPatchSetDiffWithRebase ()
specifier|public
name|void
name|renamedUnrelatedFileIsIgnored_ForPatchSetDiffWithRebase
parameter_list|()
throws|throws
name|Exception
block|{
name|ObjectId
name|commit2
init|=
name|addCommitRenamingFile
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME2
argument_list|,
literal|"a_new_file_name.txt"
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
literal|"Another line\n"
operator|::
name|concat
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|FILE_NAME
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|renamedUnrelatedFileIsIgnored_ForPatchSetDiffWithRebase_WhenEquallyModifiedInBoth ()
specifier|public
name|void
name|renamedUnrelatedFileIsIgnored_ForPatchSetDiffWithRebase_WhenEquallyModifiedInBoth
parameter_list|()
throws|throws
name|Exception
block|{
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"1st line\n"
argument_list|,
literal|"First line\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME2
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
comment|// Revert the modification to be able to rebase.
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME2
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"First line\n"
argument_list|,
literal|"1st line\n"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|renamedFileName
init|=
literal|"renamed_file.txt"
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommitRenamingFile
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME2
argument_list|,
name|renamedFileName
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|renamedFileName
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
literal|"Another line\n"
operator|::
name|concat
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|FILE_NAME
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|renamedUnrelatedFileIsIgnored_ForPatchSetDiffWithRebase_WhenModifiedDuringRebase ()
specifier|public
name|void
name|renamedUnrelatedFileIsIgnored_ForPatchSetDiffWithRebase_WhenModifiedDuringRebase
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|renamedFilePath
init|=
literal|"renamed_some_file.txt"
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"Line five\n"
argument_list|)
argument_list|)
decl_stmt|;
name|ObjectId
name|commit3
init|=
name|addCommitRenamingFile
argument_list|(
name|commit2
argument_list|,
name|FILE_NAME
argument_list|,
name|renamedFilePath
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit3
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fileRenamedDuringRebaseSameAsInPatchSetIsIgnored ()
specifier|public
name|void
name|fileRenamedDuringRebaseSameAsInPatchSetIsIgnored
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|renamedFileName
init|=
literal|"renamed_file.txt"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|FILE_NAME
argument_list|,
name|renamedFileName
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
comment|// Revert the renaming to be able to rebase.
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|renamedFileName
argument_list|,
name|FILE_NAME
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommitRenamingFile
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|renamedFileName
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fileWithRebaseHunksRenamedDuringRebaseSameAsInPatchSetIsIgnored ()
specifier|public
name|void
name|fileWithRebaseHunksRenamedDuringRebaseSameAsInPatchSetIsIgnored
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|renamedFileName
init|=
literal|"renamed_file.txt"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|FILE_NAME
argument_list|,
name|renamedFileName
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
comment|// Revert the renaming to be able to rebase.
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|renamedFileName
argument_list|,
name|FILE_NAME
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 10\n"
argument_list|,
literal|"Line ten\n"
argument_list|)
argument_list|)
decl_stmt|;
name|ObjectId
name|commit3
init|=
name|addCommitRenamingFile
argument_list|(
name|commit2
argument_list|,
name|FILE_NAME
argument_list|,
name|renamedFileName
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit3
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|filesNotTouchedByPatchSetsAndContainingOnlyRebaseHunksAreIgnored ()
specifier|public
name|void
name|filesNotTouchedByPatchSetsAndContainingOnlyRebaseHunksAreIgnored
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 10\n"
argument_list|,
literal|"Line ten\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|ObjectId
name|commit3
init|=
name|addCommitRenamingFile
argument_list|(
name|commit2
argument_list|,
name|FILE_NAME2
argument_list|,
literal|"a_new_file_name.txt"
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit3
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|filesTouchedByPatchSetsAndContainingOnlyRebaseHunksAreIgnored ()
specifier|public
name|void
name|filesTouchedByPatchSetsAndContainingOnlyRebaseHunksAreIgnored
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 50\n"
argument_list|,
literal|"Line fifty\n"
argument_list|)
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME2
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"1st line\n"
argument_list|,
literal|"First line\n"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
comment|// Revert the modification to allow rebasing.
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME2
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"First line\n"
argument_list|,
literal|"1st line\n"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 10\n"
argument_list|,
literal|"Line ten\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|String
name|newFilePath
init|=
literal|"a_new_file_name.txt"
decl_stmt|;
name|ObjectId
name|commit3
init|=
name|addCommitRenamingFile
argument_list|(
name|commit2
argument_list|,
name|FILE_NAME2
argument_list|,
name|newFilePath
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit3
argument_list|)
expr_stmt|;
comment|// Apply the modification again to bring the file into the same state as for the previous
comment|// patch set.
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|newFilePath
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"1st line\n"
argument_list|,
literal|"First line\n"
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|singleHunkAtBeginningIsFollowedByCorrectCommonLines ()
specifier|public
name|void
name|singleHunkAtBeginningIsFollowedByCorrectCommonLines
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3\nLine 4\nLine 5\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|filePath
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 1\n"
argument_list|,
literal|"Line one\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 2"
argument_list|,
literal|"Line 3"
argument_list|,
literal|"Line 4"
argument_list|,
literal|"Line 5"
argument_list|,
literal|""
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|singleHunkAtEndIsPrecededByCorrectCommonLines ()
specifier|public
name|void
name|singleHunkAtEndIsPrecededByCorrectCommonLines
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3\nLine 4\nLine 5\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|filePath
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"Line five\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|,
literal|"Line 2"
argument_list|,
literal|"Line 3"
argument_list|,
literal|"Line 4"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|singleHunkInTheMiddleIsSurroundedByCorrectCommonLines ()
specifier|public
name|void
name|singleHunkInTheMiddleIsSurroundedByCorrectCommonLines
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3\nLine 4\nLine 5\nLine 6\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|filePath
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 3\n"
argument_list|,
literal|"Line three\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|,
literal|"Line 2"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 4"
argument_list|,
literal|"Line 5"
argument_list|,
literal|"Line 6"
argument_list|,
literal|""
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|twoHunksAreSeparatedByCorrectCommonLines ()
specifier|public
name|void
name|twoHunksAreSeparatedByCorrectCommonLines
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|filePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|String
name|fileContent
init|=
literal|"Line 1\nLine 2\nLine 3\nLine 4\nLine 5\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|filePath
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 2\n"
argument_list|,
literal|"Line two\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"Line five\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|filePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 3"
argument_list|,
literal|"Line 4"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunksAtStartOfFileAreIdentified ()
specifier|public
name|void
name|rebaseHunksAtStartOfFileAreIdentified
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 1\n"
argument_list|,
literal|"Line one\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"Line five\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 50\n"
argument_list|,
literal|"Line fifty\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line one"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 5"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line five"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 50"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line fifty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunksAtEndOfFileAreIdentified ()
specifier|public
name|void
name|rebaseHunksAtEndOfFileAreIdentified
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 60\n"
argument_list|,
literal|"Line sixty\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line one hundred\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 50\n"
argument_list|,
literal|"Line fifty\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 50"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line fifty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 60"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line sixty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 100"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line one hundred"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunksInBetweenRegularHunksAreIdentified ()
specifier|public
name|void
name|rebaseHunksInBetweenRegularHunksAreIdentified
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 40\n"
argument_list|,
literal|"Line forty\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 45\n"
argument_list|,
literal|"Line forty five\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 1\n"
argument_list|,
literal|"Line one\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line one hundred\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line one"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 40"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line forty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 45"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line forty five"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|6
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 100"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|6
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line one hundred"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|6
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunkIsIdentifiedWhenMovedDownInPreviousPatchSet ()
specifier|public
name|void
name|rebaseHunkIsIdentifiedWhenMovedDownInPreviousPatchSet
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Move the code down by introducing additional lines (pure insert + enlarging replacement) in
comment|// the previous patch set.
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification1
init|=
name|fileContent
lambda|->
literal|"Line zero\n"
operator|+
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 10\n"
argument_list|,
literal|"Line ten\nLine ten and a half\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification1
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 40\n"
argument_list|,
literal|"Line forty\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification2
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line one hundred\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification2
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 40"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line forty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 100"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line one hundred"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunkIsIdentifiedWhenMovedDownInLatestPatchSet ()
specifier|public
name|void
name|rebaseHunkIsIdentifiedWhenMovedDownInLatestPatchSet
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 40\n"
argument_list|,
literal|"Line forty\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
comment|// Move the code down by introducing additional lines (pure insert + enlarging replacement) in
comment|// the latest patch set.
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
literal|"Line zero\n"
operator|+
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 10\n"
argument_list|,
literal|"Line ten\nLine ten and a half\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line zero"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 10"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line ten"
argument_list|,
literal|"Line ten and a half"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 40"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line forty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunkIsIdentifiedWhenMovedUpInPreviousPatchSet ()
specifier|public
name|void
name|rebaseHunkIsIdentifiedWhenMovedUpInPreviousPatchSet
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Move the code up by removing lines (pure deletion + shrinking replacement) in the previous
comment|// patch set.
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification1
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 1\n"
argument_list|,
literal|""
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 10\nLine 11\n"
argument_list|,
literal|"Line ten\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification1
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 40\n"
argument_list|,
literal|"Line forty\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification2
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 100\n"
argument_list|,
literal|"Line one hundred\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification2
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 40"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line forty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 100"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line one hundred"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunkIsIdentifiedWhenMovedUpInLatestPatchSet ()
specifier|public
name|void
name|rebaseHunkIsIdentifiedWhenMovedUpInLatestPatchSet
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 40\n"
argument_list|,
literal|"Line forty\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
comment|// Move the code up by removing lines (pure deletion + shrinking replacement) in the latest
comment|// patch set.
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 1\n"
argument_list|,
literal|""
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 10\nLine 11\n"
argument_list|,
literal|"Line ten\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 10"
argument_list|,
literal|"Line 11"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line ten"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 40"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line forty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|modifiedRebaseHunkWithSameRegionConsideredAsRegularHunk ()
specifier|public
name|void
name|modifiedRebaseHunkWithSameRegionConsideredAsRegularHunk
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 40\n"
argument_list|,
literal|"Line forty\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line forty\n"
argument_list|,
literal|"Line modified after rebase\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 40"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line modified after rebase"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunkOverlappingAtBeginningConsideredAsRegularHunk ()
specifier|public
name|void
name|rebaseHunkOverlappingAtBeginningConsideredAsRegularHunk
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 40\nLine 41\n"
argument_list|,
literal|"Line forty\nLine forty one\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 39\n"
argument_list|,
literal|"Line thirty nine\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line forty one\n"
argument_list|,
literal|"Line 41\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 39"
argument_list|,
literal|"Line 40"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line thirty nine"
argument_list|,
literal|"Line forty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunkOverlappingAtEndConsideredAsRegularHunk ()
specifier|public
name|void
name|rebaseHunkOverlappingAtEndConsideredAsRegularHunk
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 40\nLine 41\n"
argument_list|,
literal|"Line forty\nLine forty one\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line forty\n"
argument_list|,
literal|"Line 40\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 42\n"
argument_list|,
literal|"Line forty two\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 41"
argument_list|,
literal|"Line 42"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line forty one"
argument_list|,
literal|"Line forty two"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunkModifiedInsideConsideredAsRegularHunk ()
specifier|public
name|void
name|rebaseHunkModifiedInsideConsideredAsRegularHunk
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 39\nLine 40\nLine 41\n"
argument_list|,
literal|"Line thirty nine\nLine forty\nLine forty one\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line forty\n"
argument_list|,
literal|"A different line forty\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 39"
argument_list|,
literal|"Line 40"
argument_list|,
literal|"Line 41"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line thirty nine"
argument_list|,
literal|"A different line forty"
argument_list|,
literal|"Line forty one"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunkAfterLineNumberChangingOverlappingHunksIsIdentified ()
specifier|public
name|void
name|rebaseHunkAfterLineNumberChangingOverlappingHunksIsIdentified
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 40\nLine 41\n"
argument_list|,
literal|"Line forty\nLine forty one\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 60\n"
argument_list|,
literal|"Line sixty\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line forty\n"
argument_list|,
literal|"Line 40\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 42\n"
argument_list|,
literal|"Line forty two\nLine forty two and a half\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 41"
argument_list|,
literal|"Line 42"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line forty one"
argument_list|,
literal|"Line forty two"
argument_list|,
literal|"Line forty two and a half"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 60"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line sixty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunksOneLineApartFromRegularHunkAreIdentified ()
specifier|public
name|void
name|rebaseHunksOneLineApartFromRegularHunkAreIdentified
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 1\n"
argument_list|,
literal|"Line one\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"Line five\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 3\n"
argument_list|,
literal|"Line three\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line one"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 3"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line three"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 5"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line five"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunksDirectlyTouchingHunksOfPatchSetsNotModifiedBetweenThemAreIdentified ()
specifier|public
name|void
name|rebaseHunksDirectlyTouchingHunksOfPatchSetsNotModifiedBetweenThemAreIdentified
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Add to hunks in a patch set and remove them in a further patch set to allow rebasing.
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 1\n"
argument_list|,
literal|"Line one\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 3\n"
argument_list|,
literal|"Line three\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|reverseContentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line one\n"
argument_list|,
literal|"Line 1\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line three\n"
argument_list|,
literal|"Line 3\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|reverseContentModification
argument_list|)
expr_stmt|;
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 2\n"
argument_list|,
literal|"Line two\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
comment|// Add the hunks again and modify another line so that we get a diff for the file.
comment|// (Files with only edits due to rebase are filtered out.)
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
operator|.
name|andThen
argument_list|(
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 10\n"
argument_list|,
literal|"Line ten\n"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 2"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line two"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 10"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line ten"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|multipleRebaseEditsMixedWithRegularEditsCanBeIdentified ()
specifier|public
name|void
name|multipleRebaseEditsMixedWithRegularEditsCanBeIdentified
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 7\n"
argument_list|,
literal|"Line seven\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 24\n"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 2\n"
argument_list|,
literal|"Line two\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 18\nLine 19\n"
argument_list|,
literal|"Line eighteen\nLine nineteen\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 50\n"
argument_list|,
literal|"Line fifty\n"
argument_list|)
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line seven\n"
argument_list|,
literal|"Line 7\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 9\n"
argument_list|,
literal|"Line nine\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 60\n"
argument_list|,
literal|"Line sixty\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 2"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line two"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line seven"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 7"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 9"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line nine"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|6
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|7
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 18"
argument_list|,
literal|"Line 19"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|7
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line eighteen"
argument_list|,
literal|"Line nineteen"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|7
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|8
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|9
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 50"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|9
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line fifty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|9
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|10
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|11
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 60"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|11
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line sixty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|11
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|12
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deletedFileDuringRebaseConsideredAsRegularHunkWhenModifiedInDiff ()
specifier|public
name|void
name|deletedFileDuringRebaseConsideredAsRegularHunkWhenModifiedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Modify the file and revert the modifications to allow rebasing.
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 50\n"
argument_list|,
literal|"Line fifty\n"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line fifty\n"
argument_list|,
literal|"Line 50\n"
argument_list|)
argument_list|)
expr_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommitRemovingFiles
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|changeType
argument_list|()
operator|.
name|isEqualTo
argument_list|(
name|ChangeType
operator|.
name|DELETED
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|hasSize
argument_list|(
literal|101
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedFileDuringRebaseConsideredAsRegularHunkWhenModifiedInDiff ()
specifier|public
name|void
name|addedFileDuringRebaseConsideredAsRegularHunkWhenModifiedInDiff
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFilePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|newFilePath
argument_list|,
literal|"1st line\n2nd line\n3rd line\n"
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|newFilePath
argument_list|,
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"1st line\n"
argument_list|,
literal|"First line\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|newFilePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|changeType
argument_list|()
operator|.
name|isEqualTo
argument_list|(
name|ChangeType
operator|.
name|ADDED
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|hasSize
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|newFilePath
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|newFilePath
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunkInRenamedFileIsIdentified_WhenFileIsRenamedDuringRebase ()
specifier|public
name|void
name|rebaseHunkInRenamedFileIsIdentified_WhenFileIsRenamedDuringRebase
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|renamedFilePath
init|=
literal|"renamed_some_file.txt"
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 1\n"
argument_list|,
literal|"Line one\n"
argument_list|)
argument_list|)
decl_stmt|;
name|ObjectId
name|commit3
init|=
name|addCommitRenamingFile
argument_list|(
name|commit2
argument_list|,
name|FILE_NAME
argument_list|,
name|renamedFilePath
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit3
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 50\n"
argument_list|,
literal|"Line fifty\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|renamedFilePath
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|renamedFilePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line one"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 50"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line fifty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|renamedFilePath
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|renamedFilePath
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunkInRenamedFileIsIdentified_WhenFileIsRenamedInPatchSets ()
specifier|public
name|void
name|rebaseHunkInRenamedFileIsIdentified_WhenFileIsRenamedInPatchSets
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|renamedFilePath
init|=
literal|"renamed_some_file.txt"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|FILE_NAME
argument_list|,
name|renamedFilePath
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
comment|// Revert the renaming to be able to rebase.
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|renamedFilePath
argument_list|,
name|FILE_NAME
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"Line five\n"
argument_list|)
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|FILE_NAME
argument_list|,
name|renamedFilePath
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 50\n"
argument_list|,
literal|"Line fifty\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|renamedFilePath
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|renamedFilePath
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 5"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line five"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 50"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line fifty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|renamedFilePath
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|renamedFilePath
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|renamedFileWithOnlyRebaseHunksIsIdentified_WhenRenamedBetweenPatchSets ()
specifier|public
name|void
name|renamedFileWithOnlyRebaseHunksIsIdentified_WhenRenamedBetweenPatchSets
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFilePath1
init|=
literal|"renamed_some_file.txt"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|FILE_NAME
argument_list|,
name|newFilePath1
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
comment|// Revert the renaming to be able to rebase.
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|newFilePath1
argument_list|,
name|FILE_NAME
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"Line five\n"
argument_list|)
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|String
name|newFilePath2
init|=
literal|"renamed_some_file_to_something_else.txt"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|FILE_NAME
argument_list|,
name|newFilePath2
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|newFilePath2
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|newFilePath2
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|newFilePath2
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|newFilePath2
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 5"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line five"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|renamedFileWithOnlyRebaseHunksIsIdentified_WhenRenamedForRebaseAndForPatchSets ()
specifier|public
name|void
name|renamedFileWithOnlyRebaseHunksIsIdentified_WhenRenamedForRebaseAndForPatchSets
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFilePath1
init|=
literal|"renamed_some_file.txt"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|FILE_NAME
argument_list|,
name|newFilePath1
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
comment|// Revert the renaming to be able to rebase.
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|newFilePath1
argument_list|,
name|FILE_NAME
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"Line five\n"
argument_list|)
argument_list|)
decl_stmt|;
name|String
name|newFilePath2
init|=
literal|"renamed_some_file_during_rebase.txt"
decl_stmt|;
name|ObjectId
name|commit3
init|=
name|addCommitRenamingFile
argument_list|(
name|commit2
argument_list|,
name|FILE_NAME
argument_list|,
name|newFilePath2
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit3
argument_list|)
expr_stmt|;
name|String
name|newFilePath3
init|=
literal|"renamed_some_file_to_something_else.txt"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|newFilePath2
argument_list|,
name|newFilePath3
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|newFilePath3
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|newFilePath3
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|newFilePath3
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|newFilePath3
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 5"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line five"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|copiedAndRenamedFilesWithOnlyRebaseHunksAreIdentified ()
specifier|public
name|void
name|copiedAndRenamedFilesWithOnlyRebaseHunksAreIdentified
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"Line five\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
comment|// Copies are only identified by JGit when paired with renaming.
name|String
name|copyFileName
init|=
literal|"copy_of_some_file.txt"
decl_stmt|;
name|String
name|renamedFileName
init|=
literal|"renamed_some_file.txt"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|copyFileName
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|newFileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|FILE_NAME
argument_list|,
name|renamedFileName
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|initialPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|copyFileName
argument_list|,
name|renamedFileName
argument_list|)
expr_stmt|;
name|DiffInfo
name|renamedFileDiffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|renamedFileName
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|renamedFileDiffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|renamedFileDiffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 5"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|renamedFileDiffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line five"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|renamedFileDiffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|renamedFileDiffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|DiffInfo
name|copiedFileDiffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|copyFileName
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|copiedFileDiffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|copiedFileDiffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 5"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|copiedFileDiffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line five"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|copiedFileDiffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|copiedFileDiffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
block|}
comment|/*    *                change PS B    *                   |    * change PS A    commit4    *    |              |    * commit2        commit3    *    |             /    * commit1 --------    */
annotation|@
name|Test
DECL|method|rebaseHunksWhenRebasingOnAnotherChangeOrPatchSetAreIdentified ()
specifier|public
name|void
name|rebaseHunksWhenRebasingOnAnotherChangeOrPatchSetAreIdentified
parameter_list|()
throws|throws
name|Exception
block|{
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"Line five\n"
argument_list|)
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|commit3FileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 35\n"
argument_list|,
literal|"Line thirty five\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit3
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|commit3FileContent
argument_list|)
decl_stmt|;
name|ObjectId
name|commit4
init|=
name|addCommit
argument_list|(
name|commit3
argument_list|,
name|FILE_NAME
argument_list|,
name|commit3FileContent
operator|.
name|replace
argument_list|(
literal|"Line 60\n"
argument_list|,
literal|"Line sixty\n"
argument_list|)
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit4
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 20\n"
argument_list|,
literal|"Line twenty\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line five"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 5"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 20"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line twenty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 35"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line thirty five"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|6
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|7
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 60"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|7
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line sixty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|7
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|8
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/*    *                change PS B    *                   |    * change PS A    commit4    *    |              |    * commit2        commit3    *    |             /    * commit1 --------    */
annotation|@
name|Test
DECL|method|unrelatedFileWhenRebasingOnAnotherChangeOrPatchSetIsIgnored ()
specifier|public
name|void
name|unrelatedFileWhenRebasingOnAnotherChangeOrPatchSetIsIgnored
parameter_list|()
throws|throws
name|Exception
block|{
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"Line five\n"
argument_list|)
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|ObjectId
name|commit3
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME2
argument_list|,
name|FILE_CONTENT2
operator|.
name|replace
argument_list|(
literal|"2nd line\n"
argument_list|,
literal|"Second line\n"
argument_list|)
argument_list|)
decl_stmt|;
name|ObjectId
name|commit4
init|=
name|addCommit
argument_list|(
name|commit3
argument_list|,
name|FILE_NAME
argument_list|,
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 60\n"
argument_list|,
literal|"Line sixty\n"
argument_list|)
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit4
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 20\n"
argument_list|,
literal|"Line twenty\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|COMMIT_MSG
argument_list|,
name|FILE_NAME
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rebaseHunksWhenReversingPatchSetOrderAreIdentified ()
specifier|public
name|void
name|rebaseHunksWhenReversingPatchSetOrderAreIdentified
parameter_list|()
throws|throws
name|Exception
block|{
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"Line five\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 35\n"
argument_list|,
literal|""
argument_list|)
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 20\n"
argument_list|,
literal|"Line twenty\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|String
name|currentPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|initialPatchSetId
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|currentPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line five"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 5"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line twenty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 20"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 35"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|6
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|revision
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|files
argument_list|(
name|currentPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|intralineEditsInNonRebaseHunksAreIdentified ()
specifier|public
name|void
name|intralineEditsInNonRebaseHunksAreIdentified
parameter_list|()
throws|throws
name|Exception
block|{
name|assume
argument_list|()
operator|.
name|that
argument_list|(
name|intraline
argument_list|)
operator|.
name|isTrue
argument_list|()
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 1\n"
argument_list|,
literal|"Line one\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line one"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|intralineEditsOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
name|ImmutableList
operator|.
name|of
argument_list|(
literal|5
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|intralineEditsOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
name|ImmutableList
operator|.
name|of
argument_list|(
literal|5
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|intralineEditsInRebaseHunksAreIdentified ()
specifier|public
name|void
name|intralineEditsInRebaseHunksAreIdentified
parameter_list|()
throws|throws
name|Exception
block|{
name|assume
argument_list|()
operator|.
name|that
argument_list|(
name|intraline
argument_list|)
operator|.
name|isTrue
argument_list|()
expr_stmt|;
name|String
name|newFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 1\n"
argument_list|,
literal|"Line one\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
init|=
name|fileContent
lambda|->
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 50\n"
argument_list|,
literal|"Line fifty\n"
argument_list|)
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|contentModification
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 1"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line one"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|intralineEditsOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
name|ImmutableList
operator|.
name|of
argument_list|(
literal|5
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|intralineEditsOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
name|ImmutableList
operator|.
name|of
argument_list|(
literal|5
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 50"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line fifty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|closeNonRebaseHunksAreCombinedForIntralineOptimizations ()
specifier|public
name|void
name|closeNonRebaseHunksAreCombinedForIntralineOptimizations
parameter_list|()
throws|throws
name|Exception
block|{
name|assume
argument_list|()
operator|.
name|that
argument_list|(
name|intraline
argument_list|)
operator|.
name|isTrue
argument_list|()
expr_stmt|;
name|String
name|fileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"{\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 4\n"
argument_list|,
literal|"Line four\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 6\n"
argument_list|,
literal|"Line six\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 4"
argument_list|,
literal|"{"
argument_list|,
literal|"Line 6"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line four"
argument_list|,
literal|"{"
argument_list|,
literal|"Line six"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
comment|// Lines which weren't modified but are included in a hunk due to optimization don't count for
comment|// the number of inserted/deleted lines.
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|closeRebaseHunksAreNotCombinedForIntralineOptimizations ()
specifier|public
name|void
name|closeRebaseHunksAreNotCombinedForIntralineOptimizations
parameter_list|()
throws|throws
name|Exception
block|{
name|assume
argument_list|()
operator|.
name|that
argument_list|(
name|intraline
argument_list|)
operator|.
name|isTrue
argument_list|()
expr_stmt|;
name|String
name|fileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"{\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newFileContent
init|=
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 4\n"
argument_list|,
literal|"Line four\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 6\n"
argument_list|,
literal|"Line six\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit3
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit3
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 20\n"
argument_list|,
literal|"Line twenty\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 4"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line four"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 6"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line six"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 20"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line twenty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|6
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|closeRebaseAndNonRebaseHunksAreNotCombinedForIntralineOptimizations ()
specifier|public
name|void
name|closeRebaseAndNonRebaseHunksAreNotCombinedForIntralineOptimizations
parameter_list|()
throws|throws
name|Exception
block|{
name|assume
argument_list|()
operator|.
name|that
argument_list|(
name|intraline
argument_list|)
operator|.
name|isTrue
argument_list|()
expr_stmt|;
name|String
name|fileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"{\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 7\n"
argument_list|,
literal|"{\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newFileContent
init|=
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 4\n"
argument_list|,
literal|"Line four\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 8\n"
argument_list|,
literal|"Line eight\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit3
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit3
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 6\n"
argument_list|,
literal|"Line six\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 4"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line four"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 6"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line six"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 8"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line eight"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|5
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|6
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|closeNonRebaseHunksNextToRebaseHunksAreCombinedForIntralineOptimizations ()
specifier|public
name|void
name|closeNonRebaseHunksNextToRebaseHunksAreCombinedForIntralineOptimizations
parameter_list|()
throws|throws
name|Exception
block|{
name|assume
argument_list|()
operator|.
name|that
argument_list|(
name|intraline
argument_list|)
operator|.
name|isTrue
argument_list|()
expr_stmt|;
name|String
name|fileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 5\n"
argument_list|,
literal|"{\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 7\n"
argument_list|,
literal|"{\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|fileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newFileContent
init|=
name|fileContent
operator|.
name|replace
argument_list|(
literal|"Line 8\n"
argument_list|,
literal|"Line eight!\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit3
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit3
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 4\n"
argument_list|,
literal|"Line four\n"
argument_list|)
operator|.
name|replace
argument_list|(
literal|"Line 6\n"
argument_list|,
literal|"Line six\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 4"
argument_list|,
literal|"{"
argument_list|,
literal|"Line 6"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line four"
argument_list|,
literal|"{"
argument_list|,
literal|"Line six"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|isNotDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 8"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line eight!"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|3
argument_list|)
operator|.
name|isDueToRebase
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|4
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|changedFiles
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|files
argument_list|(
name|previousPatchSetId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesInserted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changedFiles
operator|.
name|get
argument_list|(
name|FILE_NAME
argument_list|)
argument_list|)
operator|.
name|linesDeleted
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|diffOfUnmodifiedFileWithWholeFileContextReturnsFileContents ()
specifier|public
name|void
name|diffOfUnmodifiedFileWithWholeFileContextReturnsFileContents
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 2\n"
argument_list|,
literal|"Line two\n"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME2
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"2nd line\n"
argument_list|,
literal|"Second line\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|withContext
argument_list|(
name|DiffPreferencesInfo
operator|.
name|WHOLE_FILE_CONTEXT
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
comment|// We don't list the full file contents here as that is not the focus of this test.
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|containsAtLeast
argument_list|(
literal|"Line 1"
argument_list|,
literal|"Line two"
argument_list|,
literal|"Line 3"
argument_list|,
literal|"Line 4"
argument_list|,
literal|"Line 5"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|diffOfUnmodifiedFileWithCommentAndWholeFileContextReturnsFileContents ()
specifier|public
name|void
name|diffOfUnmodifiedFileWithCommentAndWholeFileContextReturnsFileContents
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 2\n"
argument_list|,
literal|"Line two\n"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|CommentInput
name|comment
init|=
name|createCommentInput
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|"Should be 'Line 2'."
argument_list|)
decl_stmt|;
name|addCommentTo
argument_list|(
name|changeId
argument_list|,
name|previousPatchSetId
argument_list|,
name|FILE_NAME
argument_list|,
name|comment
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME2
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"2nd line\n"
argument_list|,
literal|"Second line\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|withContext
argument_list|(
name|DiffPreferencesInfo
operator|.
name|WHOLE_FILE_CONTEXT
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
comment|// We don't list the full file contents here as that is not the focus of this test.
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|containsAtLeast
argument_list|(
literal|"Line 1"
argument_list|,
literal|"Line two"
argument_list|,
literal|"Line 3"
argument_list|,
literal|"Line 4"
argument_list|,
literal|"Line 5"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
DECL|method|diffOfFileWithOnlyRebaseHunksAndWithCommentAndConsideringWhitespaceReturnsFileContents ()
name|diffOfFileWithOnlyRebaseHunksAndWithCommentAndConsideringWhitespaceReturnsFileContents
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 2\n"
argument_list|,
literal|"Line two\n"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newBaseFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 70\n"
argument_list|,
literal|"Line seventy\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newBaseFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|CommentInput
name|comment
init|=
name|createCommentInput
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|"Should be 'Line 2'."
argument_list|)
decl_stmt|;
name|addCommentTo
argument_list|(
name|changeId
argument_list|,
name|previousPatchSetId
argument_list|,
name|FILE_NAME
argument_list|,
name|comment
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_NONE
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
comment|// We don't list the full file contents here as that is not the focus of this test.
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|containsAtLeast
argument_list|(
literal|"Line 1"
argument_list|,
literal|"Line two"
argument_list|,
literal|"Line 3"
argument_list|,
literal|"Line 4"
argument_list|,
literal|"Line 5"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|diffOfFileWithOnlyRebaseHunksAndWithCommentAndIgnoringWhitespaceReturnsFileContents ()
specifier|public
name|void
name|diffOfFileWithOnlyRebaseHunksAndWithCommentAndIgnoringWhitespaceReturnsFileContents
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 2\n"
argument_list|,
literal|"Line two\n"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newBaseFileContent
init|=
name|FILE_CONTENT
operator|.
name|replace
argument_list|(
literal|"Line 70\n"
argument_list|,
literal|"Line seventy\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newBaseFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|CommentInput
name|comment
init|=
name|createCommentInput
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|"Should be 'Line 2'."
argument_list|)
decl_stmt|;
name|addCommentTo
argument_list|(
name|changeId
argument_list|,
name|previousPatchSetId
argument_list|,
name|FILE_NAME
argument_list|,
name|comment
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_ALL
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
comment|// We don't list the full file contents here as that is not the focus of this test.
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|containsAtLeast
argument_list|(
literal|"Line 1"
argument_list|,
literal|"Line two"
argument_list|,
literal|"Line 3"
argument_list|,
literal|"Line 4"
argument_list|,
literal|"Line 5"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
DECL|method|diffOfFileWithMultilineRebaseHunkAddingNewlineAtEndOfFileAndWithCommentReturnsFileContents ()
name|diffOfFileWithMultilineRebaseHunkAddingNewlineAtEndOfFileAndWithCommentReturnsFileContents
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|baseFileContent
init|=
name|FILE_CONTENT
operator|.
name|concat
argument_list|(
literal|"Line 101"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|baseFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 2\n"
argument_list|,
literal|"Line two\n"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newBaseFileContent
init|=
name|baseFileContent
operator|.
name|concat
argument_list|(
literal|"\nLine 102\nLine 103\n"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit3
init|=
name|addCommit
argument_list|(
name|commit2
argument_list|,
name|FILE_NAME
argument_list|,
name|newBaseFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit3
argument_list|)
expr_stmt|;
name|CommentInput
name|comment
init|=
name|createCommentInput
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|"Should be 'Line 2'."
argument_list|)
decl_stmt|;
name|addCommentTo
argument_list|(
name|changeId
argument_list|,
name|previousPatchSetId
argument_list|,
name|FILE_NAME
argument_list|,
name|comment
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_NONE
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
comment|// We don't list the full file contents here as that is not the focus of this test.
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|containsAtLeast
argument_list|(
literal|"Line 1"
argument_list|,
literal|"Line two"
argument_list|,
literal|"Line 3"
argument_list|,
literal|"Line 4"
argument_list|,
literal|"Line 5"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
DECL|method|diffOfFileWithMultilineRebaseHunkRemovingNewlineAtEndOfFileAndWithCommentReturnsFileContents ()
name|diffOfFileWithMultilineRebaseHunkRemovingNewlineAtEndOfFileAndWithCommentReturnsFileContents
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 2\n"
argument_list|,
literal|"Line two\n"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newBaseFileContent
init|=
name|FILE_CONTENT
operator|.
name|concat
argument_list|(
literal|"Line 101\nLine 103\nLine 104"
argument_list|)
decl_stmt|;
name|ObjectId
name|commit2
init|=
name|addCommit
argument_list|(
name|commit1
argument_list|,
name|FILE_NAME
argument_list|,
name|newBaseFileContent
argument_list|)
decl_stmt|;
name|rebaseChangeOn
argument_list|(
name|changeId
argument_list|,
name|commit2
argument_list|)
expr_stmt|;
name|CommentInput
name|comment
init|=
name|createCommentInput
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|"Should be 'Line 2'."
argument_list|)
decl_stmt|;
name|addCommentTo
argument_list|(
name|changeId
argument_list|,
name|previousPatchSetId
argument_list|,
name|FILE_NAME
argument_list|,
name|comment
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|withWhitespace
argument_list|(
name|DiffPreferencesInfo
operator|.
name|Whitespace
operator|.
name|IGNORE_NONE
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
comment|// We don't list the full file contents here as that is not the focus of this test.
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|containsAtLeast
argument_list|(
literal|"Line 1"
argument_list|,
literal|"Line two"
argument_list|,
literal|"Line 3"
argument_list|,
literal|"Line 4"
argument_list|,
literal|"Line 5"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|diffOfNonExistentFileIsAnEmptyDiffResult ()
specifier|public
name|void
name|diffOfNonExistentFileIsAnEmptyDiffResult
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 2\n"
argument_list|,
literal|"Line two\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
literal|"a_non-existent_file.txt"
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|withContext
argument_list|(
name|DiffPreferencesInfo
operator|.
name|WHOLE_FILE_CONTEXT
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|isEmpty
argument_list|()
expr_stmt|;
block|}
comment|// This behavior is likely a bug. A fix might not be easy as it might break syntax highlighting.
comment|// TODO: Fix this issue or remove the broken parameter (at least in the documentation).
annotation|@
name|Test
DECL|method|contextParameterIsIgnored ()
specifier|public
name|void
name|contextParameterIsIgnored
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 20\n"
argument_list|,
literal|"Line twenty\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|initialPatchSetId
argument_list|)
operator|.
name|withContext
argument_list|(
literal|5
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|hasSize
argument_list|(
literal|19
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfA
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line 20"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|1
argument_list|)
operator|.
name|linesOfB
argument_list|()
operator|.
name|containsExactly
argument_list|(
literal|"Line twenty"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|2
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|hasSize
argument_list|(
literal|81
argument_list|)
expr_stmt|;
block|}
comment|// This behavior is likely a bug. A fix might not be easy as it might break syntax highlighting.
comment|// TODO: Fix this issue or remove the broken parameter (at least in the documentation).
annotation|@
name|Test
DECL|method|contextParameterIsIgnoredForUnmodifiedFileWithComment ()
specifier|public
name|void
name|contextParameterIsIgnoredForUnmodifiedFileWithComment
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 20\n"
argument_list|,
literal|"Line twenty\n"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|CommentInput
name|comment
init|=
name|createCommentInput
argument_list|(
literal|20
argument_list|,
literal|0
argument_list|,
literal|21
argument_list|,
literal|0
argument_list|,
literal|"Should be 'Line 20'."
argument_list|)
decl_stmt|;
name|addCommentTo
argument_list|(
name|changeId
argument_list|,
name|previousPatchSetId
argument_list|,
name|FILE_NAME
argument_list|,
name|comment
argument_list|)
expr_stmt|;
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME2
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"2nd line\n"
argument_list|,
literal|"Second line\n"
argument_list|)
argument_list|)
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|withContext
argument_list|(
literal|5
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|hasSize
argument_list|(
literal|101
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|requestingDiffForOldFileNameOfRenamedFileYieldsReasonableResult ()
specifier|public
name|void
name|requestingDiffForOldFileNameOfRenamedFileYieldsReasonableResult
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 2\n"
argument_list|,
literal|"Line two\n"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|String
name|newFilePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|FILE_NAME
argument_list|,
name|newFilePath
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|withContext
argument_list|(
name|DiffPreferencesInfo
operator|.
name|WHOLE_FILE_CONTEXT
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
comment|// This behavior has been present in Gerrit for quite some time. It differs from the results
comment|// returned for other cases (e.g. requesting the diff with whole file context for an unmodified
comment|// file; requesting the diff with whole file context for a non-existent file). However, it's not
comment|// completely clear what should be returned. The closest would be the result of a file deletion
comment|// but that might also be misleading for users as actually a file rename occurred. In fact,
comment|// requesting the diff result for the old file name of a renamed file is not a reasonable use
comment|// case at all. We at least guarantee that we don't run into an internal error.
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|numberOfSkippedLines
argument_list|()
operator|.
name|isGreaterThan
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|requestingDiffForOldFileNameOfRenamedFileWithCommentOnOldFileYieldsReasonableResult ()
specifier|public
name|void
name|requestingDiffForOldFileNameOfRenamedFileWithCommentOnOldFileYieldsReasonableResult
parameter_list|()
throws|throws
name|Exception
block|{
name|addModifiedPatchSet
argument_list|(
name|changeId
argument_list|,
name|FILE_NAME
argument_list|,
name|content
lambda|->
name|content
operator|.
name|replace
argument_list|(
literal|"Line 2\n"
argument_list|,
literal|"Line two\n"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|previousPatchSetId
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|CommentInput
name|comment
init|=
name|createCommentInput
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|"Should be 'Line 2'."
argument_list|)
decl_stmt|;
name|addCommentTo
argument_list|(
name|changeId
argument_list|,
name|previousPatchSetId
argument_list|,
name|FILE_NAME
argument_list|,
name|comment
argument_list|)
expr_stmt|;
name|String
name|newFilePath
init|=
literal|"a_new_file.txt"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|FILE_NAME
argument_list|,
name|newFilePath
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|DiffInfo
name|diffInfo
init|=
name|getDiffRequest
argument_list|(
name|changeId
argument_list|,
name|CURRENT
argument_list|,
name|FILE_NAME
argument_list|)
operator|.
name|withBase
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|withContext
argument_list|(
name|DiffPreferencesInfo
operator|.
name|WHOLE_FILE_CONTEXT
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
comment|// See comment for requestingDiffForOldFileNameOfRenamedFileYieldsReasonableResult().
comment|// This test should additionally ensure that we also don't run into an internal error when
comment|// a comment is present.
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|commonLines
argument_list|()
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diffInfo
argument_list|)
operator|.
name|content
argument_list|()
operator|.
name|element
argument_list|(
literal|0
argument_list|)
operator|.
name|numberOfSkippedLines
argument_list|()
operator|.
name|isGreaterThan
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
DECL|method|createCommentInput ( int startLine, int startCharacter, int endLine, int endCharacter, String message)
specifier|private
specifier|static
name|CommentInput
name|createCommentInput
parameter_list|(
name|int
name|startLine
parameter_list|,
name|int
name|startCharacter
parameter_list|,
name|int
name|endLine
parameter_list|,
name|int
name|endCharacter
parameter_list|,
name|String
name|message
parameter_list|)
block|{
name|CommentInput
name|comment
init|=
operator|new
name|CommentInput
argument_list|()
decl_stmt|;
name|comment
operator|.
name|range
operator|=
operator|new
name|Comment
operator|.
name|Range
argument_list|()
expr_stmt|;
name|comment
operator|.
name|range
operator|.
name|startLine
operator|=
name|startLine
expr_stmt|;
name|comment
operator|.
name|range
operator|.
name|startCharacter
operator|=
name|startCharacter
expr_stmt|;
name|comment
operator|.
name|range
operator|.
name|endLine
operator|=
name|endLine
expr_stmt|;
name|comment
operator|.
name|range
operator|.
name|endCharacter
operator|=
name|endCharacter
expr_stmt|;
name|comment
operator|.
name|message
operator|=
name|message
expr_stmt|;
return|return
name|comment
return|;
block|}
DECL|method|addCommentTo ( String changeId, String previousPatchSetId, String fileName, CommentInput comment)
specifier|private
name|void
name|addCommentTo
parameter_list|(
name|String
name|changeId
parameter_list|,
name|String
name|previousPatchSetId
parameter_list|,
name|String
name|fileName
parameter_list|,
name|CommentInput
name|comment
parameter_list|)
throws|throws
name|RestApiException
block|{
name|ReviewInput
name|reviewInput
init|=
operator|new
name|ReviewInput
argument_list|()
decl_stmt|;
name|reviewInput
operator|.
name|comments
operator|=
name|ImmutableMap
operator|.
name|of
argument_list|(
name|fileName
argument_list|,
name|ImmutableList
operator|.
name|of
argument_list|(
name|comment
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|revision
argument_list|(
name|previousPatchSetId
argument_list|)
operator|.
name|review
argument_list|(
name|reviewInput
argument_list|)
expr_stmt|;
block|}
DECL|method|assertDiffForNewFile ( PushOneCommit.Result pushResult, String path, String expectedContentSideB)
specifier|private
name|void
name|assertDiffForNewFile
parameter_list|(
name|PushOneCommit
operator|.
name|Result
name|pushResult
parameter_list|,
name|String
name|path
parameter_list|,
name|String
name|expectedContentSideB
parameter_list|)
throws|throws
name|Exception
block|{
name|DiffInfo
name|diff
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|pushResult
operator|.
name|getChangeId
argument_list|()
argument_list|)
operator|.
name|revision
argument_list|(
name|pushResult
operator|.
name|getCommit
argument_list|()
operator|.
name|name
argument_list|()
argument_list|)
operator|.
name|file
argument_list|(
name|path
argument_list|)
operator|.
name|diff
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|headers
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
if|if
condition|(
name|path
operator|.
name|equals
argument_list|(
name|COMMIT_MSG
argument_list|)
condition|)
block|{
name|RevCommit
name|c
init|=
name|pushResult
operator|.
name|getCommit
argument_list|()
decl_stmt|;
name|RevCommit
name|parentCommit
init|=
name|c
operator|.
name|getParents
argument_list|()
index|[
literal|0
index|]
decl_stmt|;
name|String
name|parentCommitId
init|=
name|abbreviateName
argument_list|(
name|parentCommit
argument_list|,
literal|8
argument_list|,
name|testRepo
operator|.
name|getRevWalk
argument_list|()
operator|.
name|getObjectReader
argument_list|()
argument_list|)
decl_stmt|;
name|headers
operator|.
name|add
argument_list|(
literal|"Parent:     "
operator|+
name|parentCommitId
operator|+
literal|" ("
operator|+
name|parentCommit
operator|.
name|getShortMessage
argument_list|()
operator|+
literal|")"
argument_list|)
expr_stmt|;
name|SimpleDateFormat
name|dtfmt
init|=
operator|new
name|SimpleDateFormat
argument_list|(
literal|"yyyy-MM-dd HH:mm:ss Z"
argument_list|,
name|Locale
operator|.
name|US
argument_list|)
decl_stmt|;
name|PersonIdent
name|author
init|=
name|c
operator|.
name|getAuthorIdent
argument_list|()
decl_stmt|;
name|dtfmt
operator|.
name|setTimeZone
argument_list|(
name|author
operator|.
name|getTimeZone
argument_list|()
argument_list|)
expr_stmt|;
name|headers
operator|.
name|add
argument_list|(
literal|"Author:     "
operator|+
name|author
operator|.
name|getName
argument_list|()
operator|+
literal|"<"
operator|+
name|author
operator|.
name|getEmailAddress
argument_list|()
operator|+
literal|">"
argument_list|)
expr_stmt|;
name|headers
operator|.
name|add
argument_list|(
literal|"AuthorDate: "
operator|+
name|dtfmt
operator|.
name|format
argument_list|(
name|author
operator|.
name|getWhen
argument_list|()
operator|.
name|getTime
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|PersonIdent
name|committer
init|=
name|c
operator|.
name|getCommitterIdent
argument_list|()
decl_stmt|;
name|dtfmt
operator|.
name|setTimeZone
argument_list|(
name|committer
operator|.
name|getTimeZone
argument_list|()
argument_list|)
expr_stmt|;
name|headers
operator|.
name|add
argument_list|(
literal|"Commit:     "
operator|+
name|committer
operator|.
name|getName
argument_list|()
operator|+
literal|"<"
operator|+
name|committer
operator|.
name|getEmailAddress
argument_list|()
operator|+
literal|">"
argument_list|)
expr_stmt|;
name|headers
operator|.
name|add
argument_list|(
literal|"CommitDate: "
operator|+
name|dtfmt
operator|.
name|format
argument_list|(
name|committer
operator|.
name|getWhen
argument_list|()
operator|.
name|getTime
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|headers
operator|.
name|add
argument_list|(
literal|""
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|headers
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|String
name|header
init|=
name|Joiner
operator|.
name|on
argument_list|(
literal|"\n"
argument_list|)
operator|.
name|join
argument_list|(
name|headers
argument_list|)
decl_stmt|;
name|expectedContentSideB
operator|=
name|header
operator|+
literal|"\n"
operator|+
name|expectedContentSideB
expr_stmt|;
block|}
name|assertDiffForNewFile
argument_list|(
name|diff
argument_list|,
name|pushResult
operator|.
name|getCommit
argument_list|()
argument_list|,
name|path
argument_list|,
name|expectedContentSideB
argument_list|)
expr_stmt|;
block|}
DECL|method|rebaseChangeOn (String changeId, ObjectId newParent)
specifier|private
name|void
name|rebaseChangeOn
parameter_list|(
name|String
name|changeId
parameter_list|,
name|ObjectId
name|newParent
parameter_list|)
throws|throws
name|Exception
block|{
name|RebaseInput
name|rebaseInput
init|=
operator|new
name|RebaseInput
argument_list|()
decl_stmt|;
name|rebaseInput
operator|.
name|base
operator|=
name|newParent
operator|.
name|getName
argument_list|()
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|rebase
argument_list|(
name|rebaseInput
argument_list|)
expr_stmt|;
block|}
DECL|method|addCommit (ObjectId parentCommit, String filePath, String fileContent)
specifier|private
name|ObjectId
name|addCommit
parameter_list|(
name|ObjectId
name|parentCommit
parameter_list|,
name|String
name|filePath
parameter_list|,
name|String
name|fileContent
parameter_list|)
throws|throws
name|Exception
block|{
name|ImmutableMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|files
init|=
name|ImmutableMap
operator|.
name|of
argument_list|(
name|filePath
argument_list|,
name|fileContent
argument_list|)
decl_stmt|;
return|return
name|addCommit
argument_list|(
name|parentCommit
argument_list|,
name|files
argument_list|)
return|;
block|}
DECL|method|addCommit (ObjectId parentCommit, ImmutableMap<String, String> files)
specifier|private
name|ObjectId
name|addCommit
parameter_list|(
name|ObjectId
name|parentCommit
parameter_list|,
name|ImmutableMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|files
parameter_list|)
throws|throws
name|Exception
block|{
name|testRepo
operator|.
name|reset
argument_list|(
name|parentCommit
argument_list|)
expr_stmt|;
name|PushOneCommit
name|push
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|admin
operator|.
name|newIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|,
literal|"Adjust files of repo"
argument_list|,
name|files
argument_list|)
decl_stmt|;
name|PushOneCommit
operator|.
name|Result
name|result
init|=
name|push
operator|.
name|to
argument_list|(
literal|"refs/for/master"
argument_list|)
decl_stmt|;
return|return
name|result
operator|.
name|getCommit
argument_list|()
return|;
block|}
DECL|method|addCommit (ObjectId parentCommit, String filePath, byte[] fileContent)
specifier|private
name|ObjectId
name|addCommit
parameter_list|(
name|ObjectId
name|parentCommit
parameter_list|,
name|String
name|filePath
parameter_list|,
name|byte
index|[]
name|fileContent
parameter_list|)
throws|throws
name|Exception
block|{
name|testRepo
operator|.
name|reset
argument_list|(
name|parentCommit
argument_list|)
expr_stmt|;
name|PushOneCommit
operator|.
name|Result
name|result
init|=
name|createEmptyChange
argument_list|()
decl_stmt|;
name|String
name|changeId
init|=
name|result
operator|.
name|getChangeId
argument_list|()
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|fileContent
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|currentRevision
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|GitUtil
operator|.
name|fetch
argument_list|(
name|testRepo
argument_list|,
literal|"refs/*:refs/*"
argument_list|)
expr_stmt|;
return|return
name|ObjectId
operator|.
name|fromString
argument_list|(
name|currentRevision
argument_list|)
return|;
block|}
DECL|method|addCommitRemovingFiles (ObjectId parentCommit, String... removedFilePaths)
specifier|private
name|ObjectId
name|addCommitRemovingFiles
parameter_list|(
name|ObjectId
name|parentCommit
parameter_list|,
name|String
modifier|...
name|removedFilePaths
parameter_list|)
throws|throws
name|Exception
block|{
name|testRepo
operator|.
name|reset
argument_list|(
name|parentCommit
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|files
init|=
name|Arrays
operator|.
name|stream
argument_list|(
name|removedFilePaths
argument_list|)
operator|.
name|collect
argument_list|(
name|toMap
argument_list|(
name|Function
operator|.
name|identity
argument_list|()
argument_list|,
name|path
lambda|->
literal|"Irrelevant content"
argument_list|)
argument_list|)
decl_stmt|;
name|PushOneCommit
name|push
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|admin
operator|.
name|newIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|,
literal|"Remove files from repo"
argument_list|,
name|files
argument_list|)
decl_stmt|;
name|PushOneCommit
operator|.
name|Result
name|result
init|=
name|push
operator|.
name|rm
argument_list|(
literal|"refs/for/master"
argument_list|)
decl_stmt|;
return|return
name|result
operator|.
name|getCommit
argument_list|()
return|;
block|}
DECL|method|addCommitRenamingFile ( ObjectId parentCommit, String oldFilePath, String newFilePath)
specifier|private
name|ObjectId
name|addCommitRenamingFile
parameter_list|(
name|ObjectId
name|parentCommit
parameter_list|,
name|String
name|oldFilePath
parameter_list|,
name|String
name|newFilePath
parameter_list|)
throws|throws
name|Exception
block|{
name|testRepo
operator|.
name|reset
argument_list|(
name|parentCommit
argument_list|)
expr_stmt|;
name|PushOneCommit
operator|.
name|Result
name|result
init|=
name|createEmptyChange
argument_list|()
decl_stmt|;
name|String
name|changeId
init|=
name|result
operator|.
name|getChangeId
argument_list|()
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|renameFile
argument_list|(
name|oldFilePath
argument_list|,
name|newFilePath
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
name|String
name|currentRevision
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|GitUtil
operator|.
name|fetch
argument_list|(
name|testRepo
argument_list|,
literal|"refs/*:refs/*"
argument_list|)
expr_stmt|;
return|return
name|ObjectId
operator|.
name|fromString
argument_list|(
name|currentRevision
argument_list|)
return|;
block|}
DECL|method|createEmptyChange ()
specifier|private
name|Result
name|createEmptyChange
parameter_list|()
throws|throws
name|Exception
block|{
name|PushOneCommit
name|push
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|admin
operator|.
name|newIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|,
literal|"Test change"
argument_list|,
name|ImmutableMap
operator|.
name|of
argument_list|()
argument_list|)
decl_stmt|;
return|return
name|push
operator|.
name|to
argument_list|(
literal|"refs/for/master"
argument_list|)
return|;
block|}
DECL|method|addModifiedPatchSet ( String changeId, String filePath, Function<String, String> contentModification)
specifier|private
name|void
name|addModifiedPatchSet
parameter_list|(
name|String
name|changeId
parameter_list|,
name|String
name|filePath
parameter_list|,
name|Function
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|contentModification
parameter_list|)
throws|throws
name|Exception
block|{
try|try
init|(
name|BinaryResult
name|content
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|file
argument_list|(
name|filePath
argument_list|)
operator|.
name|content
argument_list|()
init|)
block|{
name|String
name|newContent
init|=
name|contentModification
operator|.
name|apply
argument_list|(
name|content
operator|.
name|asString
argument_list|()
argument_list|)
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyFile
argument_list|(
name|filePath
argument_list|,
name|RawInputUtil
operator|.
name|create
argument_list|(
name|newContent
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|publish
argument_list|()
expr_stmt|;
block|}
DECL|method|createRgbImage (int red, int green, int blue)
specifier|private
specifier|static
name|byte
index|[]
name|createRgbImage
parameter_list|(
name|int
name|red
parameter_list|,
name|int
name|green
parameter_list|,
name|int
name|blue
parameter_list|)
throws|throws
name|IOException
block|{
name|BufferedImage
name|bufferedImage
init|=
operator|new
name|BufferedImage
argument_list|(
literal|10
argument_list|,
literal|20
argument_list|,
name|BufferedImage
operator|.
name|TYPE_INT_RGB
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|x
init|=
literal|0
init|;
name|x
operator|<
name|bufferedImage
operator|.
name|getWidth
argument_list|()
condition|;
name|x
operator|++
control|)
block|{
for|for
control|(
name|int
name|y
init|=
literal|0
init|;
name|y
operator|<
name|bufferedImage
operator|.
name|getHeight
argument_list|()
condition|;
name|y
operator|++
control|)
block|{
name|int
name|rgb
init|=
operator|(
name|red
operator|<<
literal|16
operator|)
operator|+
operator|(
name|green
operator|<<
literal|8
operator|)
operator|+
name|blue
decl_stmt|;
name|bufferedImage
operator|.
name|setRGB
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|rgb
argument_list|)
expr_stmt|;
block|}
block|}
name|ByteArrayOutputStream
name|byteArrayOutputStream
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|ImageIO
operator|.
name|write
argument_list|(
name|bufferedImage
argument_list|,
literal|"png"
argument_list|,
name|byteArrayOutputStream
argument_list|)
expr_stmt|;
return|return
name|byteArrayOutputStream
operator|.
name|toByteArray
argument_list|()
return|;
block|}
DECL|method|getDiffRequest (String changeId, String revisionId, String fileName)
specifier|private
name|FileApi
operator|.
name|DiffRequest
name|getDiffRequest
parameter_list|(
name|String
name|changeId
parameter_list|,
name|String
name|revisionId
parameter_list|,
name|String
name|fileName
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|revision
argument_list|(
name|revisionId
argument_list|)
operator|.
name|file
argument_list|(
name|fileName
argument_list|)
operator|.
name|diffRequest
argument_list|()
operator|.
name|withIntraline
argument_list|(
name|intraline
argument_list|)
return|;
block|}
block|}
end_class

end_unit

