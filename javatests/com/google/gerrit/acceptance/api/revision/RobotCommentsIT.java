begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|// Copyright (C) 2016 The Android Open Source Project
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Licensed under the Apache License, Version 2.0 (the "License");
end_comment

begin_comment
comment|// you may not use this file except in compliance with the License.
end_comment

begin_comment
comment|// You may obtain a copy of the License at
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// http://www.apache.org/licenses/LICENSE-2.0
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Unless required by applicable law or agreed to in writing, software
end_comment

begin_comment
comment|// distributed under the License is distributed on an "AS IS" BASIS,
end_comment

begin_comment
comment|// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
end_comment

begin_comment
comment|// See the License for the specific language governing permissions and
end_comment

begin_comment
comment|// limitations under the License.
end_comment

begin_package
DECL|package|com.google.gerrit.acceptance.api.revision
package|package
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|api
operator|.
name|revision
package|;
end_package

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|truth
operator|.
name|Truth
operator|.
name|assertThat
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|PushOneCommit
operator|.
name|SUBJECT
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|testing
operator|.
name|EditInfoSubject
operator|.
name|assertThat
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|testing
operator|.
name|RobotCommentInfoSubject
operator|.
name|assertThatList
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|testing
operator|.
name|GerritJUnit
operator|.
name|assertThrows
import|;
end_import

begin_import
import|import static
name|java
operator|.
name|util
operator|.
name|stream
operator|.
name|Collectors
operator|.
name|toList
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ImmutableList
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ImmutableMap
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Iterables
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|AbstractDaemonTest
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|PushOneCommit
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|config
operator|.
name|GerritConfig
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|changes
operator|.
name|ReviewInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|changes
operator|.
name|ReviewInput
operator|.
name|RobotCommentInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|Comment
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|ChangeInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|EditInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|FixReplacementInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|FixSuggestionInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|RobotCommentInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|BadRequestException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|BinaryResult
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|ResourceConflictException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|ResourceNotFoundException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|RestApiException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|testing
operator|.
name|BinaryResultSubject
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Objects
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Optional
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Before
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_class
DECL|class|RobotCommentsIT
specifier|public
class|class
name|RobotCommentsIT
extends|extends
name|AbstractDaemonTest
block|{
DECL|field|FILE_NAME
specifier|private
specifier|static
specifier|final
name|String
name|FILE_NAME
init|=
literal|"file_to_fix.txt"
decl_stmt|;
DECL|field|FILE_NAME2
specifier|private
specifier|static
specifier|final
name|String
name|FILE_NAME2
init|=
literal|"another_file_to_fix.txt"
decl_stmt|;
DECL|field|FILE_CONTENT
specifier|private
specifier|static
specifier|final
name|String
name|FILE_CONTENT
init|=
literal|"First line\nSecond line\nThird line\nFourth line\nFifth line\nSixth line"
operator|+
literal|"\nSeventh line\nEighth line\nNinth line\nTenth line\n"
decl_stmt|;
DECL|field|FILE_CONTENT2
specifier|private
specifier|static
specifier|final
name|String
name|FILE_CONTENT2
init|=
literal|"1st line\n2nd line\n3rd line\n"
decl_stmt|;
DECL|field|changeId
specifier|private
name|String
name|changeId
decl_stmt|;
DECL|field|fixReplacementInfo
specifier|private
name|FixReplacementInfo
name|fixReplacementInfo
decl_stmt|;
DECL|field|fixSuggestionInfo
specifier|private
name|FixSuggestionInfo
name|fixSuggestionInfo
decl_stmt|;
DECL|field|withFixRobotCommentInput
specifier|private
name|RobotCommentInput
name|withFixRobotCommentInput
decl_stmt|;
annotation|@
name|Before
DECL|method|setUp ()
specifier|public
name|void
name|setUp
parameter_list|()
throws|throws
name|Exception
block|{
name|PushOneCommit
name|push
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|admin
operator|.
name|newIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|,
literal|"Provide files which can be used for fixes"
argument_list|,
name|ImmutableMap
operator|.
name|of
argument_list|(
name|FILE_NAME
argument_list|,
name|FILE_CONTENT
argument_list|,
name|FILE_NAME2
argument_list|,
name|FILE_CONTENT2
argument_list|)
argument_list|)
decl_stmt|;
name|PushOneCommit
operator|.
name|Result
name|changeResult
init|=
name|push
operator|.
name|to
argument_list|(
literal|"refs/for/master"
argument_list|)
decl_stmt|;
name|changeId
operator|=
name|changeResult
operator|.
name|getChangeId
argument_list|()
expr_stmt|;
name|fixReplacementInfo
operator|=
name|createFixReplacementInfo
argument_list|()
expr_stmt|;
name|fixSuggestionInfo
operator|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo
argument_list|)
expr_stmt|;
name|withFixRobotCommentInput
operator|=
name|createRobotCommentInput
argument_list|(
name|fixSuggestionInfo
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|retrievingRobotCommentsBeforeAddingAnyDoesNotRaiseAnException ()
specifier|public
name|void
name|retrievingRobotCommentsBeforeAddingAnyDoesNotRaiseAnException
parameter_list|()
throws|throws
name|Exception
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
argument_list|>
name|robotComments
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|robotComments
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|robotComments
argument_list|)
operator|.
name|isNotNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|robotComments
argument_list|)
operator|.
name|isEmpty
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedRobotCommentsCanBeRetrieved ()
specifier|public
name|void
name|addedRobotCommentsCanBeRetrieved
parameter_list|()
throws|throws
name|Exception
block|{
name|RobotCommentInput
name|in
init|=
name|createRobotCommentInput
argument_list|()
decl_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
argument_list|>
name|out
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|robotComments
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|out
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|RobotCommentInfo
name|comment
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|out
operator|.
name|get
argument_list|(
name|in
operator|.
name|path
argument_list|)
argument_list|)
decl_stmt|;
name|assertRobotComment
argument_list|(
name|comment
argument_list|,
name|in
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedRobotCommentsCanBeRetrievedByChange ()
specifier|public
name|void
name|addedRobotCommentsCanBeRetrievedByChange
parameter_list|()
throws|throws
name|Exception
block|{
name|RobotCommentInput
name|in
init|=
name|createRobotCommentInput
argument_list|()
decl_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|pushFactory
operator|.
name|create
argument_list|(
name|admin
operator|.
name|newIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|,
name|changeId
argument_list|)
operator|.
name|to
argument_list|(
literal|"refs/for/master"
argument_list|)
expr_stmt|;
name|RobotCommentInput
name|in2
init|=
name|createRobotCommentInput
argument_list|()
decl_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|in2
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
argument_list|>
name|out
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|robotComments
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|out
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|out
operator|.
name|get
argument_list|(
name|in
operator|.
name|path
argument_list|)
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|RobotCommentInfo
name|comment1
init|=
name|out
operator|.
name|get
argument_list|(
name|in
operator|.
name|path
argument_list|)
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertRobotComment
argument_list|(
name|comment1
argument_list|,
name|in
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|RobotCommentInfo
name|comment2
init|=
name|out
operator|.
name|get
argument_list|(
name|in
operator|.
name|path
argument_list|)
operator|.
name|get
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|assertRobotComment
argument_list|(
name|comment2
argument_list|,
name|in2
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|robotCommentsCanBeRetrievedAsList ()
specifier|public
name|void
name|robotCommentsCanBeRetrievedAsList
parameter_list|()
throws|throws
name|Exception
block|{
name|RobotCommentInput
name|robotCommentInput
init|=
name|createRobotCommentInput
argument_list|()
decl_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|robotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|robotCommentsAsList
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|RobotCommentInfo
name|robotCommentInfo
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|assertRobotComment
argument_list|(
name|robotCommentInfo
argument_list|,
name|robotCommentInput
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|specificRobotCommentCanBeRetrieved ()
specifier|public
name|void
name|specificRobotCommentCanBeRetrieved
parameter_list|()
throws|throws
name|Exception
block|{
name|RobotCommentInput
name|robotCommentInput
init|=
name|createRobotCommentInput
argument_list|()
decl_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|robotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|RobotCommentInfo
name|robotCommentInfo
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|RobotCommentInfo
name|specificRobotCommentInfo
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|robotComment
argument_list|(
name|robotCommentInfo
operator|.
name|id
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertRobotComment
argument_list|(
name|specificRobotCommentInfo
argument_list|,
name|robotCommentInput
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|robotCommentWithoutOptionalFieldsCanBeAdded ()
specifier|public
name|void
name|robotCommentWithoutOptionalFieldsCanBeAdded
parameter_list|()
throws|throws
name|Exception
block|{
name|RobotCommentInput
name|in
init|=
name|createRobotCommentInputWithMandatoryFields
argument_list|()
decl_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
argument_list|>
name|out
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|robotComments
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|out
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|RobotCommentInfo
name|comment
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|out
operator|.
name|get
argument_list|(
name|in
operator|.
name|path
argument_list|)
argument_list|)
decl_stmt|;
name|assertRobotComment
argument_list|(
name|comment
argument_list|,
name|in
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|hugeRobotCommentIsRejected ()
specifier|public
name|void
name|hugeRobotCommentIsRejected
parameter_list|()
throws|throws
name|Exception
block|{
name|int
name|defaultSizeLimit
init|=
literal|1024
operator|*
literal|1024
decl_stmt|;
name|int
name|sizeOfRest
init|=
literal|451
decl_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
name|getStringFor
argument_list|(
name|defaultSizeLimit
operator|-
name|sizeOfRest
operator|+
literal|1
argument_list|)
expr_stmt|;
name|BadRequestException
name|thrown
init|=
name|assertThrows
argument_list|(
name|BadRequestException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|thrown
argument_list|)
operator|.
name|hasMessageThat
argument_list|()
operator|.
name|contains
argument_list|(
literal|"limit"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|reasonablyLargeRobotCommentIsAccepted ()
specifier|public
name|void
name|reasonablyLargeRobotCommentIsAccepted
parameter_list|()
throws|throws
name|Exception
block|{
name|int
name|defaultSizeLimit
init|=
literal|1024
operator|*
literal|1024
decl_stmt|;
name|int
name|sizeOfRest
init|=
literal|451
decl_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
name|getStringFor
argument_list|(
name|defaultSizeLimit
operator|-
name|sizeOfRest
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
annotation|@
name|GerritConfig
argument_list|(
name|name
operator|=
literal|"change.robotCommentSizeLimit"
argument_list|,
name|value
operator|=
literal|"10k"
argument_list|)
DECL|method|maximumAllowedSizeOfRobotCommentCanBeAdjusted ()
specifier|public
name|void
name|maximumAllowedSizeOfRobotCommentCanBeAdjusted
parameter_list|()
throws|throws
name|Exception
block|{
name|int
name|sizeLimit
init|=
literal|10
operator|*
literal|1024
decl_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
name|getStringFor
argument_list|(
name|sizeLimit
argument_list|)
expr_stmt|;
name|BadRequestException
name|thrown
init|=
name|assertThrows
argument_list|(
name|BadRequestException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|thrown
argument_list|)
operator|.
name|hasMessageThat
argument_list|()
operator|.
name|contains
argument_list|(
literal|"limit"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
annotation|@
name|GerritConfig
argument_list|(
name|name
operator|=
literal|"change.robotCommentSizeLimit"
argument_list|,
name|value
operator|=
literal|"0"
argument_list|)
DECL|method|zeroForMaximumAllowedSizeOfRobotCommentRemovesRestriction ()
specifier|public
name|void
name|zeroForMaximumAllowedSizeOfRobotCommentRemovesRestriction
parameter_list|()
throws|throws
name|Exception
block|{
name|int
name|defaultSizeLimit
init|=
literal|1024
operator|*
literal|1024
decl_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
name|getStringFor
argument_list|(
name|defaultSizeLimit
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
annotation|@
name|GerritConfig
argument_list|(
name|name
operator|=
literal|"change.robotCommentSizeLimit"
argument_list|,
name|value
operator|=
literal|"-1"
argument_list|)
DECL|method|negativeValueForMaximumAllowedSizeOfRobotCommentRemovesRestriction ()
specifier|public
name|void
name|negativeValueForMaximumAllowedSizeOfRobotCommentRemovesRestriction
parameter_list|()
throws|throws
name|Exception
block|{
name|int
name|defaultSizeLimit
init|=
literal|1024
operator|*
literal|1024
decl_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
name|getStringFor
argument_list|(
name|defaultSizeLimit
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedFixSuggestionCanBeRetrieved ()
specifier|public
name|void
name|addedFixSuggestionCanBeRetrieved
parameter_list|()
throws|throws
name|Exception
block|{
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|assertThatList
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|onlyElement
argument_list|()
operator|.
name|onlyFixSuggestion
argument_list|()
operator|.
name|isNotNull
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fixIdIsGeneratedForFixSuggestion ()
specifier|public
name|void
name|fixIdIsGeneratedForFixSuggestion
parameter_list|()
throws|throws
name|Exception
block|{
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|assertThatList
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|onlyElement
argument_list|()
operator|.
name|onlyFixSuggestion
argument_list|()
operator|.
name|fixId
argument_list|()
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
name|assertThatList
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|onlyElement
argument_list|()
operator|.
name|onlyFixSuggestion
argument_list|()
operator|.
name|fixId
argument_list|()
operator|.
name|isNotEqualTo
argument_list|(
name|fixSuggestionInfo
operator|.
name|fixId
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|descriptionOfFixSuggestionIsAcceptedAsIs ()
specifier|public
name|void
name|descriptionOfFixSuggestionIsAcceptedAsIs
parameter_list|()
throws|throws
name|Exception
block|{
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|assertThatList
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|onlyElement
argument_list|()
operator|.
name|onlyFixSuggestion
argument_list|()
operator|.
name|description
argument_list|()
operator|.
name|isEqualTo
argument_list|(
name|fixSuggestionInfo
operator|.
name|description
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|descriptionOfFixSuggestionIsMandatory ()
specifier|public
name|void
name|descriptionOfFixSuggestionIsMandatory
parameter_list|()
throws|throws
name|Exception
block|{
name|fixSuggestionInfo
operator|.
name|description
operator|=
literal|null
expr_stmt|;
name|BadRequestException
name|thrown
init|=
name|assertThrows
argument_list|(
name|BadRequestException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|thrown
argument_list|)
operator|.
name|hasMessageThat
argument_list|()
operator|.
name|contains
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"A description is required for the suggested fix of the robot comment on %s"
argument_list|,
name|withFixRobotCommentInput
operator|.
name|path
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|addedFixReplacementCanBeRetrieved ()
specifier|public
name|void
name|addedFixReplacementCanBeRetrieved
parameter_list|()
throws|throws
name|Exception
block|{
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|assertThatList
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|onlyElement
argument_list|()
operator|.
name|onlyFixSuggestion
argument_list|()
operator|.
name|onlyReplacement
argument_list|()
operator|.
name|isNotNull
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fixReplacementsAreMandatory ()
specifier|public
name|void
name|fixReplacementsAreMandatory
parameter_list|()
throws|throws
name|Exception
block|{
name|fixSuggestionInfo
operator|.
name|replacements
operator|=
name|Collections
operator|.
name|emptyList
argument_list|()
expr_stmt|;
name|BadRequestException
name|thrown
init|=
name|assertThrows
argument_list|(
name|BadRequestException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|thrown
argument_list|)
operator|.
name|hasMessageThat
argument_list|()
operator|.
name|contains
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"At least one replacement is required"
operator|+
literal|" for the suggested fix of the robot comment on %s"
argument_list|,
name|withFixRobotCommentInput
operator|.
name|path
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|pathOfFixReplacementIsAcceptedAsIs ()
specifier|public
name|void
name|pathOfFixReplacementIsAcceptedAsIs
parameter_list|()
throws|throws
name|Exception
block|{
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|assertThatList
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|onlyElement
argument_list|()
operator|.
name|onlyFixSuggestion
argument_list|()
operator|.
name|onlyReplacement
argument_list|()
operator|.
name|path
argument_list|()
operator|.
name|isEqualTo
argument_list|(
name|fixReplacementInfo
operator|.
name|path
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|pathOfFixReplacementIsMandatory ()
specifier|public
name|void
name|pathOfFixReplacementIsMandatory
parameter_list|()
throws|throws
name|Exception
block|{
name|fixReplacementInfo
operator|.
name|path
operator|=
literal|null
expr_stmt|;
name|BadRequestException
name|thrown
init|=
name|assertThrows
argument_list|(
name|BadRequestException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|thrown
argument_list|)
operator|.
name|hasMessageThat
argument_list|()
operator|.
name|contains
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"A file path must be given for the replacement of the robot comment on %s"
argument_list|,
name|withFixRobotCommentInput
operator|.
name|path
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rangeOfFixReplacementIsAcceptedAsIs ()
specifier|public
name|void
name|rangeOfFixReplacementIsAcceptedAsIs
parameter_list|()
throws|throws
name|Exception
block|{
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|assertThatList
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|onlyElement
argument_list|()
operator|.
name|onlyFixSuggestion
argument_list|()
operator|.
name|onlyReplacement
argument_list|()
operator|.
name|range
argument_list|()
operator|.
name|isEqualTo
argument_list|(
name|fixReplacementInfo
operator|.
name|range
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rangeOfFixReplacementIsMandatory ()
specifier|public
name|void
name|rangeOfFixReplacementIsMandatory
parameter_list|()
throws|throws
name|Exception
block|{
name|fixReplacementInfo
operator|.
name|range
operator|=
literal|null
expr_stmt|;
name|BadRequestException
name|thrown
init|=
name|assertThrows
argument_list|(
name|BadRequestException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|thrown
argument_list|)
operator|.
name|hasMessageThat
argument_list|()
operator|.
name|contains
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"A range must be given for the replacement of the robot comment on %s"
argument_list|,
name|withFixRobotCommentInput
operator|.
name|path
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rangeOfFixReplacementNeedsToBeValid ()
specifier|public
name|void
name|rangeOfFixReplacementNeedsToBeValid
parameter_list|()
throws|throws
name|Exception
block|{
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|13
argument_list|,
literal|9
argument_list|,
literal|5
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|BadRequestException
name|thrown
init|=
name|assertThrows
argument_list|(
name|BadRequestException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|thrown
argument_list|)
operator|.
name|hasMessageThat
argument_list|()
operator|.
name|contains
argument_list|(
literal|"Range (13:9 - 5:10)"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rangesOfFixReplacementsOfSameFixSuggestionForSameFileMayNotOverlap ()
specifier|public
name|void
name|rangesOfFixReplacementsOfSameFixSuggestionForSameFileMayNotOverlap
parameter_list|()
throws|throws
name|Exception
block|{
name|FixReplacementInfo
name|fixReplacementInfo1
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo1
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|replacement
operator|=
literal|"First modification\n"
expr_stmt|;
name|FixReplacementInfo
name|fixReplacementInfo2
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo2
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|replacement
operator|=
literal|"Second modification\n"
expr_stmt|;
name|FixSuggestionInfo
name|fixSuggestionInfo
init|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo1
argument_list|,
name|fixReplacementInfo2
argument_list|)
decl_stmt|;
name|withFixRobotCommentInput
operator|.
name|fixSuggestions
operator|=
name|ImmutableList
operator|.
name|of
argument_list|(
name|fixSuggestionInfo
argument_list|)
expr_stmt|;
name|BadRequestException
name|thrown
init|=
name|assertThrows
argument_list|(
name|BadRequestException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|thrown
argument_list|)
operator|.
name|hasMessageThat
argument_list|()
operator|.
name|contains
argument_list|(
literal|"overlap"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rangesOfFixReplacementsOfSameFixSuggestionForDifferentFileMayOverlap ()
specifier|public
name|void
name|rangesOfFixReplacementsOfSameFixSuggestionForDifferentFileMayOverlap
parameter_list|()
throws|throws
name|Exception
block|{
name|FixReplacementInfo
name|fixReplacementInfo1
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo1
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|replacement
operator|=
literal|"First modification\n"
expr_stmt|;
name|FixReplacementInfo
name|fixReplacementInfo2
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo2
operator|.
name|path
operator|=
name|FILE_NAME2
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|replacement
operator|=
literal|"Second modification\n"
expr_stmt|;
name|FixSuggestionInfo
name|fixSuggestionInfo
init|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo1
argument_list|,
name|fixReplacementInfo2
argument_list|)
decl_stmt|;
name|withFixRobotCommentInput
operator|.
name|fixSuggestions
operator|=
name|ImmutableList
operator|.
name|of
argument_list|(
name|fixSuggestionInfo
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|assertThatList
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|onlyElement
argument_list|()
operator|.
name|fixSuggestions
argument_list|()
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|rangesOfFixReplacementsOfDifferentFixSuggestionsForSameFileMayOverlap ()
specifier|public
name|void
name|rangesOfFixReplacementsOfDifferentFixSuggestionsForSameFileMayOverlap
parameter_list|()
throws|throws
name|Exception
block|{
name|FixReplacementInfo
name|fixReplacementInfo1
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo1
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|replacement
operator|=
literal|"First modification\n"
expr_stmt|;
name|FixSuggestionInfo
name|fixSuggestionInfo1
init|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo1
argument_list|)
decl_stmt|;
name|FixReplacementInfo
name|fixReplacementInfo2
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo2
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|replacement
operator|=
literal|"Second modification\n"
expr_stmt|;
name|FixSuggestionInfo
name|fixSuggestionInfo2
init|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo2
argument_list|)
decl_stmt|;
name|withFixRobotCommentInput
operator|.
name|fixSuggestions
operator|=
name|ImmutableList
operator|.
name|of
argument_list|(
name|fixSuggestionInfo1
argument_list|,
name|fixSuggestionInfo2
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|assertThatList
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|onlyElement
argument_list|()
operator|.
name|fixSuggestions
argument_list|()
operator|.
name|hasSize
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fixReplacementsDoNotNeedToBeOrderedAccordingToRange ()
specifier|public
name|void
name|fixReplacementsDoNotNeedToBeOrderedAccordingToRange
parameter_list|()
throws|throws
name|Exception
block|{
name|FixReplacementInfo
name|fixReplacementInfo1
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo1
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|replacement
operator|=
literal|"First modification\n"
expr_stmt|;
name|FixReplacementInfo
name|fixReplacementInfo2
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo2
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|replacement
operator|=
literal|"Second modification\n"
expr_stmt|;
name|FixReplacementInfo
name|fixReplacementInfo3
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo3
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo3
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo3
operator|.
name|replacement
operator|=
literal|"Third modification\n"
expr_stmt|;
name|FixSuggestionInfo
name|fixSuggestionInfo
init|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo2
argument_list|,
name|fixReplacementInfo1
argument_list|,
name|fixReplacementInfo3
argument_list|)
decl_stmt|;
name|withFixRobotCommentInput
operator|.
name|fixSuggestions
operator|=
name|ImmutableList
operator|.
name|of
argument_list|(
name|fixSuggestionInfo
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|assertThatList
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|onlyElement
argument_list|()
operator|.
name|onlyFixSuggestion
argument_list|()
operator|.
name|replacements
argument_list|()
operator|.
name|hasSize
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|replacementStringOfFixReplacementIsAcceptedAsIs ()
specifier|public
name|void
name|replacementStringOfFixReplacementIsAcceptedAsIs
parameter_list|()
throws|throws
name|Exception
block|{
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|assertThatList
argument_list|(
name|robotCommentInfos
argument_list|)
operator|.
name|onlyElement
argument_list|()
operator|.
name|onlyFixSuggestion
argument_list|()
operator|.
name|onlyReplacement
argument_list|()
operator|.
name|replacement
argument_list|()
operator|.
name|isEqualTo
argument_list|(
name|fixReplacementInfo
operator|.
name|replacement
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|replacementStringOfFixReplacementIsMandatory ()
specifier|public
name|void
name|replacementStringOfFixReplacementIsMandatory
parameter_list|()
throws|throws
name|Exception
block|{
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|null
expr_stmt|;
name|BadRequestException
name|thrown
init|=
name|assertThrows
argument_list|(
name|BadRequestException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|thrown
argument_list|)
operator|.
name|hasMessageThat
argument_list|()
operator|.
name|contains
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"A content for replacement must be "
operator|+
literal|"indicated for the replacement of the robot comment on %s"
argument_list|,
name|withFixRobotCommentInput
operator|.
name|path
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fixWithinALineCanBeApplied ()
specifier|public
name|void
name|fixWithinALineCanBeApplied
parameter_list|()
throws|throws
name|Exception
block|{
name|fixReplacementInfo
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|"Modified content"
expr_stmt|;
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
expr_stmt|;
name|Optional
argument_list|<
name|BinaryResult
argument_list|>
name|file
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|getFile
argument_list|(
name|FILE_NAME
argument_list|)
decl_stmt|;
name|BinaryResultSubject
operator|.
name|assertThat
argument_list|(
name|file
argument_list|)
operator|.
name|value
argument_list|()
operator|.
name|asString
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|"First line\nSecond line\nTModified contentrd line\nFourth line\nFifth line\n"
operator|+
literal|"Sixth line\nSeventh line\nEighth line\nNinth line\nTenth line\n"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fixSpanningMultipleLinesCanBeApplied ()
specifier|public
name|void
name|fixSpanningMultipleLinesCanBeApplied
parameter_list|()
throws|throws
name|Exception
block|{
name|fixReplacementInfo
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|"Modified content\n5"
expr_stmt|;
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|2
argument_list|,
literal|5
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
expr_stmt|;
name|Optional
argument_list|<
name|BinaryResult
argument_list|>
name|file
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|getFile
argument_list|(
name|FILE_NAME
argument_list|)
decl_stmt|;
name|BinaryResultSubject
operator|.
name|assertThat
argument_list|(
name|file
argument_list|)
operator|.
name|value
argument_list|()
operator|.
name|asString
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|"First line\nSecond line\nThModified content\n5th line\nSixth line\nSeventh line\n"
operator|+
literal|"Eighth line\nNinth line\nTenth line\n"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fixWithTwoCloseReplacementsOnSameFileCanBeApplied ()
specifier|public
name|void
name|fixWithTwoCloseReplacementsOnSameFileCanBeApplied
parameter_list|()
throws|throws
name|Exception
block|{
name|FixReplacementInfo
name|fixReplacementInfo1
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo1
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|replacement
operator|=
literal|"First modification\n"
expr_stmt|;
name|FixReplacementInfo
name|fixReplacementInfo2
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo2
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|replacement
operator|=
literal|"Some other modified content\n"
expr_stmt|;
name|FixSuggestionInfo
name|fixSuggestionInfo
init|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo1
argument_list|,
name|fixReplacementInfo2
argument_list|)
decl_stmt|;
name|withFixRobotCommentInput
operator|.
name|fixSuggestions
operator|=
name|ImmutableList
operator|.
name|of
argument_list|(
name|fixSuggestionInfo
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
expr_stmt|;
name|Optional
argument_list|<
name|BinaryResult
argument_list|>
name|file
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|getFile
argument_list|(
name|FILE_NAME
argument_list|)
decl_stmt|;
name|BinaryResultSubject
operator|.
name|assertThat
argument_list|(
name|file
argument_list|)
operator|.
name|value
argument_list|()
operator|.
name|asString
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|"First line\nFirst modification\nSome other modified content\nFourth line\nFifth line\n"
operator|+
literal|"Sixth line\nSeventh line\nEighth line\nNinth line\nTenth line\n"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|twoFixesOnSameFileCanBeApplied ()
specifier|public
name|void
name|twoFixesOnSameFileCanBeApplied
parameter_list|()
throws|throws
name|Exception
block|{
name|FixReplacementInfo
name|fixReplacementInfo1
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo1
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|replacement
operator|=
literal|"First modification\n"
expr_stmt|;
name|FixSuggestionInfo
name|fixSuggestionInfo1
init|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo1
argument_list|)
decl_stmt|;
name|FixReplacementInfo
name|fixReplacementInfo2
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo2
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|8
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|replacement
operator|=
literal|"Some other modified content\n"
expr_stmt|;
name|FixSuggestionInfo
name|fixSuggestionInfo2
init|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo2
argument_list|)
decl_stmt|;
name|RobotCommentInput
name|robotCommentInput1
init|=
name|createRobotCommentInput
argument_list|(
name|fixSuggestionInfo1
argument_list|)
decl_stmt|;
name|RobotCommentInput
name|robotCommentInput2
init|=
name|createRobotCommentInput
argument_list|(
name|fixSuggestionInfo2
argument_list|)
decl_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|robotCommentInput1
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|robotCommentInput2
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixIds
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixIds
operator|.
name|get
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|Optional
argument_list|<
name|BinaryResult
argument_list|>
name|file
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|getFile
argument_list|(
name|FILE_NAME
argument_list|)
decl_stmt|;
name|BinaryResultSubject
operator|.
name|assertThat
argument_list|(
name|file
argument_list|)
operator|.
name|value
argument_list|()
operator|.
name|asString
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|"First line\nFirst modification\nThird line\nFourth line\nFifth line\nSixth line\n"
operator|+
literal|"Seventh line\nSome other modified content\nNinth line\nTenth line\n"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|twoConflictingFixesOnSameFileCannotBeApplied ()
specifier|public
name|void
name|twoConflictingFixesOnSameFileCannotBeApplied
parameter_list|()
throws|throws
name|Exception
block|{
name|FixReplacementInfo
name|fixReplacementInfo1
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo1
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|replacement
operator|=
literal|"First modification\n"
expr_stmt|;
name|FixSuggestionInfo
name|fixSuggestionInfo1
init|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo1
argument_list|)
decl_stmt|;
name|FixReplacementInfo
name|fixReplacementInfo2
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo2
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|replacement
operator|=
literal|"Some other modified content\n"
expr_stmt|;
name|FixSuggestionInfo
name|fixSuggestionInfo2
init|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo2
argument_list|)
decl_stmt|;
name|RobotCommentInput
name|robotCommentInput1
init|=
name|createRobotCommentInput
argument_list|(
name|fixSuggestionInfo1
argument_list|)
decl_stmt|;
name|RobotCommentInput
name|robotCommentInput2
init|=
name|createRobotCommentInput
argument_list|(
name|fixSuggestionInfo2
argument_list|)
decl_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|robotCommentInput1
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|robotCommentInput2
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixIds
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|ResourceConflictException
name|thrown
init|=
name|assertThrows
argument_list|(
name|ResourceConflictException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixIds
operator|.
name|get
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|thrown
argument_list|)
operator|.
name|hasMessageThat
argument_list|()
operator|.
name|contains
argument_list|(
literal|"merge"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|twoFixesOfSameRobotCommentCanBeApplied ()
specifier|public
name|void
name|twoFixesOfSameRobotCommentCanBeApplied
parameter_list|()
throws|throws
name|Exception
block|{
name|FixReplacementInfo
name|fixReplacementInfo1
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo1
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|replacement
operator|=
literal|"First modification\n"
expr_stmt|;
name|FixSuggestionInfo
name|fixSuggestionInfo1
init|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo1
argument_list|)
decl_stmt|;
name|FixReplacementInfo
name|fixReplacementInfo2
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo2
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|8
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|replacement
operator|=
literal|"Some other modified content\n"
expr_stmt|;
name|FixSuggestionInfo
name|fixSuggestionInfo2
init|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo2
argument_list|)
decl_stmt|;
name|withFixRobotCommentInput
operator|.
name|fixSuggestions
operator|=
name|ImmutableList
operator|.
name|of
argument_list|(
name|fixSuggestionInfo1
argument_list|,
name|fixSuggestionInfo2
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixIds
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixIds
operator|.
name|get
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|Optional
argument_list|<
name|BinaryResult
argument_list|>
name|file
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|getFile
argument_list|(
name|FILE_NAME
argument_list|)
decl_stmt|;
name|BinaryResultSubject
operator|.
name|assertThat
argument_list|(
name|file
argument_list|)
operator|.
name|value
argument_list|()
operator|.
name|asString
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|"First line\nFirst modification\nThird line\nFourth line\nFifth line\nSixth line\n"
operator|+
literal|"Seventh line\nSome other modified content\nNinth line\nTenth line\n"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fixReferringToDifferentFileThanRobotCommentCanBeApplied ()
specifier|public
name|void
name|fixReferringToDifferentFileThanRobotCommentCanBeApplied
parameter_list|()
throws|throws
name|Exception
block|{
name|fixReplacementInfo
operator|.
name|path
operator|=
name|FILE_NAME2
expr_stmt|;
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|"Modified content\n"
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
expr_stmt|;
name|Optional
argument_list|<
name|BinaryResult
argument_list|>
name|file
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|getFile
argument_list|(
name|FILE_NAME2
argument_list|)
decl_stmt|;
name|BinaryResultSubject
operator|.
name|assertThat
argument_list|(
name|file
argument_list|)
operator|.
name|value
argument_list|()
operator|.
name|asString
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|"1st line\nModified content\n3rd line\n"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fixInvolvingTwoFilesCanBeApplied ()
specifier|public
name|void
name|fixInvolvingTwoFilesCanBeApplied
parameter_list|()
throws|throws
name|Exception
block|{
name|FixReplacementInfo
name|fixReplacementInfo1
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo1
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo1
operator|.
name|replacement
operator|=
literal|"First modification\n"
expr_stmt|;
name|FixReplacementInfo
name|fixReplacementInfo2
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|fixReplacementInfo2
operator|.
name|path
operator|=
name|FILE_NAME2
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo2
operator|.
name|replacement
operator|=
literal|"Different file modification\n"
expr_stmt|;
name|FixSuggestionInfo
name|fixSuggestionInfo
init|=
name|createFixSuggestionInfo
argument_list|(
name|fixReplacementInfo1
argument_list|,
name|fixReplacementInfo2
argument_list|)
decl_stmt|;
name|withFixRobotCommentInput
operator|.
name|fixSuggestions
operator|=
name|ImmutableList
operator|.
name|of
argument_list|(
name|fixSuggestionInfo
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
expr_stmt|;
name|Optional
argument_list|<
name|BinaryResult
argument_list|>
name|file
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|getFile
argument_list|(
name|FILE_NAME
argument_list|)
decl_stmt|;
name|BinaryResultSubject
operator|.
name|assertThat
argument_list|(
name|file
argument_list|)
operator|.
name|value
argument_list|()
operator|.
name|asString
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|"First line\nFirst modification\nThird line\nFourth line\nFifth line\nSixth line\n"
operator|+
literal|"Seventh line\nEighth line\nNinth line\nTenth line\n"
argument_list|)
expr_stmt|;
name|Optional
argument_list|<
name|BinaryResult
argument_list|>
name|file2
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|getFile
argument_list|(
name|FILE_NAME2
argument_list|)
decl_stmt|;
name|BinaryResultSubject
operator|.
name|assertThat
argument_list|(
name|file2
argument_list|)
operator|.
name|value
argument_list|()
operator|.
name|asString
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|"Different file modification\n2nd line\n3rd line\n"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fixReferringToNonExistentFileCannotBeApplied ()
specifier|public
name|void
name|fixReferringToNonExistentFileCannotBeApplied
parameter_list|()
throws|throws
name|Exception
block|{
name|fixReplacementInfo
operator|.
name|path
operator|=
literal|"a_non_existent_file.txt"
expr_stmt|;
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|"Modified content\n"
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|assertThrows
argument_list|(
name|ResourceNotFoundException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fixOnPreviousPatchSetWithoutChangeEditCannotBeApplied ()
specifier|public
name|void
name|fixOnPreviousPatchSetWithoutChangeEditCannotBeApplied
parameter_list|()
throws|throws
name|Exception
block|{
name|fixReplacementInfo
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|"Modified content"
expr_stmt|;
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
comment|// Remember patch set and add another one.
name|String
name|previousRevision
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|amendChange
argument_list|(
name|changeId
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|ResourceConflictException
name|thrown
init|=
name|assertThrows
argument_list|(
name|ResourceConflictException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|revision
argument_list|(
name|previousRevision
argument_list|)
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|thrown
argument_list|)
operator|.
name|hasMessageThat
argument_list|()
operator|.
name|contains
argument_list|(
literal|"current"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fixOnPreviousPatchSetWithExistingChangeEditCanBeApplied ()
specifier|public
name|void
name|fixOnPreviousPatchSetWithExistingChangeEditCanBeApplied
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Create an empty change edit.
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|create
argument_list|()
expr_stmt|;
name|fixReplacementInfo
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|"Modified content"
expr_stmt|;
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
comment|// Remember patch set and add another one.
name|String
name|previousRevision
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|amendChange
argument_list|(
name|changeId
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|EditInfo
name|editInfo
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|revision
argument_list|(
name|previousRevision
argument_list|)
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
decl_stmt|;
name|Optional
argument_list|<
name|BinaryResult
argument_list|>
name|file
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|getFile
argument_list|(
name|FILE_NAME
argument_list|)
decl_stmt|;
name|BinaryResultSubject
operator|.
name|assertThat
argument_list|(
name|file
argument_list|)
operator|.
name|value
argument_list|()
operator|.
name|asString
argument_list|()
operator|.
name|isEqualTo
argument_list|(
literal|"First line\nSecond line\nTModified contentrd line\nFourth line\nFifth line\n"
operator|+
literal|"Sixth line\nSeventh line\nEighth line\nNinth line\nTenth line\n"
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|editInfo
argument_list|)
operator|.
name|baseRevision
argument_list|()
operator|.
name|isEqualTo
argument_list|(
name|previousRevision
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fixOnCurrentPatchSetWithChangeEditOnPreviousPatchSetCannotBeApplied ()
specifier|public
name|void
name|fixOnCurrentPatchSetWithChangeEditOnPreviousPatchSetCannotBeApplied
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Create an empty change edit.
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|create
argument_list|()
expr_stmt|;
comment|// Add another patch set.
name|amendChange
argument_list|(
name|changeId
argument_list|)
expr_stmt|;
name|fixReplacementInfo
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|"Modified content"
expr_stmt|;
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|ResourceConflictException
name|thrown
init|=
name|assertThrows
argument_list|(
name|ResourceConflictException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|thrown
argument_list|)
operator|.
name|hasMessageThat
argument_list|()
operator|.
name|contains
argument_list|(
literal|"based"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fixDoesNotModifyCommitMessageOfChangeEdit ()
specifier|public
name|void
name|fixDoesNotModifyCommitMessageOfChangeEdit
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|changeEditCommitMessage
init|=
literal|"This is the commit message of the change edit.\n"
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|modifyCommitMessage
argument_list|(
name|changeEditCommitMessage
argument_list|)
expr_stmt|;
name|fixReplacementInfo
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|"Modified content"
expr_stmt|;
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
expr_stmt|;
name|String
name|commitMessage
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|getCommitMessage
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|commitMessage
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|changeEditCommitMessage
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|applyingFixTwiceIsIdempotent ()
specifier|public
name|void
name|applyingFixTwiceIsIdempotent
parameter_list|()
throws|throws
name|Exception
block|{
name|fixReplacementInfo
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|"Modified content"
expr_stmt|;
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
expr_stmt|;
name|String
name|expectedEditCommit
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|get
argument_list|()
operator|.
name|map
argument_list|(
name|edit
lambda|->
name|edit
operator|.
name|commit
operator|.
name|commit
argument_list|)
operator|.
name|orElse
argument_list|(
literal|""
argument_list|)
decl_stmt|;
comment|// Apply the fix again.
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
expr_stmt|;
name|Optional
argument_list|<
name|EditInfo
argument_list|>
name|editInfo
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|get
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|editInfo
argument_list|)
operator|.
name|value
argument_list|()
operator|.
name|commit
argument_list|()
operator|.
name|commit
argument_list|()
operator|.
name|isEqualTo
argument_list|(
name|expectedEditCommit
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|nonExistentFixCannotBeApplied ()
specifier|public
name|void
name|nonExistentFixCannotBeApplied
parameter_list|()
throws|throws
name|Exception
block|{
name|fixReplacementInfo
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|"Modified content"
expr_stmt|;
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|String
name|nonExistentFixId
init|=
name|fixId
operator|+
literal|"_non-existent"
decl_stmt|;
name|assertThrows
argument_list|(
name|ResourceNotFoundException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|nonExistentFixId
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|applyingFixReturnsEditInfoForCreatedChangeEdit ()
specifier|public
name|void
name|applyingFixReturnsEditInfoForCreatedChangeEdit
parameter_list|()
throws|throws
name|Exception
block|{
name|fixReplacementInfo
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|"Modified content"
expr_stmt|;
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|EditInfo
name|editInfo
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
decl_stmt|;
name|Optional
argument_list|<
name|EditInfo
argument_list|>
name|expectedEditInfo
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|get
argument_list|()
decl_stmt|;
name|String
name|expectedEditCommit
init|=
name|expectedEditInfo
operator|.
name|map
argument_list|(
name|edit
lambda|->
name|edit
operator|.
name|commit
operator|.
name|commit
argument_list|)
operator|.
name|orElse
argument_list|(
literal|""
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|editInfo
argument_list|)
operator|.
name|commit
argument_list|()
operator|.
name|commit
argument_list|()
operator|.
name|isEqualTo
argument_list|(
name|expectedEditCommit
argument_list|)
expr_stmt|;
name|String
name|expectedBaseRevision
init|=
name|expectedEditInfo
operator|.
name|map
argument_list|(
name|edit
lambda|->
name|edit
operator|.
name|baseRevision
argument_list|)
operator|.
name|orElse
argument_list|(
literal|""
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|editInfo
argument_list|)
operator|.
name|baseRevision
argument_list|()
operator|.
name|isEqualTo
argument_list|(
name|expectedBaseRevision
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|applyingFixOnTopOfChangeEditReturnsEditInfoForUpdatedChangeEdit ()
specifier|public
name|void
name|applyingFixOnTopOfChangeEditReturnsEditInfoForUpdatedChangeEdit
parameter_list|()
throws|throws
name|Exception
block|{
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|create
argument_list|()
expr_stmt|;
name|fixReplacementInfo
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|"Modified content"
expr_stmt|;
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|EditInfo
name|editInfo
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
decl_stmt|;
name|Optional
argument_list|<
name|EditInfo
argument_list|>
name|expectedEditInfo
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|get
argument_list|()
decl_stmt|;
name|String
name|expectedEditCommit
init|=
name|expectedEditInfo
operator|.
name|map
argument_list|(
name|edit
lambda|->
name|edit
operator|.
name|commit
operator|.
name|commit
argument_list|)
operator|.
name|orElse
argument_list|(
literal|""
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|editInfo
argument_list|)
operator|.
name|commit
argument_list|()
operator|.
name|commit
argument_list|()
operator|.
name|isEqualTo
argument_list|(
name|expectedEditCommit
argument_list|)
expr_stmt|;
name|String
name|expectedBaseRevision
init|=
name|expectedEditInfo
operator|.
name|map
argument_list|(
name|edit
lambda|->
name|edit
operator|.
name|baseRevision
argument_list|)
operator|.
name|orElse
argument_list|(
literal|""
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|editInfo
argument_list|)
operator|.
name|baseRevision
argument_list|()
operator|.
name|isEqualTo
argument_list|(
name|expectedBaseRevision
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|createdChangeEditIsBasedOnCurrentPatchSet ()
specifier|public
name|void
name|createdChangeEditIsBasedOnCurrentPatchSet
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|currentRevision
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|get
argument_list|()
operator|.
name|currentRevision
decl_stmt|;
name|fixReplacementInfo
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|fixReplacementInfo
operator|.
name|replacement
operator|=
literal|"Modified content"
expr_stmt|;
name|fixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|addRobotComment
argument_list|(
name|changeId
argument_list|,
name|withFixRobotCommentInput
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotCommentInfos
init|=
name|getRobotComments
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fixIds
init|=
name|getFixIds
argument_list|(
name|robotCommentInfos
argument_list|)
decl_stmt|;
name|String
name|fixId
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|fixIds
argument_list|)
decl_stmt|;
name|EditInfo
name|editInfo
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|applyFix
argument_list|(
name|fixId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|editInfo
argument_list|)
operator|.
name|baseRevision
argument_list|()
operator|.
name|isEqualTo
argument_list|(
name|currentRevision
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|queryChangesWithCommentCounts ()
specifier|public
name|void
name|queryChangesWithCommentCounts
parameter_list|()
throws|throws
name|Exception
block|{
name|PushOneCommit
operator|.
name|Result
name|r1
init|=
name|createChange
argument_list|()
decl_stmt|;
name|PushOneCommit
operator|.
name|Result
name|r2
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|admin
operator|.
name|newIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|,
name|SUBJECT
argument_list|,
name|FILE_NAME
argument_list|,
literal|"new content"
argument_list|,
name|r1
operator|.
name|getChangeId
argument_list|()
argument_list|)
operator|.
name|to
argument_list|(
literal|"refs/for/master"
argument_list|)
decl_stmt|;
name|addRobotComment
argument_list|(
name|r2
operator|.
name|getChangeId
argument_list|()
argument_list|,
name|createRobotCommentInputWithMandatoryFields
argument_list|()
argument_list|)
expr_stmt|;
try|try
init|(
name|AutoCloseable
name|ignored
init|=
name|disableNoteDb
argument_list|()
init|)
block|{
name|ChangeInfo
name|result
init|=
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|query
argument_list|(
name|r2
operator|.
name|getChangeId
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
comment|// currently, we create all robot comments as 'resolved' by default.
comment|// if we allow users to resolve a robot comment, then this test should
comment|// be modified.
name|assertThat
argument_list|(
name|result
operator|.
name|unresolvedCommentCount
argument_list|)
operator|.
name|isEqualTo
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|result
operator|.
name|totalCommentCount
argument_list|)
operator|.
name|isEqualTo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|createRobotCommentInputWithMandatoryFields ()
specifier|private
specifier|static
name|RobotCommentInput
name|createRobotCommentInputWithMandatoryFields
parameter_list|()
block|{
name|RobotCommentInput
name|in
init|=
operator|new
name|RobotCommentInput
argument_list|()
decl_stmt|;
name|in
operator|.
name|robotId
operator|=
literal|"happyRobot"
expr_stmt|;
name|in
operator|.
name|robotRunId
operator|=
literal|"1"
expr_stmt|;
name|in
operator|.
name|line
operator|=
literal|1
expr_stmt|;
name|in
operator|.
name|message
operator|=
literal|"nit: trailing whitespace"
expr_stmt|;
name|in
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
return|return
name|in
return|;
block|}
DECL|method|createRobotCommentInput ( FixSuggestionInfo... fixSuggestionInfos)
specifier|private
specifier|static
name|RobotCommentInput
name|createRobotCommentInput
parameter_list|(
name|FixSuggestionInfo
modifier|...
name|fixSuggestionInfos
parameter_list|)
block|{
name|RobotCommentInput
name|in
init|=
name|createRobotCommentInputWithMandatoryFields
argument_list|()
decl_stmt|;
name|in
operator|.
name|url
operator|=
literal|"http://www.happy-robot.com"
expr_stmt|;
name|in
operator|.
name|properties
operator|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
expr_stmt|;
name|in
operator|.
name|properties
operator|.
name|put
argument_list|(
literal|"key1"
argument_list|,
literal|"value1"
argument_list|)
expr_stmt|;
name|in
operator|.
name|properties
operator|.
name|put
argument_list|(
literal|"key2"
argument_list|,
literal|"value2"
argument_list|)
expr_stmt|;
name|in
operator|.
name|fixSuggestions
operator|=
name|Arrays
operator|.
name|asList
argument_list|(
name|fixSuggestionInfos
argument_list|)
expr_stmt|;
return|return
name|in
return|;
block|}
DECL|method|createFixSuggestionInfo ( FixReplacementInfo... fixReplacementInfos)
specifier|private
specifier|static
name|FixSuggestionInfo
name|createFixSuggestionInfo
parameter_list|(
name|FixReplacementInfo
modifier|...
name|fixReplacementInfos
parameter_list|)
block|{
name|FixSuggestionInfo
name|newFixSuggestionInfo
init|=
operator|new
name|FixSuggestionInfo
argument_list|()
decl_stmt|;
name|newFixSuggestionInfo
operator|.
name|fixId
operator|=
literal|"An ID which must be overwritten."
expr_stmt|;
name|newFixSuggestionInfo
operator|.
name|description
operator|=
literal|"A description for a suggested fix."
expr_stmt|;
name|newFixSuggestionInfo
operator|.
name|replacements
operator|=
name|Arrays
operator|.
name|asList
argument_list|(
name|fixReplacementInfos
argument_list|)
expr_stmt|;
return|return
name|newFixSuggestionInfo
return|;
block|}
DECL|method|createFixReplacementInfo ()
specifier|private
specifier|static
name|FixReplacementInfo
name|createFixReplacementInfo
parameter_list|()
block|{
name|FixReplacementInfo
name|newFixReplacementInfo
init|=
operator|new
name|FixReplacementInfo
argument_list|()
decl_stmt|;
name|newFixReplacementInfo
operator|.
name|path
operator|=
name|FILE_NAME
expr_stmt|;
name|newFixReplacementInfo
operator|.
name|replacement
operator|=
literal|"some replacement code"
expr_stmt|;
name|newFixReplacementInfo
operator|.
name|range
operator|=
name|createRange
argument_list|(
literal|3
argument_list|,
literal|9
argument_list|,
literal|8
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
name|newFixReplacementInfo
return|;
block|}
DECL|method|createRange ( int startLine, int startCharacter, int endLine, int endCharacter)
specifier|private
specifier|static
name|Comment
operator|.
name|Range
name|createRange
parameter_list|(
name|int
name|startLine
parameter_list|,
name|int
name|startCharacter
parameter_list|,
name|int
name|endLine
parameter_list|,
name|int
name|endCharacter
parameter_list|)
block|{
name|Comment
operator|.
name|Range
name|range
init|=
operator|new
name|Comment
operator|.
name|Range
argument_list|()
decl_stmt|;
name|range
operator|.
name|startLine
operator|=
name|startLine
expr_stmt|;
name|range
operator|.
name|startCharacter
operator|=
name|startCharacter
expr_stmt|;
name|range
operator|.
name|endLine
operator|=
name|endLine
expr_stmt|;
name|range
operator|.
name|endCharacter
operator|=
name|endCharacter
expr_stmt|;
return|return
name|range
return|;
block|}
DECL|method|addRobotComment (String targetChangeId, RobotCommentInput robotCommentInput)
specifier|private
name|void
name|addRobotComment
parameter_list|(
name|String
name|targetChangeId
parameter_list|,
name|RobotCommentInput
name|robotCommentInput
parameter_list|)
throws|throws
name|Exception
block|{
name|ReviewInput
name|reviewInput
init|=
operator|new
name|ReviewInput
argument_list|()
decl_stmt|;
name|reviewInput
operator|.
name|robotComments
operator|=
name|Collections
operator|.
name|singletonMap
argument_list|(
name|robotCommentInput
operator|.
name|path
argument_list|,
name|ImmutableList
operator|.
name|of
argument_list|(
name|robotCommentInput
argument_list|)
argument_list|)
expr_stmt|;
name|reviewInput
operator|.
name|message
operator|=
literal|"robot comment test"
expr_stmt|;
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|targetChangeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|review
argument_list|(
name|reviewInput
argument_list|)
expr_stmt|;
block|}
DECL|method|getRobotComments ()
specifier|private
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|getRobotComments
parameter_list|()
throws|throws
name|RestApiException
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|robotCommentsAsList
argument_list|()
return|;
block|}
DECL|method|assertRobotComment (RobotCommentInfo c, RobotCommentInput expected)
specifier|private
name|void
name|assertRobotComment
parameter_list|(
name|RobotCommentInfo
name|c
parameter_list|,
name|RobotCommentInput
name|expected
parameter_list|)
block|{
name|assertRobotComment
argument_list|(
name|c
argument_list|,
name|expected
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
DECL|method|assertRobotComment ( RobotCommentInfo c, RobotCommentInput expected, boolean expectPath)
specifier|private
name|void
name|assertRobotComment
parameter_list|(
name|RobotCommentInfo
name|c
parameter_list|,
name|RobotCommentInput
name|expected
parameter_list|,
name|boolean
name|expectPath
parameter_list|)
block|{
name|assertThat
argument_list|(
name|c
operator|.
name|robotId
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|expected
operator|.
name|robotId
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|c
operator|.
name|robotRunId
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|expected
operator|.
name|robotRunId
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|c
operator|.
name|url
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|expected
operator|.
name|url
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|c
operator|.
name|properties
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|expected
operator|.
name|properties
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|c
operator|.
name|line
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|expected
operator|.
name|line
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|c
operator|.
name|message
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|expected
operator|.
name|message
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|c
operator|.
name|author
operator|.
name|email
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|admin
operator|.
name|email
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|expectPath
condition|)
block|{
name|assertThat
argument_list|(
name|c
operator|.
name|path
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|expected
operator|.
name|path
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|assertThat
argument_list|(
name|c
operator|.
name|path
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|getStringFor (int numberOfBytes)
specifier|private
specifier|static
name|String
name|getStringFor
parameter_list|(
name|int
name|numberOfBytes
parameter_list|)
block|{
name|char
index|[]
name|chars
init|=
operator|new
name|char
index|[
name|numberOfBytes
index|]
decl_stmt|;
comment|// 'a' will require one byte even when mapped to a JSON string
name|Arrays
operator|.
name|fill
argument_list|(
name|chars
argument_list|,
literal|'a'
argument_list|)
expr_stmt|;
return|return
operator|new
name|String
argument_list|(
name|chars
argument_list|)
return|;
block|}
DECL|method|getFixIds (List<RobotCommentInfo> robotComments)
specifier|private
specifier|static
name|List
argument_list|<
name|String
argument_list|>
name|getFixIds
parameter_list|(
name|List
argument_list|<
name|RobotCommentInfo
argument_list|>
name|robotComments
parameter_list|)
block|{
name|assertThatList
argument_list|(
name|robotComments
argument_list|)
operator|.
name|isNotNull
argument_list|()
expr_stmt|;
return|return
name|robotComments
operator|.
name|stream
argument_list|()
operator|.
name|map
argument_list|(
name|robotCommentInfo
lambda|->
name|robotCommentInfo
operator|.
name|fixSuggestions
argument_list|)
operator|.
name|filter
argument_list|(
name|Objects
operator|::
name|nonNull
argument_list|)
operator|.
name|flatMap
argument_list|(
name|List
operator|::
name|stream
argument_list|)
operator|.
name|map
argument_list|(
name|fixSuggestionInfo
lambda|->
name|fixSuggestionInfo
operator|.
name|fixId
argument_list|)
operator|.
name|collect
argument_list|(
name|toList
argument_list|()
argument_list|)
return|;
block|}
block|}
end_class

end_unit

