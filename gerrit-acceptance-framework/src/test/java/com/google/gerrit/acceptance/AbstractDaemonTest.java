begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|// Copyright (C) 2013 The Android Open Source Project
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Licensed under the Apache License, Version 2.0 (the "License");
end_comment

begin_comment
comment|// you may not use this file except in compliance with the License.
end_comment

begin_comment
comment|// You may obtain a copy of the License at
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// http://www.apache.org/licenses/LICENSE-2.0
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Unless required by applicable law or agreed to in writing, software
end_comment

begin_comment
comment|// distributed under the License is distributed on an "AS IS" BASIS,
end_comment

begin_comment
comment|// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
end_comment

begin_comment
comment|// See the License for the specific language governing permissions and
end_comment

begin_comment
comment|// limitations under the License.
end_comment

begin_package
DECL|package|com.google.gerrit.acceptance
package|package
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
package|;
end_package

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|truth
operator|.
name|Truth
operator|.
name|assertThat
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|truth
operator|.
name|TruthJUnit
operator|.
name|assume
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|GitUtil
operator|.
name|initSsh
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|changes
operator|.
name|SubmittedTogetherOption
operator|.
name|NON_VISIBLE_CHANGES
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|Patch
operator|.
name|COMMIT_MSG
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|Patch
operator|.
name|MERGE_LIST
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|group
operator|.
name|SystemGroupBackend
operator|.
name|REGISTERED_USERS
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|project
operator|.
name|Util
operator|.
name|category
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|project
operator|.
name|Util
operator|.
name|value
import|;
end_import

begin_import
import|import static
name|java
operator|.
name|nio
operator|.
name|charset
operator|.
name|StandardCharsets
operator|.
name|UTF_8
import|;
end_import

begin_import
import|import static
name|java
operator|.
name|util
operator|.
name|stream
operator|.
name|Collectors
operator|.
name|toList
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|Constants
operator|.
name|HEAD
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|Constants
operator|.
name|R_TAGS
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Strings
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ImmutableList
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ImmutableMap
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Iterables
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|jimfs
operator|.
name|Jimfs
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|primitives
operator|.
name|Chars
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|AcceptanceTestRequestScope
operator|.
name|Context
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|Nullable
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|AccessSection
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|ContributorAgreement
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|GroupReference
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|LabelFunction
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|LabelType
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|LabelValue
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|Permission
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|PermissionRule
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|GerritApi
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|changes
operator|.
name|ReviewInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|changes
operator|.
name|RevisionApi
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|changes
operator|.
name|SubmittedTogetherInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|groups
operator|.
name|GroupApi
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|groups
operator|.
name|GroupInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|projects
operator|.
name|BranchApi
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|projects
operator|.
name|BranchInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|projects
operator|.
name|ProjectInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|InheritableBoolean
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|ListChangesOption
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|ProjectWatchInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|SubmitType
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|ActionInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|ChangeInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|ChangeType
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|DiffInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|EditInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|BinaryResult
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|IdString
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|RestApiException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|AccountGroup
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|Branch
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|PatchSet
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|Project
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|RefNames
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|server
operator|.
name|ReviewDb
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|AnonymousUser
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|ChangeFinder
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|GerritPersonIdent
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|IdentifiedUser
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|OutputFormat
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|PatchSetUtil
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|AccountCache
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|Accounts
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|GroupCache
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|change
operator|.
name|Abandon
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|change
operator|.
name|ChangeResource
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|change
operator|.
name|FileContentUtil
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|change
operator|.
name|RevisionResource
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|change
operator|.
name|Revisions
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|config
operator|.
name|AllProjectsName
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|config
operator|.
name|CanonicalWebUrl
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|config
operator|.
name|GerritServerConfig
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|config
operator|.
name|PluginConfigFactory
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|git
operator|.
name|GitRepositoryManager
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|git
operator|.
name|MetaDataUpdate
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|git
operator|.
name|ProjectConfig
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|group
operator|.
name|Groups
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|group
operator|.
name|InternalGroup
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|group
operator|.
name|SystemGroupBackend
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|index
operator|.
name|change
operator|.
name|ChangeIndex
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|index
operator|.
name|change
operator|.
name|ChangeIndexCollection
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|index
operator|.
name|change
operator|.
name|ChangeIndexer
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|mail
operator|.
name|Address
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|mail
operator|.
name|send
operator|.
name|EmailHeader
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|notedb
operator|.
name|ChangeNoteUtil
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|notedb
operator|.
name|ChangeNotes
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|notedb
operator|.
name|MutableNotesMigration
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|project
operator|.
name|ProjectCache
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|project
operator|.
name|Util
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|query
operator|.
name|change
operator|.
name|ChangeData
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|query
operator|.
name|change
operator|.
name|InternalChangeQuery
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|update
operator|.
name|BatchUpdate
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|testutil
operator|.
name|ConfigSuite
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|testutil
operator|.
name|FakeAuditService
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|testutil
operator|.
name|FakeEmailSender
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|testutil
operator|.
name|FakeEmailSender
operator|.
name|Message
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|testutil
operator|.
name|NoteDbMode
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|testutil
operator|.
name|SshMode
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|testutil
operator|.
name|TempFileUtil
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gson
operator|.
name|Gson
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gwtorm
operator|.
name|server
operator|.
name|OrmException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gwtorm
operator|.
name|server
operator|.
name|SchemaFactory
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|Inject
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|Module
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|Provider
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|DirectoryStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|FileSystem
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|FileSystems
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|Files
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|EnumSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Optional
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|api
operator|.
name|Git
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|errors
operator|.
name|ConfigInvalidException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|errors
operator|.
name|RepositoryNotFoundException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|internal
operator|.
name|storage
operator|.
name|dfs
operator|.
name|InMemoryRepository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|junit
operator|.
name|TestRepository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|Config
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|Constants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|NullProgressMonitor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|ObjectId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|PersonIdent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|Ref
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|Repository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|revwalk
operator|.
name|RevCommit
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|revwalk
operator|.
name|RevTree
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|revwalk
operator|.
name|RevWalk
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|transport
operator|.
name|FetchResult
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|transport
operator|.
name|RefSpec
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|transport
operator|.
name|Transport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|transport
operator|.
name|TransportBundleStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|transport
operator|.
name|URIish
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|After
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|AfterClass
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Before
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Rule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|rules
operator|.
name|ExpectedException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|rules
operator|.
name|TestRule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|runner
operator|.
name|Description
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|runner
operator|.
name|RunWith
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|runners
operator|.
name|model
operator|.
name|Statement
import|;
end_import

begin_class
annotation|@
name|RunWith
argument_list|(
name|ConfigSuite
operator|.
name|class
argument_list|)
DECL|class|AbstractDaemonTest
specifier|public
specifier|abstract
class|class
name|AbstractDaemonTest
block|{
DECL|field|commonServer
specifier|private
specifier|static
name|GerritServer
name|commonServer
decl_stmt|;
DECL|field|firstTest
specifier|private
specifier|static
name|Description
name|firstTest
decl_stmt|;
DECL|field|baseConfig
annotation|@
name|ConfigSuite
operator|.
name|Parameter
specifier|public
name|Config
name|baseConfig
decl_stmt|;
DECL|field|configName
annotation|@
name|ConfigSuite
operator|.
name|Name
specifier|private
name|String
name|configName
decl_stmt|;
DECL|field|exception
annotation|@
name|Rule
specifier|public
name|ExpectedException
name|exception
init|=
name|ExpectedException
operator|.
name|none
argument_list|()
decl_stmt|;
annotation|@
name|Rule
DECL|field|testRunner
specifier|public
name|TestRule
name|testRunner
init|=
operator|new
name|TestRule
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Statement
name|apply
parameter_list|(
name|Statement
name|base
parameter_list|,
name|Description
name|description
parameter_list|)
block|{
return|return
operator|new
name|Statement
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|evaluate
parameter_list|()
throws|throws
name|Throwable
block|{
if|if
condition|(
name|firstTest
operator|==
literal|null
condition|)
block|{
name|firstTest
operator|=
name|description
expr_stmt|;
block|}
name|beforeTest
argument_list|(
name|description
argument_list|)
expr_stmt|;
try|try
block|{
name|base
operator|.
name|evaluate
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|afterTest
argument_list|()
expr_stmt|;
block|}
block|}
block|}
return|;
block|}
block|}
decl_stmt|;
DECL|field|canonicalWebUrl
annotation|@
name|Inject
annotation|@
name|CanonicalWebUrl
specifier|protected
name|Provider
argument_list|<
name|String
argument_list|>
name|canonicalWebUrl
decl_stmt|;
DECL|field|serverIdent
annotation|@
name|Inject
annotation|@
name|GerritPersonIdent
specifier|protected
name|Provider
argument_list|<
name|PersonIdent
argument_list|>
name|serverIdent
decl_stmt|;
DECL|field|cfg
annotation|@
name|Inject
annotation|@
name|GerritServerConfig
specifier|protected
name|Config
name|cfg
decl_stmt|;
DECL|field|atrScope
annotation|@
name|Inject
specifier|protected
name|AcceptanceTestRequestScope
name|atrScope
decl_stmt|;
DECL|field|accountCache
annotation|@
name|Inject
specifier|protected
name|AccountCache
name|accountCache
decl_stmt|;
DECL|field|accountCreator
annotation|@
name|Inject
specifier|protected
name|AccountCreator
name|accountCreator
decl_stmt|;
DECL|field|accounts
annotation|@
name|Inject
specifier|protected
name|Accounts
name|accounts
decl_stmt|;
DECL|field|allProjects
annotation|@
name|Inject
specifier|protected
name|AllProjectsName
name|allProjects
decl_stmt|;
DECL|field|batchUpdateFactory
annotation|@
name|Inject
specifier|protected
name|BatchUpdate
operator|.
name|Factory
name|batchUpdateFactory
decl_stmt|;
DECL|field|changeDataFactory
annotation|@
name|Inject
specifier|protected
name|ChangeData
operator|.
name|Factory
name|changeDataFactory
decl_stmt|;
DECL|field|changeFinder
annotation|@
name|Inject
specifier|protected
name|ChangeFinder
name|changeFinder
decl_stmt|;
DECL|field|indexer
annotation|@
name|Inject
specifier|protected
name|ChangeIndexer
name|indexer
decl_stmt|;
DECL|field|changeNoteUtil
annotation|@
name|Inject
specifier|protected
name|ChangeNoteUtil
name|changeNoteUtil
decl_stmt|;
DECL|field|changeResourceFactory
annotation|@
name|Inject
specifier|protected
name|ChangeResource
operator|.
name|Factory
name|changeResourceFactory
decl_stmt|;
DECL|field|sender
annotation|@
name|Inject
specifier|protected
name|FakeEmailSender
name|sender
decl_stmt|;
DECL|field|auditService
annotation|@
name|Inject
specifier|protected
name|FakeAuditService
name|auditService
decl_stmt|;
DECL|field|gApi
annotation|@
name|Inject
specifier|protected
name|GerritApi
name|gApi
decl_stmt|;
DECL|field|repoManager
annotation|@
name|Inject
specifier|protected
name|GitRepositoryManager
name|repoManager
decl_stmt|;
DECL|field|groupCache
annotation|@
name|Inject
specifier|protected
name|GroupCache
name|groupCache
decl_stmt|;
DECL|field|identifiedUserFactory
annotation|@
name|Inject
specifier|protected
name|IdentifiedUser
operator|.
name|GenericFactory
name|identifiedUserFactory
decl_stmt|;
DECL|field|metaDataUpdateFactory
annotation|@
name|Inject
specifier|protected
name|MetaDataUpdate
operator|.
name|Server
name|metaDataUpdateFactory
decl_stmt|;
DECL|field|psUtil
annotation|@
name|Inject
specifier|protected
name|PatchSetUtil
name|psUtil
decl_stmt|;
DECL|field|projectCache
annotation|@
name|Inject
specifier|protected
name|ProjectCache
name|projectCache
decl_stmt|;
DECL|field|queryProvider
annotation|@
name|Inject
specifier|protected
name|Provider
argument_list|<
name|InternalChangeQuery
argument_list|>
name|queryProvider
decl_stmt|;
DECL|field|pushFactory
annotation|@
name|Inject
specifier|protected
name|PushOneCommit
operator|.
name|Factory
name|pushFactory
decl_stmt|;
DECL|field|pluginConfig
annotation|@
name|Inject
specifier|protected
name|PluginConfigFactory
name|pluginConfig
decl_stmt|;
DECL|field|revisions
annotation|@
name|Inject
specifier|protected
name|Revisions
name|revisions
decl_stmt|;
DECL|field|systemGroupBackend
annotation|@
name|Inject
specifier|protected
name|SystemGroupBackend
name|systemGroupBackend
decl_stmt|;
DECL|field|notesMigration
annotation|@
name|Inject
specifier|protected
name|MutableNotesMigration
name|notesMigration
decl_stmt|;
DECL|field|notesFactory
annotation|@
name|Inject
specifier|protected
name|ChangeNotes
operator|.
name|Factory
name|notesFactory
decl_stmt|;
DECL|field|changeAbandoner
annotation|@
name|Inject
specifier|protected
name|Abandon
name|changeAbandoner
decl_stmt|;
DECL|field|eventRecorder
specifier|protected
name|EventRecorder
name|eventRecorder
decl_stmt|;
DECL|field|server
specifier|protected
name|GerritServer
name|server
decl_stmt|;
DECL|field|project
specifier|protected
name|Project
operator|.
name|NameKey
name|project
decl_stmt|;
DECL|field|adminRestSession
specifier|protected
name|RestSession
name|adminRestSession
decl_stmt|;
DECL|field|userRestSession
specifier|protected
name|RestSession
name|userRestSession
decl_stmt|;
DECL|field|db
specifier|protected
name|ReviewDb
name|db
decl_stmt|;
DECL|field|adminSshSession
specifier|protected
name|SshSession
name|adminSshSession
decl_stmt|;
DECL|field|userSshSession
specifier|protected
name|SshSession
name|userSshSession
decl_stmt|;
DECL|field|admin
specifier|protected
name|TestAccount
name|admin
decl_stmt|;
DECL|field|user
specifier|protected
name|TestAccount
name|user
decl_stmt|;
DECL|field|testRepo
specifier|protected
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|testRepo
decl_stmt|;
DECL|field|resourcePrefix
specifier|protected
name|String
name|resourcePrefix
decl_stmt|;
DECL|field|description
specifier|protected
name|Description
name|description
decl_stmt|;
DECL|field|testRequiresSsh
specifier|protected
name|boolean
name|testRequiresSsh
decl_stmt|;
DECL|field|testSysModule
specifier|protected
name|Module
name|testSysModule
decl_stmt|;
DECL|field|changeIndexes
annotation|@
name|Inject
specifier|private
name|ChangeIndexCollection
name|changeIndexes
decl_stmt|;
DECL|field|eventRecorderFactory
annotation|@
name|Inject
specifier|private
name|EventRecorder
operator|.
name|Factory
name|eventRecorderFactory
decl_stmt|;
DECL|field|inProcessProtocol
annotation|@
name|Inject
specifier|private
name|InProcessProtocol
name|inProcessProtocol
decl_stmt|;
DECL|field|anonymousUser
annotation|@
name|Inject
specifier|private
name|Provider
argument_list|<
name|AnonymousUser
argument_list|>
name|anonymousUser
decl_stmt|;
DECL|field|reviewDbProvider
annotation|@
name|Inject
specifier|private
name|SchemaFactory
argument_list|<
name|ReviewDb
argument_list|>
name|reviewDbProvider
decl_stmt|;
DECL|field|groups
annotation|@
name|Inject
specifier|private
name|Groups
name|groups
decl_stmt|;
DECL|field|toClose
specifier|private
name|List
argument_list|<
name|Repository
argument_list|>
name|toClose
decl_stmt|;
annotation|@
name|Before
DECL|method|clearSender ()
specifier|public
name|void
name|clearSender
parameter_list|()
block|{
name|sender
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Before
DECL|method|startEventRecorder ()
specifier|public
name|void
name|startEventRecorder
parameter_list|()
block|{
name|eventRecorder
operator|=
name|eventRecorderFactory
operator|.
name|create
argument_list|(
name|admin
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Before
DECL|method|assumeSshIfRequired ()
specifier|public
name|void
name|assumeSshIfRequired
parameter_list|()
block|{
if|if
condition|(
name|testRequiresSsh
condition|)
block|{
comment|// If the test uses ssh, we use assume() to make sure ssh is enabled on
comment|// the test suite. JUnit will skip tests annotated with @UseSsh if we
comment|// disable them using the command line flag.
name|assume
argument_list|()
operator|.
name|that
argument_list|(
name|SshMode
operator|.
name|useSsh
argument_list|()
argument_list|)
operator|.
name|isTrue
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|After
DECL|method|closeEventRecorder ()
specifier|public
name|void
name|closeEventRecorder
parameter_list|()
block|{
name|eventRecorder
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
annotation|@
name|AfterClass
DECL|method|stopCommonServer ()
specifier|public
specifier|static
name|void
name|stopCommonServer
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|commonServer
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|commonServer
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
throw|throw
operator|new
name|AssertionError
argument_list|(
literal|"Error stopping common server in "
operator|+
operator|(
name|firstTest
operator|!=
literal|null
condition|?
name|firstTest
operator|.
name|getTestClass
argument_list|()
operator|.
name|getName
argument_list|()
else|:
literal|"unknown test class"
operator|)
argument_list|,
name|t
argument_list|)
throw|;
block|}
finally|finally
block|{
name|commonServer
operator|=
literal|null
expr_stmt|;
block|}
block|}
name|TempFileUtil
operator|.
name|cleanup
argument_list|()
expr_stmt|;
block|}
DECL|method|submitWholeTopicEnabledConfig ()
specifier|protected
specifier|static
name|Config
name|submitWholeTopicEnabledConfig
parameter_list|()
block|{
name|Config
name|cfg
init|=
operator|new
name|Config
argument_list|()
decl_stmt|;
name|cfg
operator|.
name|setBoolean
argument_list|(
literal|"change"
argument_list|,
literal|null
argument_list|,
literal|"submitWholeTopic"
argument_list|,
literal|true
argument_list|)
expr_stmt|;
return|return
name|cfg
return|;
block|}
DECL|method|isSubmitWholeTopicEnabled ()
specifier|protected
name|boolean
name|isSubmitWholeTopicEnabled
parameter_list|()
block|{
return|return
name|cfg
operator|.
name|getBoolean
argument_list|(
literal|"change"
argument_list|,
literal|null
argument_list|,
literal|"submitWholeTopic"
argument_list|,
literal|false
argument_list|)
return|;
block|}
DECL|method|isContributorAgreementsEnabled ()
specifier|protected
name|boolean
name|isContributorAgreementsEnabled
parameter_list|()
block|{
return|return
name|cfg
operator|.
name|getBoolean
argument_list|(
literal|"auth"
argument_list|,
literal|null
argument_list|,
literal|"contributorAgreements"
argument_list|,
literal|false
argument_list|)
return|;
block|}
DECL|method|beforeTest (Description description)
specifier|protected
name|void
name|beforeTest
parameter_list|(
name|Description
name|description
parameter_list|)
throws|throws
name|Exception
block|{
name|this
operator|.
name|description
operator|=
name|description
expr_stmt|;
name|GerritServer
operator|.
name|Description
name|classDesc
init|=
name|GerritServer
operator|.
name|Description
operator|.
name|forTestClass
argument_list|(
name|description
argument_list|,
name|configName
argument_list|)
decl_stmt|;
name|GerritServer
operator|.
name|Description
name|methodDesc
init|=
name|GerritServer
operator|.
name|Description
operator|.
name|forTestMethod
argument_list|(
name|description
argument_list|,
name|configName
argument_list|)
decl_stmt|;
name|baseConfig
operator|.
name|setInt
argument_list|(
literal|"receive"
argument_list|,
literal|null
argument_list|,
literal|"changeUpdateThreads"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|classDesc
operator|.
name|equals
argument_list|(
name|methodDesc
argument_list|)
operator|&&
operator|!
name|classDesc
operator|.
name|sandboxed
argument_list|()
operator|&&
operator|!
name|methodDesc
operator|.
name|sandboxed
argument_list|()
condition|)
block|{
if|if
condition|(
name|commonServer
operator|==
literal|null
condition|)
block|{
name|commonServer
operator|=
name|GerritServer
operator|.
name|initAndStart
argument_list|(
name|classDesc
argument_list|,
name|baseConfig
argument_list|,
name|testSysModule
argument_list|)
expr_stmt|;
block|}
name|server
operator|=
name|commonServer
expr_stmt|;
block|}
else|else
block|{
name|server
operator|=
name|GerritServer
operator|.
name|initAndStart
argument_list|(
name|methodDesc
argument_list|,
name|baseConfig
argument_list|,
name|testSysModule
argument_list|)
expr_stmt|;
block|}
name|server
operator|.
name|getTestInjector
argument_list|()
operator|.
name|injectMembers
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|Transport
operator|.
name|register
argument_list|(
name|inProcessProtocol
argument_list|)
expr_stmt|;
name|toClose
operator|=
name|Collections
operator|.
name|synchronizedList
argument_list|(
operator|new
name|ArrayList
argument_list|<
name|Repository
argument_list|>
argument_list|()
argument_list|)
expr_stmt|;
name|db
operator|=
name|reviewDbProvider
operator|.
name|open
argument_list|()
expr_stmt|;
comment|// All groups which were added during the server start (e.g. in SchemaCreator) aren't contained
comment|// in the instance of the group index which is available here and in tests. There are two
comment|// reasons:
comment|// 1) No group index is available in SchemaCreator when using an in-memory database. (This could
comment|// be fixed by using the IndexManagerOnInit in InMemoryDatabase similar as BaseInit uses it.)
comment|// 2) During the on-init part of the server start, we use another instance of the index than
comment|// later on. As test indexes are non-permanent, closing an instance and opening another one
comment|// removes all indexed data.
comment|// As a workaround, we simply reindex all available groups here.
name|Iterable
argument_list|<
name|AccountGroup
argument_list|>
name|allGroups
init|=
name|groups
operator|.
name|getAll
argument_list|(
name|db
argument_list|)
operator|::
name|iterator
decl_stmt|;
for|for
control|(
name|AccountGroup
name|group
range|:
name|allGroups
control|)
block|{
name|groupCache
operator|.
name|evict
argument_list|(
name|group
operator|.
name|getGroupUUID
argument_list|()
argument_list|,
name|group
operator|.
name|getId
argument_list|()
argument_list|,
name|group
operator|.
name|getNameKey
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|admin
operator|=
name|accountCreator
operator|.
name|admin
argument_list|()
expr_stmt|;
name|user
operator|=
name|accountCreator
operator|.
name|user
argument_list|()
expr_stmt|;
comment|// Evict cached user state in case tests modify it.
name|accountCache
operator|.
name|evict
argument_list|(
name|admin
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|accountCache
operator|.
name|evict
argument_list|(
name|user
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|adminRestSession
operator|=
operator|new
name|RestSession
argument_list|(
name|server
argument_list|,
name|admin
argument_list|)
expr_stmt|;
name|userRestSession
operator|=
operator|new
name|RestSession
argument_list|(
name|server
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|testRequiresSsh
operator|=
name|classDesc
operator|.
name|useSshAnnotation
argument_list|()
operator|||
name|methodDesc
operator|.
name|useSshAnnotation
argument_list|()
expr_stmt|;
if|if
condition|(
name|testRequiresSsh
operator|&&
name|SshMode
operator|.
name|useSsh
argument_list|()
operator|&&
operator|(
name|adminSshSession
operator|==
literal|null
operator|||
name|userSshSession
operator|==
literal|null
operator|)
condition|)
block|{
comment|// Create Ssh sessions
name|initSsh
argument_list|(
name|admin
argument_list|)
expr_stmt|;
name|Context
name|ctx
init|=
name|newRequestContext
argument_list|(
name|user
argument_list|)
decl_stmt|;
name|atrScope
operator|.
name|set
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|userSshSession
operator|=
name|ctx
operator|.
name|getSession
argument_list|()
expr_stmt|;
name|userSshSession
operator|.
name|open
argument_list|()
expr_stmt|;
name|ctx
operator|=
name|newRequestContext
argument_list|(
name|admin
argument_list|)
expr_stmt|;
name|atrScope
operator|.
name|set
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|adminSshSession
operator|=
name|ctx
operator|.
name|getSession
argument_list|()
expr_stmt|;
name|adminSshSession
operator|.
name|open
argument_list|()
expr_stmt|;
block|}
name|resourcePrefix
operator|=
name|UNSAFE_PROJECT_NAME
operator|.
name|matcher
argument_list|(
name|description
operator|.
name|getClassName
argument_list|()
operator|+
literal|"_"
operator|+
name|description
operator|.
name|getMethodName
argument_list|()
operator|+
literal|"_"
argument_list|)
operator|.
name|replaceAll
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|Context
name|ctx
init|=
name|newRequestContext
argument_list|(
name|admin
argument_list|)
decl_stmt|;
name|atrScope
operator|.
name|set
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|project
operator|=
name|createProject
argument_list|(
name|projectInput
argument_list|(
name|description
argument_list|)
argument_list|)
expr_stmt|;
name|testRepo
operator|=
name|cloneProject
argument_list|(
name|project
argument_list|,
name|getCloneAsAccount
argument_list|(
name|description
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|getCloneAsAccount (Description description)
specifier|private
name|TestAccount
name|getCloneAsAccount
parameter_list|(
name|Description
name|description
parameter_list|)
block|{
name|TestProjectInput
name|ann
init|=
name|description
operator|.
name|getAnnotation
argument_list|(
name|TestProjectInput
operator|.
name|class
argument_list|)
decl_stmt|;
return|return
name|accountCreator
operator|.
name|get
argument_list|(
name|ann
operator|!=
literal|null
condition|?
name|ann
operator|.
name|cloneAs
argument_list|()
else|:
literal|"admin"
argument_list|)
return|;
block|}
DECL|method|projectInput (Description description)
specifier|private
name|ProjectInput
name|projectInput
parameter_list|(
name|Description
name|description
parameter_list|)
block|{
name|ProjectInput
name|in
init|=
operator|new
name|ProjectInput
argument_list|()
decl_stmt|;
name|TestProjectInput
name|ann
init|=
name|description
operator|.
name|getAnnotation
argument_list|(
name|TestProjectInput
operator|.
name|class
argument_list|)
decl_stmt|;
name|in
operator|.
name|name
operator|=
name|name
argument_list|(
literal|"project"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ann
operator|!=
literal|null
condition|)
block|{
name|in
operator|.
name|parent
operator|=
name|Strings
operator|.
name|emptyToNull
argument_list|(
name|ann
operator|.
name|parent
argument_list|()
argument_list|)
expr_stmt|;
name|in
operator|.
name|description
operator|=
name|Strings
operator|.
name|emptyToNull
argument_list|(
name|ann
operator|.
name|description
argument_list|()
argument_list|)
expr_stmt|;
name|in
operator|.
name|createEmptyCommit
operator|=
name|ann
operator|.
name|createEmptyCommit
argument_list|()
expr_stmt|;
name|in
operator|.
name|submitType
operator|=
name|ann
operator|.
name|submitType
argument_list|()
expr_stmt|;
name|in
operator|.
name|useContentMerge
operator|=
name|ann
operator|.
name|useContributorAgreements
argument_list|()
expr_stmt|;
name|in
operator|.
name|useSignedOffBy
operator|=
name|ann
operator|.
name|useSignedOffBy
argument_list|()
expr_stmt|;
name|in
operator|.
name|useContentMerge
operator|=
name|ann
operator|.
name|useContentMerge
argument_list|()
expr_stmt|;
name|in
operator|.
name|enableSignedPush
operator|=
name|ann
operator|.
name|enableSignedPush
argument_list|()
expr_stmt|;
name|in
operator|.
name|requireSignedPush
operator|=
name|ann
operator|.
name|requireSignedPush
argument_list|()
expr_stmt|;
block|}
else|else
block|{
comment|// Defaults should match TestProjectConfig, omitting nullable values.
name|in
operator|.
name|createEmptyCommit
operator|=
literal|true
expr_stmt|;
block|}
name|updateProjectInput
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
name|in
return|;
block|}
DECL|field|UNSAFE_PROJECT_NAME
specifier|private
specifier|static
specifier|final
name|Pattern
name|UNSAFE_PROJECT_NAME
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"[^a-zA-Z0-9._/-]+"
argument_list|)
decl_stmt|;
DECL|method|git ()
specifier|protected
name|Git
name|git
parameter_list|()
block|{
return|return
name|testRepo
operator|.
name|git
argument_list|()
return|;
block|}
DECL|method|repo ()
specifier|protected
name|InMemoryRepository
name|repo
parameter_list|()
block|{
return|return
name|testRepo
operator|.
name|getRepository
argument_list|()
return|;
block|}
comment|/**    * Return a resource name scoped to this test method.    *    *<p>Test methods in a single class by default share a running server. For any resource name you    * require to be unique to a test method, wrap it in a call to this method.    *    * @param name resource name (group, project, topic, etc.)    * @return name prefixed by a string unique to this test method.    */
DECL|method|name (String name)
specifier|protected
name|String
name|name
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|resourcePrefix
operator|+
name|name
return|;
block|}
DECL|method|createProject (String nameSuffix)
specifier|protected
name|Project
operator|.
name|NameKey
name|createProject
parameter_list|(
name|String
name|nameSuffix
parameter_list|)
throws|throws
name|RestApiException
block|{
return|return
name|createProject
argument_list|(
name|nameSuffix
argument_list|,
literal|null
argument_list|)
return|;
block|}
DECL|method|createProject (String nameSuffix, Project.NameKey parent)
specifier|protected
name|Project
operator|.
name|NameKey
name|createProject
parameter_list|(
name|String
name|nameSuffix
parameter_list|,
name|Project
operator|.
name|NameKey
name|parent
parameter_list|)
throws|throws
name|RestApiException
block|{
comment|// Default for createEmptyCommit should match TestProjectConfig.
return|return
name|createProject
argument_list|(
name|nameSuffix
argument_list|,
name|parent
argument_list|,
literal|true
argument_list|,
literal|null
argument_list|)
return|;
block|}
DECL|method|createProject ( String nameSuffix, Project.NameKey parent, boolean createEmptyCommit)
specifier|protected
name|Project
operator|.
name|NameKey
name|createProject
parameter_list|(
name|String
name|nameSuffix
parameter_list|,
name|Project
operator|.
name|NameKey
name|parent
parameter_list|,
name|boolean
name|createEmptyCommit
parameter_list|)
throws|throws
name|RestApiException
block|{
comment|// Default for createEmptyCommit should match TestProjectConfig.
return|return
name|createProject
argument_list|(
name|nameSuffix
argument_list|,
name|parent
argument_list|,
name|createEmptyCommit
argument_list|,
literal|null
argument_list|)
return|;
block|}
DECL|method|createProject ( String nameSuffix, Project.NameKey parent, SubmitType submitType)
specifier|protected
name|Project
operator|.
name|NameKey
name|createProject
parameter_list|(
name|String
name|nameSuffix
parameter_list|,
name|Project
operator|.
name|NameKey
name|parent
parameter_list|,
name|SubmitType
name|submitType
parameter_list|)
throws|throws
name|RestApiException
block|{
comment|// Default for createEmptyCommit should match TestProjectConfig.
return|return
name|createProject
argument_list|(
name|nameSuffix
argument_list|,
name|parent
argument_list|,
literal|true
argument_list|,
name|submitType
argument_list|)
return|;
block|}
DECL|method|createProject ( String nameSuffix, Project.NameKey parent, boolean createEmptyCommit, SubmitType submitType)
specifier|protected
name|Project
operator|.
name|NameKey
name|createProject
parameter_list|(
name|String
name|nameSuffix
parameter_list|,
name|Project
operator|.
name|NameKey
name|parent
parameter_list|,
name|boolean
name|createEmptyCommit
parameter_list|,
name|SubmitType
name|submitType
parameter_list|)
throws|throws
name|RestApiException
block|{
name|ProjectInput
name|in
init|=
operator|new
name|ProjectInput
argument_list|()
decl_stmt|;
name|in
operator|.
name|name
operator|=
name|name
argument_list|(
name|nameSuffix
argument_list|)
expr_stmt|;
name|in
operator|.
name|parent
operator|=
name|parent
operator|!=
literal|null
condition|?
name|parent
operator|.
name|get
argument_list|()
else|:
literal|null
expr_stmt|;
name|in
operator|.
name|submitType
operator|=
name|submitType
expr_stmt|;
name|in
operator|.
name|createEmptyCommit
operator|=
name|createEmptyCommit
expr_stmt|;
return|return
name|createProject
argument_list|(
name|in
argument_list|)
return|;
block|}
DECL|method|createProject (ProjectInput in)
specifier|private
name|Project
operator|.
name|NameKey
name|createProject
parameter_list|(
name|ProjectInput
name|in
parameter_list|)
throws|throws
name|RestApiException
block|{
name|gApi
operator|.
name|projects
argument_list|()
operator|.
name|create
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
operator|new
name|Project
operator|.
name|NameKey
argument_list|(
name|in
operator|.
name|name
argument_list|)
return|;
block|}
comment|/**    * Modify a project input before creating the initial test project.    *    * @param in input; may be modified in place.    */
DECL|method|updateProjectInput (ProjectInput in)
specifier|protected
name|void
name|updateProjectInput
parameter_list|(
name|ProjectInput
name|in
parameter_list|)
block|{
comment|// Default implementation does nothing.
block|}
DECL|method|cloneProject (Project.NameKey p)
specifier|protected
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|cloneProject
parameter_list|(
name|Project
operator|.
name|NameKey
name|p
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|cloneProject
argument_list|(
name|p
argument_list|,
name|admin
argument_list|)
return|;
block|}
DECL|method|cloneProject ( Project.NameKey p, TestAccount testAccount)
specifier|protected
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|cloneProject
parameter_list|(
name|Project
operator|.
name|NameKey
name|p
parameter_list|,
name|TestAccount
name|testAccount
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|GitUtil
operator|.
name|cloneProject
argument_list|(
name|p
argument_list|,
name|registerRepoConnection
argument_list|(
name|p
argument_list|,
name|testAccount
argument_list|)
argument_list|)
return|;
block|}
comment|/**    * Register a repository connection over the test protocol.    *    * @return a URI string that can be used to connect to this repository for both fetch and push.    */
DECL|method|registerRepoConnection (Project.NameKey p, TestAccount testAccount)
specifier|protected
name|String
name|registerRepoConnection
parameter_list|(
name|Project
operator|.
name|NameKey
name|p
parameter_list|,
name|TestAccount
name|testAccount
parameter_list|)
throws|throws
name|Exception
block|{
name|InProcessProtocol
operator|.
name|Context
name|ctx
init|=
operator|new
name|InProcessProtocol
operator|.
name|Context
argument_list|(
name|reviewDbProvider
argument_list|,
name|identifiedUserFactory
argument_list|,
name|testAccount
operator|.
name|getId
argument_list|()
argument_list|,
name|p
argument_list|)
decl_stmt|;
name|Repository
name|repo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|p
argument_list|)
decl_stmt|;
name|toClose
operator|.
name|add
argument_list|(
name|repo
argument_list|)
expr_stmt|;
return|return
name|inProcessProtocol
operator|.
name|register
argument_list|(
name|ctx
argument_list|,
name|repo
argument_list|)
operator|.
name|toString
argument_list|()
return|;
block|}
DECL|method|afterTest ()
specifier|protected
name|void
name|afterTest
parameter_list|()
throws|throws
name|Exception
block|{
name|Transport
operator|.
name|unregister
argument_list|(
name|inProcessProtocol
argument_list|)
expr_stmt|;
for|for
control|(
name|Repository
name|repo
range|:
name|toClose
control|)
block|{
name|repo
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
name|db
operator|.
name|close
argument_list|()
expr_stmt|;
if|if
condition|(
name|adminSshSession
operator|!=
literal|null
condition|)
block|{
name|adminSshSession
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|userSshSession
operator|!=
literal|null
condition|)
block|{
name|userSshSession
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|server
operator|!=
name|commonServer
condition|)
block|{
name|server
operator|.
name|close
argument_list|()
expr_stmt|;
name|server
operator|=
literal|null
expr_stmt|;
block|}
name|NoteDbMode
operator|.
name|resetFromEnv
argument_list|(
name|notesMigration
argument_list|)
expr_stmt|;
block|}
DECL|method|commitBuilder ()
specifier|protected
name|TestRepository
argument_list|<
name|?
argument_list|>
operator|.
name|CommitBuilder
name|commitBuilder
parameter_list|()
throws|throws
name|Exception
block|{
return|return
name|testRepo
operator|.
name|branch
argument_list|(
literal|"HEAD"
argument_list|)
operator|.
name|commit
argument_list|()
operator|.
name|insertChangeId
argument_list|()
return|;
block|}
DECL|method|amendBuilder ()
specifier|protected
name|TestRepository
argument_list|<
name|?
argument_list|>
operator|.
name|CommitBuilder
name|amendBuilder
parameter_list|()
throws|throws
name|Exception
block|{
name|ObjectId
name|head
init|=
name|repo
argument_list|()
operator|.
name|exactRef
argument_list|(
literal|"HEAD"
argument_list|)
operator|.
name|getObjectId
argument_list|()
decl_stmt|;
name|TestRepository
argument_list|<
name|?
argument_list|>
operator|.
name|CommitBuilder
name|b
init|=
name|testRepo
operator|.
name|amendRef
argument_list|(
literal|"HEAD"
argument_list|)
decl_stmt|;
name|Optional
argument_list|<
name|String
argument_list|>
name|id
init|=
name|GitUtil
operator|.
name|getChangeId
argument_list|(
name|testRepo
argument_list|,
name|head
argument_list|)
decl_stmt|;
comment|// TestRepository behaves like "git commit --amend -m foo", which does not
comment|// preserve an existing Change-Id. Tests probably want this.
if|if
condition|(
name|id
operator|.
name|isPresent
argument_list|()
condition|)
block|{
name|b
operator|.
name|insertChangeId
argument_list|(
name|id
operator|.
name|get
argument_list|()
operator|.
name|substring
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|b
operator|.
name|insertChangeId
argument_list|()
expr_stmt|;
block|}
return|return
name|b
return|;
block|}
DECL|method|createChange ()
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|createChange
parameter_list|()
throws|throws
name|Exception
block|{
return|return
name|createChange
argument_list|(
literal|"refs/for/master"
argument_list|)
return|;
block|}
DECL|method|createChange (String ref)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|createChange
parameter_list|(
name|String
name|ref
parameter_list|)
throws|throws
name|Exception
block|{
name|PushOneCommit
name|push
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|admin
operator|.
name|getIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|)
decl_stmt|;
name|PushOneCommit
operator|.
name|Result
name|result
init|=
name|push
operator|.
name|to
argument_list|(
name|ref
argument_list|)
decl_stmt|;
name|result
operator|.
name|assertOkStatus
argument_list|()
expr_stmt|;
return|return
name|result
return|;
block|}
DECL|method|createMergeCommitChange (String ref)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|createMergeCommitChange
parameter_list|(
name|String
name|ref
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|createMergeCommitChange
argument_list|(
name|ref
argument_list|,
literal|"foo"
argument_list|)
return|;
block|}
DECL|method|createMergeCommitChange (String ref, String file)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|createMergeCommitChange
parameter_list|(
name|String
name|ref
parameter_list|,
name|String
name|file
parameter_list|)
throws|throws
name|Exception
block|{
name|ObjectId
name|initial
init|=
name|repo
argument_list|()
operator|.
name|exactRef
argument_list|(
name|HEAD
argument_list|)
operator|.
name|getLeaf
argument_list|()
operator|.
name|getObjectId
argument_list|()
decl_stmt|;
name|PushOneCommit
operator|.
name|Result
name|p1
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|admin
operator|.
name|getIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|,
literal|"parent 1"
argument_list|,
name|ImmutableMap
operator|.
name|of
argument_list|(
name|file
argument_list|,
literal|"foo-1"
argument_list|,
literal|"bar"
argument_list|,
literal|"bar-1"
argument_list|)
argument_list|)
operator|.
name|to
argument_list|(
name|ref
argument_list|)
decl_stmt|;
comment|// reset HEAD in order to create a sibling of the first change
name|testRepo
operator|.
name|reset
argument_list|(
name|initial
argument_list|)
expr_stmt|;
name|PushOneCommit
operator|.
name|Result
name|p2
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|admin
operator|.
name|getIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|,
literal|"parent 2"
argument_list|,
name|ImmutableMap
operator|.
name|of
argument_list|(
name|file
argument_list|,
literal|"foo-2"
argument_list|,
literal|"bar"
argument_list|,
literal|"bar-2"
argument_list|)
argument_list|)
operator|.
name|to
argument_list|(
name|ref
argument_list|)
decl_stmt|;
name|PushOneCommit
name|m
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|admin
operator|.
name|getIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|,
literal|"merge"
argument_list|,
name|ImmutableMap
operator|.
name|of
argument_list|(
name|file
argument_list|,
literal|"foo-1"
argument_list|,
literal|"bar"
argument_list|,
literal|"bar-2"
argument_list|)
argument_list|)
decl_stmt|;
name|m
operator|.
name|setParents
argument_list|(
name|ImmutableList
operator|.
name|of
argument_list|(
name|p1
operator|.
name|getCommit
argument_list|()
argument_list|,
name|p2
operator|.
name|getCommit
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|PushOneCommit
operator|.
name|Result
name|result
init|=
name|m
operator|.
name|to
argument_list|(
name|ref
argument_list|)
decl_stmt|;
name|result
operator|.
name|assertOkStatus
argument_list|()
expr_stmt|;
return|return
name|result
return|;
block|}
DECL|method|createCommitAndPush ( TestRepository<InMemoryRepository> repo, String ref, String commitMsg, String fileName, String content)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|createCommitAndPush
parameter_list|(
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|repo
parameter_list|,
name|String
name|ref
parameter_list|,
name|String
name|commitMsg
parameter_list|,
name|String
name|fileName
parameter_list|,
name|String
name|content
parameter_list|)
throws|throws
name|Exception
block|{
name|PushOneCommit
operator|.
name|Result
name|result
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|admin
operator|.
name|getIdent
argument_list|()
argument_list|,
name|repo
argument_list|,
name|commitMsg
argument_list|,
name|fileName
argument_list|,
name|content
argument_list|)
operator|.
name|to
argument_list|(
name|ref
argument_list|)
decl_stmt|;
name|result
operator|.
name|assertOkStatus
argument_list|()
expr_stmt|;
return|return
name|result
return|;
block|}
DECL|method|createChangeWithTopic ()
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|createChangeWithTopic
parameter_list|()
throws|throws
name|Exception
block|{
return|return
name|createChangeWithTopic
argument_list|(
name|testRepo
argument_list|,
literal|"topic"
argument_list|,
literal|"message"
argument_list|,
literal|"a.txt"
argument_list|,
literal|"content\n"
argument_list|)
return|;
block|}
DECL|method|createChangeWithTopic ( TestRepository<InMemoryRepository> repo, String topic, String commitMsg, String fileName, String content)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|createChangeWithTopic
parameter_list|(
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|repo
parameter_list|,
name|String
name|topic
parameter_list|,
name|String
name|commitMsg
parameter_list|,
name|String
name|fileName
parameter_list|,
name|String
name|content
parameter_list|)
throws|throws
name|Exception
block|{
name|assertThat
argument_list|(
name|topic
argument_list|)
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
return|return
name|createCommitAndPush
argument_list|(
name|repo
argument_list|,
literal|"refs/for/master/"
operator|+
name|name
argument_list|(
name|topic
argument_list|)
argument_list|,
name|commitMsg
argument_list|,
name|fileName
argument_list|,
name|content
argument_list|)
return|;
block|}
DECL|method|createWorkInProgressChange ()
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|createWorkInProgressChange
parameter_list|()
throws|throws
name|Exception
block|{
return|return
name|pushTo
argument_list|(
literal|"refs/for/master%wip"
argument_list|)
return|;
block|}
DECL|method|createChange (String subject, String fileName, String content)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|createChange
parameter_list|(
name|String
name|subject
parameter_list|,
name|String
name|fileName
parameter_list|,
name|String
name|content
parameter_list|)
throws|throws
name|Exception
block|{
name|PushOneCommit
name|push
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|admin
operator|.
name|getIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|,
name|subject
argument_list|,
name|fileName
argument_list|,
name|content
argument_list|)
decl_stmt|;
return|return
name|push
operator|.
name|to
argument_list|(
literal|"refs/for/master"
argument_list|)
return|;
block|}
DECL|method|createChange ( String subject, String fileName, String content, String topic)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|createChange
parameter_list|(
name|String
name|subject
parameter_list|,
name|String
name|fileName
parameter_list|,
name|String
name|content
parameter_list|,
name|String
name|topic
parameter_list|)
throws|throws
name|Exception
block|{
name|PushOneCommit
name|push
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|admin
operator|.
name|getIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|,
name|subject
argument_list|,
name|fileName
argument_list|,
name|content
argument_list|)
decl_stmt|;
return|return
name|push
operator|.
name|to
argument_list|(
literal|"refs/for/master/"
operator|+
name|name
argument_list|(
name|topic
argument_list|)
argument_list|)
return|;
block|}
DECL|method|createChange ( TestRepository<?> repo, String branch, String subject, String fileName, String content, String topic)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|createChange
parameter_list|(
name|TestRepository
argument_list|<
name|?
argument_list|>
name|repo
parameter_list|,
name|String
name|branch
parameter_list|,
name|String
name|subject
parameter_list|,
name|String
name|fileName
parameter_list|,
name|String
name|content
parameter_list|,
name|String
name|topic
parameter_list|)
throws|throws
name|Exception
block|{
name|PushOneCommit
name|push
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|admin
operator|.
name|getIdent
argument_list|()
argument_list|,
name|repo
argument_list|,
name|subject
argument_list|,
name|fileName
argument_list|,
name|content
argument_list|)
decl_stmt|;
return|return
name|push
operator|.
name|to
argument_list|(
literal|"refs/for/"
operator|+
name|branch
operator|+
literal|"/"
operator|+
name|name
argument_list|(
name|topic
argument_list|)
argument_list|)
return|;
block|}
DECL|method|createBranch (Branch.NameKey branch)
specifier|protected
name|BranchApi
name|createBranch
parameter_list|(
name|Branch
operator|.
name|NameKey
name|branch
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|gApi
operator|.
name|projects
argument_list|()
operator|.
name|name
argument_list|(
name|branch
operator|.
name|getParentKey
argument_list|()
operator|.
name|get
argument_list|()
argument_list|)
operator|.
name|branch
argument_list|(
name|branch
operator|.
name|get
argument_list|()
argument_list|)
operator|.
name|create
argument_list|(
operator|new
name|BranchInput
argument_list|()
argument_list|)
return|;
block|}
DECL|method|createBranchWithRevision (Branch.NameKey branch, String revision)
specifier|protected
name|BranchApi
name|createBranchWithRevision
parameter_list|(
name|Branch
operator|.
name|NameKey
name|branch
parameter_list|,
name|String
name|revision
parameter_list|)
throws|throws
name|Exception
block|{
name|BranchInput
name|in
init|=
operator|new
name|BranchInput
argument_list|()
decl_stmt|;
name|in
operator|.
name|revision
operator|=
name|revision
expr_stmt|;
return|return
name|gApi
operator|.
name|projects
argument_list|()
operator|.
name|name
argument_list|(
name|branch
operator|.
name|getParentKey
argument_list|()
operator|.
name|get
argument_list|()
argument_list|)
operator|.
name|branch
argument_list|(
name|branch
operator|.
name|get
argument_list|()
argument_list|)
operator|.
name|create
argument_list|(
name|in
argument_list|)
return|;
block|}
DECL|field|RANDOM
specifier|private
specifier|static
specifier|final
name|List
argument_list|<
name|Character
argument_list|>
name|RANDOM
init|=
name|Chars
operator|.
name|asList
argument_list|(
operator|new
name|char
index|[]
block|{
literal|'a'
block|,
literal|'b'
block|,
literal|'c'
block|,
literal|'d'
block|,
literal|'e'
block|,
literal|'f'
block|,
literal|'g'
block|,
literal|'h'
block|}
argument_list|)
decl_stmt|;
DECL|method|amendChange (String changeId)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|amendChange
parameter_list|(
name|String
name|changeId
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|amendChange
argument_list|(
name|changeId
argument_list|,
literal|"refs/for/master"
argument_list|)
return|;
block|}
DECL|method|amendChange (String changeId, String ref)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|amendChange
parameter_list|(
name|String
name|changeId
parameter_list|,
name|String
name|ref
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|amendChange
argument_list|(
name|changeId
argument_list|,
name|ref
argument_list|,
name|admin
argument_list|,
name|testRepo
argument_list|)
return|;
block|}
DECL|method|amendChange ( String changeId, String ref, TestAccount testAccount, TestRepository<?> repo)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|amendChange
parameter_list|(
name|String
name|changeId
parameter_list|,
name|String
name|ref
parameter_list|,
name|TestAccount
name|testAccount
parameter_list|,
name|TestRepository
argument_list|<
name|?
argument_list|>
name|repo
parameter_list|)
throws|throws
name|Exception
block|{
name|Collections
operator|.
name|shuffle
argument_list|(
name|RANDOM
argument_list|)
expr_stmt|;
return|return
name|amendChange
argument_list|(
name|changeId
argument_list|,
name|ref
argument_list|,
name|testAccount
argument_list|,
name|repo
argument_list|,
name|PushOneCommit
operator|.
name|SUBJECT
argument_list|,
name|PushOneCommit
operator|.
name|FILE_NAME
argument_list|,
operator|new
name|String
argument_list|(
name|Chars
operator|.
name|toArray
argument_list|(
name|RANDOM
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
DECL|method|amendChange ( String changeId, String subject, String fileName, String content)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|amendChange
parameter_list|(
name|String
name|changeId
parameter_list|,
name|String
name|subject
parameter_list|,
name|String
name|fileName
parameter_list|,
name|String
name|content
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|amendChange
argument_list|(
name|changeId
argument_list|,
literal|"refs/for/master"
argument_list|,
name|admin
argument_list|,
name|testRepo
argument_list|,
name|subject
argument_list|,
name|fileName
argument_list|,
name|content
argument_list|)
return|;
block|}
DECL|method|amendChange ( String changeId, String ref, TestAccount testAccount, TestRepository<?> repo, String subject, String fileName, String content)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|amendChange
parameter_list|(
name|String
name|changeId
parameter_list|,
name|String
name|ref
parameter_list|,
name|TestAccount
name|testAccount
parameter_list|,
name|TestRepository
argument_list|<
name|?
argument_list|>
name|repo
parameter_list|,
name|String
name|subject
parameter_list|,
name|String
name|fileName
parameter_list|,
name|String
name|content
parameter_list|)
throws|throws
name|Exception
block|{
name|PushOneCommit
name|push
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|testAccount
operator|.
name|getIdent
argument_list|()
argument_list|,
name|repo
argument_list|,
name|subject
argument_list|,
name|fileName
argument_list|,
name|content
argument_list|,
name|changeId
argument_list|)
decl_stmt|;
return|return
name|push
operator|.
name|to
argument_list|(
name|ref
argument_list|)
return|;
block|}
DECL|method|merge (PushOneCommit.Result r)
specifier|protected
name|void
name|merge
parameter_list|(
name|PushOneCommit
operator|.
name|Result
name|r
parameter_list|)
throws|throws
name|Exception
block|{
name|revision
argument_list|(
name|r
argument_list|)
operator|.
name|review
argument_list|(
name|ReviewInput
operator|.
name|approve
argument_list|()
argument_list|)
expr_stmt|;
name|revision
argument_list|(
name|r
argument_list|)
operator|.
name|submit
argument_list|()
expr_stmt|;
block|}
DECL|method|info (String id)
specifier|protected
name|ChangeInfo
name|info
parameter_list|(
name|String
name|id
parameter_list|)
throws|throws
name|RestApiException
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|info
argument_list|()
return|;
block|}
DECL|method|get (String id)
specifier|protected
name|ChangeInfo
name|get
parameter_list|(
name|String
name|id
parameter_list|)
throws|throws
name|RestApiException
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|get
argument_list|()
return|;
block|}
DECL|method|getEdit (String id)
specifier|protected
name|Optional
argument_list|<
name|EditInfo
argument_list|>
name|getEdit
parameter_list|(
name|String
name|id
parameter_list|)
throws|throws
name|RestApiException
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|edit
argument_list|()
operator|.
name|get
argument_list|()
return|;
block|}
DECL|method|get (String id, ListChangesOption... options)
specifier|protected
name|ChangeInfo
name|get
parameter_list|(
name|String
name|id
parameter_list|,
name|ListChangesOption
modifier|...
name|options
parameter_list|)
throws|throws
name|RestApiException
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|get
argument_list|(
name|options
argument_list|)
return|;
block|}
DECL|method|query (String q)
specifier|protected
name|List
argument_list|<
name|ChangeInfo
argument_list|>
name|query
parameter_list|(
name|String
name|q
parameter_list|)
throws|throws
name|RestApiException
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|query
argument_list|(
name|q
argument_list|)
operator|.
name|get
argument_list|()
return|;
block|}
DECL|method|newRequestContext (TestAccount account)
specifier|private
name|Context
name|newRequestContext
parameter_list|(
name|TestAccount
name|account
parameter_list|)
block|{
return|return
name|atrScope
operator|.
name|newContext
argument_list|(
name|reviewDbProvider
argument_list|,
operator|new
name|SshSession
argument_list|(
name|server
argument_list|,
name|account
argument_list|)
argument_list|,
name|identifiedUserFactory
operator|.
name|create
argument_list|(
name|account
operator|.
name|getId
argument_list|()
argument_list|)
argument_list|)
return|;
block|}
comment|/**    * Enforce a new request context for the current API user.    *    *<p>This recreates the IdentifiedUser, hence everything which is cached in the IdentifiedUser is    * reloaded (e.g. the email addresses of the user).    */
DECL|method|resetCurrentApiUser ()
specifier|protected
name|Context
name|resetCurrentApiUser
parameter_list|()
block|{
return|return
name|atrScope
operator|.
name|set
argument_list|(
name|newRequestContext
argument_list|(
name|atrScope
operator|.
name|get
argument_list|()
operator|.
name|getSession
argument_list|()
operator|.
name|getAccount
argument_list|()
argument_list|)
argument_list|)
return|;
block|}
DECL|method|setApiUser (TestAccount account)
specifier|protected
name|Context
name|setApiUser
parameter_list|(
name|TestAccount
name|account
parameter_list|)
block|{
return|return
name|atrScope
operator|.
name|set
argument_list|(
name|newRequestContext
argument_list|(
name|account
argument_list|)
argument_list|)
return|;
block|}
DECL|method|setApiUserAnonymous ()
specifier|protected
name|Context
name|setApiUserAnonymous
parameter_list|()
block|{
return|return
name|atrScope
operator|.
name|set
argument_list|(
name|atrScope
operator|.
name|newContext
argument_list|(
name|reviewDbProvider
argument_list|,
literal|null
argument_list|,
name|anonymousUser
operator|.
name|get
argument_list|()
argument_list|)
argument_list|)
return|;
block|}
DECL|method|disableDb ()
specifier|protected
name|Context
name|disableDb
parameter_list|()
block|{
name|notesMigration
operator|.
name|setFailOnLoadForTest
argument_list|(
literal|true
argument_list|)
expr_stmt|;
return|return
name|atrScope
operator|.
name|disableDb
argument_list|()
return|;
block|}
DECL|method|enableDb (Context preDisableContext)
specifier|protected
name|void
name|enableDb
parameter_list|(
name|Context
name|preDisableContext
parameter_list|)
block|{
name|notesMigration
operator|.
name|setFailOnLoadForTest
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|atrScope
operator|.
name|set
argument_list|(
name|preDisableContext
argument_list|)
expr_stmt|;
block|}
DECL|method|disableChangeIndexWrites ()
specifier|protected
name|void
name|disableChangeIndexWrites
parameter_list|()
block|{
for|for
control|(
name|ChangeIndex
name|i
range|:
name|changeIndexes
operator|.
name|getWriteIndexes
argument_list|()
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|i
operator|instanceof
name|ReadOnlyChangeIndex
operator|)
condition|)
block|{
name|changeIndexes
operator|.
name|addWriteIndex
argument_list|(
operator|new
name|ReadOnlyChangeIndex
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|enableChangeIndexWrites ()
specifier|protected
name|void
name|enableChangeIndexWrites
parameter_list|()
block|{
for|for
control|(
name|ChangeIndex
name|i
range|:
name|changeIndexes
operator|.
name|getWriteIndexes
argument_list|()
control|)
block|{
if|if
condition|(
name|i
operator|instanceof
name|ReadOnlyChangeIndex
condition|)
block|{
name|changeIndexes
operator|.
name|addWriteIndex
argument_list|(
operator|(
operator|(
name|ReadOnlyChangeIndex
operator|)
name|i
operator|)
operator|.
name|unwrap
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|newGson ()
specifier|protected
specifier|static
name|Gson
name|newGson
parameter_list|()
block|{
return|return
name|OutputFormat
operator|.
name|JSON_COMPACT
operator|.
name|newGson
argument_list|()
return|;
block|}
DECL|method|revision (PushOneCommit.Result r)
specifier|protected
name|RevisionApi
name|revision
parameter_list|(
name|PushOneCommit
operator|.
name|Result
name|r
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|r
operator|.
name|getChangeId
argument_list|()
argument_list|)
operator|.
name|current
argument_list|()
return|;
block|}
DECL|method|allow (String ref, String permission, AccountGroup.UUID id)
specifier|protected
name|void
name|allow
parameter_list|(
name|String
name|ref
parameter_list|,
name|String
name|permission
parameter_list|,
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|)
throws|throws
name|Exception
block|{
name|allow
argument_list|(
name|project
argument_list|,
name|ref
argument_list|,
name|permission
argument_list|,
name|id
argument_list|)
expr_stmt|;
block|}
DECL|method|allow (Project.NameKey p, String ref, String permission, AccountGroup.UUID id)
specifier|protected
name|void
name|allow
parameter_list|(
name|Project
operator|.
name|NameKey
name|p
parameter_list|,
name|String
name|ref
parameter_list|,
name|String
name|permission
parameter_list|,
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|p
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
name|Util
operator|.
name|allow
argument_list|(
name|cfg
argument_list|,
name|permission
argument_list|,
name|id
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|saveProjectConfig
argument_list|(
name|p
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
DECL|method|allowGlobalCapabilities (AccountGroup.UUID id, String... capabilityNames)
specifier|protected
name|void
name|allowGlobalCapabilities
parameter_list|(
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|,
name|String
modifier|...
name|capabilityNames
parameter_list|)
throws|throws
name|Exception
block|{
name|allowGlobalCapabilities
argument_list|(
name|id
argument_list|,
name|Arrays
operator|.
name|asList
argument_list|(
name|capabilityNames
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|allowGlobalCapabilities (AccountGroup.UUID id, Iterable<String> capabilityNames)
specifier|protected
name|void
name|allowGlobalCapabilities
parameter_list|(
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|,
name|Iterable
argument_list|<
name|String
argument_list|>
name|capabilityNames
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|allProjects
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|capabilityName
range|:
name|capabilityNames
control|)
block|{
name|Util
operator|.
name|allow
argument_list|(
name|cfg
argument_list|,
name|capabilityName
argument_list|,
name|id
argument_list|)
expr_stmt|;
block|}
name|saveProjectConfig
argument_list|(
name|allProjects
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
DECL|method|removeGlobalCapabilities (AccountGroup.UUID id, String... capabilityNames)
specifier|protected
name|void
name|removeGlobalCapabilities
parameter_list|(
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|,
name|String
modifier|...
name|capabilityNames
parameter_list|)
throws|throws
name|Exception
block|{
name|removeGlobalCapabilities
argument_list|(
name|id
argument_list|,
name|Arrays
operator|.
name|asList
argument_list|(
name|capabilityNames
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|removeGlobalCapabilities (AccountGroup.UUID id, Iterable<String> capabilityNames)
specifier|protected
name|void
name|removeGlobalCapabilities
parameter_list|(
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|,
name|Iterable
argument_list|<
name|String
argument_list|>
name|capabilityNames
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|allProjects
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|capabilityName
range|:
name|capabilityNames
control|)
block|{
name|Util
operator|.
name|remove
argument_list|(
name|cfg
argument_list|,
name|capabilityName
argument_list|,
name|id
argument_list|)
expr_stmt|;
block|}
name|saveProjectConfig
argument_list|(
name|allProjects
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
DECL|method|setUseContributorAgreements (InheritableBoolean value)
specifier|protected
name|void
name|setUseContributorAgreements
parameter_list|(
name|InheritableBoolean
name|value
parameter_list|)
throws|throws
name|Exception
block|{
try|try
init|(
name|MetaDataUpdate
name|md
init|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|project
argument_list|)
init|)
block|{
name|ProjectConfig
name|config
init|=
name|ProjectConfig
operator|.
name|read
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|config
operator|.
name|getProject
argument_list|()
operator|.
name|setUseContributorAgreements
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|config
operator|.
name|commit
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|projectCache
operator|.
name|evict
argument_list|(
name|config
operator|.
name|getProject
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|setUseSignedOffBy (InheritableBoolean value)
specifier|protected
name|void
name|setUseSignedOffBy
parameter_list|(
name|InheritableBoolean
name|value
parameter_list|)
throws|throws
name|Exception
block|{
try|try
init|(
name|MetaDataUpdate
name|md
init|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|project
argument_list|)
init|)
block|{
name|ProjectConfig
name|config
init|=
name|ProjectConfig
operator|.
name|read
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|config
operator|.
name|getProject
argument_list|()
operator|.
name|setUseSignedOffBy
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|config
operator|.
name|commit
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|projectCache
operator|.
name|evict
argument_list|(
name|config
operator|.
name|getProject
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|setRequireChangeId (InheritableBoolean value)
specifier|protected
name|void
name|setRequireChangeId
parameter_list|(
name|InheritableBoolean
name|value
parameter_list|)
throws|throws
name|Exception
block|{
try|try
init|(
name|MetaDataUpdate
name|md
init|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|project
argument_list|)
init|)
block|{
name|ProjectConfig
name|config
init|=
name|ProjectConfig
operator|.
name|read
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|config
operator|.
name|getProject
argument_list|()
operator|.
name|setRequireChangeID
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|config
operator|.
name|commit
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|projectCache
operator|.
name|evict
argument_list|(
name|config
operator|.
name|getProject
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|deny (String ref, String permission, AccountGroup.UUID id)
specifier|protected
name|void
name|deny
parameter_list|(
name|String
name|ref
parameter_list|,
name|String
name|permission
parameter_list|,
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|)
throws|throws
name|Exception
block|{
name|deny
argument_list|(
name|project
argument_list|,
name|ref
argument_list|,
name|permission
argument_list|,
name|id
argument_list|)
expr_stmt|;
block|}
DECL|method|deny (Project.NameKey p, String ref, String permission, AccountGroup.UUID id)
specifier|protected
name|void
name|deny
parameter_list|(
name|Project
operator|.
name|NameKey
name|p
parameter_list|,
name|String
name|ref
parameter_list|,
name|String
name|permission
parameter_list|,
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|p
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
name|Util
operator|.
name|deny
argument_list|(
name|cfg
argument_list|,
name|permission
argument_list|,
name|id
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|saveProjectConfig
argument_list|(
name|p
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
DECL|method|block (String ref, String permission, AccountGroup.UUID id)
specifier|protected
name|PermissionRule
name|block
parameter_list|(
name|String
name|ref
parameter_list|,
name|String
name|permission
parameter_list|,
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|block
argument_list|(
name|project
argument_list|,
name|ref
argument_list|,
name|permission
argument_list|,
name|id
argument_list|)
return|;
block|}
DECL|method|block ( Project.NameKey project, String ref, String permission, AccountGroup.UUID id)
specifier|protected
name|PermissionRule
name|block
parameter_list|(
name|Project
operator|.
name|NameKey
name|project
parameter_list|,
name|String
name|ref
parameter_list|,
name|String
name|permission
parameter_list|,
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|project
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
name|PermissionRule
name|rule
init|=
name|Util
operator|.
name|block
argument_list|(
name|cfg
argument_list|,
name|permission
argument_list|,
name|id
argument_list|,
name|ref
argument_list|)
decl_stmt|;
name|saveProjectConfig
argument_list|(
name|project
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
return|return
name|rule
return|;
block|}
DECL|method|blockLabel ( String label, int min, int max, AccountGroup.UUID id, String ref, Project.NameKey project)
specifier|protected
name|void
name|blockLabel
parameter_list|(
name|String
name|label
parameter_list|,
name|int
name|min
parameter_list|,
name|int
name|max
parameter_list|,
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|,
name|String
name|ref
parameter_list|,
name|Project
operator|.
name|NameKey
name|project
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|project
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
name|Util
operator|.
name|block
argument_list|(
name|cfg
argument_list|,
name|Permission
operator|.
name|LABEL
operator|+
name|label
argument_list|,
name|min
argument_list|,
name|max
argument_list|,
name|id
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|saveProjectConfig
argument_list|(
name|project
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
DECL|method|saveProjectConfig (Project.NameKey p, ProjectConfig cfg)
specifier|protected
name|void
name|saveProjectConfig
parameter_list|(
name|Project
operator|.
name|NameKey
name|p
parameter_list|,
name|ProjectConfig
name|cfg
parameter_list|)
throws|throws
name|Exception
block|{
try|try
init|(
name|MetaDataUpdate
name|md
init|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|p
argument_list|)
init|)
block|{
name|md
operator|.
name|setAuthor
argument_list|(
name|identifiedUserFactory
operator|.
name|create
argument_list|(
name|admin
operator|.
name|getId
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|commit
argument_list|(
name|md
argument_list|)
expr_stmt|;
block|}
name|projectCache
operator|.
name|evict
argument_list|(
name|cfg
operator|.
name|getProject
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|saveProjectConfig (ProjectConfig cfg)
specifier|protected
name|void
name|saveProjectConfig
parameter_list|(
name|ProjectConfig
name|cfg
parameter_list|)
throws|throws
name|Exception
block|{
name|saveProjectConfig
argument_list|(
name|project
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
DECL|method|grant (Project.NameKey project, String ref, String permission)
specifier|protected
name|void
name|grant
parameter_list|(
name|Project
operator|.
name|NameKey
name|project
parameter_list|,
name|String
name|ref
parameter_list|,
name|String
name|permission
parameter_list|)
throws|throws
name|RepositoryNotFoundException
throws|,
name|IOException
throws|,
name|ConfigInvalidException
block|{
name|grant
argument_list|(
name|project
argument_list|,
name|ref
argument_list|,
name|permission
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
DECL|method|grant (Project.NameKey project, String ref, String permission, boolean force)
specifier|protected
name|void
name|grant
parameter_list|(
name|Project
operator|.
name|NameKey
name|project
parameter_list|,
name|String
name|ref
parameter_list|,
name|String
name|permission
parameter_list|,
name|boolean
name|force
parameter_list|)
throws|throws
name|RepositoryNotFoundException
throws|,
name|IOException
throws|,
name|ConfigInvalidException
block|{
name|InternalGroup
name|adminGroup
init|=
name|groupCache
operator|.
name|get
argument_list|(
operator|new
name|AccountGroup
operator|.
name|NameKey
argument_list|(
literal|"Administrators"
argument_list|)
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
decl_stmt|;
name|grant
argument_list|(
name|project
argument_list|,
name|ref
argument_list|,
name|permission
argument_list|,
name|force
argument_list|,
name|adminGroup
operator|.
name|getGroupUUID
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|grant ( Project.NameKey project, String ref, String permission, boolean force, AccountGroup.UUID groupUUID)
specifier|protected
name|void
name|grant
parameter_list|(
name|Project
operator|.
name|NameKey
name|project
parameter_list|,
name|String
name|ref
parameter_list|,
name|String
name|permission
parameter_list|,
name|boolean
name|force
parameter_list|,
name|AccountGroup
operator|.
name|UUID
name|groupUUID
parameter_list|)
throws|throws
name|RepositoryNotFoundException
throws|,
name|IOException
throws|,
name|ConfigInvalidException
block|{
try|try
init|(
name|MetaDataUpdate
name|md
init|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|project
argument_list|)
init|)
block|{
name|md
operator|.
name|setMessage
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Grant %s on %s"
argument_list|,
name|permission
argument_list|,
name|ref
argument_list|)
argument_list|)
expr_stmt|;
name|ProjectConfig
name|config
init|=
name|ProjectConfig
operator|.
name|read
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|AccessSection
name|s
init|=
name|config
operator|.
name|getAccessSection
argument_list|(
name|ref
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|Permission
name|p
init|=
name|s
operator|.
name|getPermission
argument_list|(
name|permission
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|PermissionRule
name|rule
init|=
name|Util
operator|.
name|newRule
argument_list|(
name|config
argument_list|,
name|groupUUID
argument_list|)
decl_stmt|;
name|rule
operator|.
name|setForce
argument_list|(
name|force
argument_list|)
expr_stmt|;
name|p
operator|.
name|add
argument_list|(
name|rule
argument_list|)
expr_stmt|;
name|config
operator|.
name|commit
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|projectCache
operator|.
name|evict
argument_list|(
name|config
operator|.
name|getProject
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|grantLabel ( String label, int min, int max, Project.NameKey project, String ref, boolean force, AccountGroup.UUID groupUUID, boolean exclusive)
specifier|protected
name|void
name|grantLabel
parameter_list|(
name|String
name|label
parameter_list|,
name|int
name|min
parameter_list|,
name|int
name|max
parameter_list|,
name|Project
operator|.
name|NameKey
name|project
parameter_list|,
name|String
name|ref
parameter_list|,
name|boolean
name|force
parameter_list|,
name|AccountGroup
operator|.
name|UUID
name|groupUUID
parameter_list|,
name|boolean
name|exclusive
parameter_list|)
throws|throws
name|RepositoryNotFoundException
throws|,
name|IOException
throws|,
name|ConfigInvalidException
block|{
name|String
name|permission
init|=
name|Permission
operator|.
name|LABEL
operator|+
name|label
decl_stmt|;
try|try
init|(
name|MetaDataUpdate
name|md
init|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|project
argument_list|)
init|)
block|{
name|md
operator|.
name|setMessage
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Grant %s on %s"
argument_list|,
name|permission
argument_list|,
name|ref
argument_list|)
argument_list|)
expr_stmt|;
name|ProjectConfig
name|config
init|=
name|ProjectConfig
operator|.
name|read
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|AccessSection
name|s
init|=
name|config
operator|.
name|getAccessSection
argument_list|(
name|ref
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|Permission
name|p
init|=
name|s
operator|.
name|getPermission
argument_list|(
name|permission
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|p
operator|.
name|setExclusiveGroup
argument_list|(
name|exclusive
argument_list|)
expr_stmt|;
name|PermissionRule
name|rule
init|=
name|Util
operator|.
name|newRule
argument_list|(
name|config
argument_list|,
name|groupUUID
argument_list|)
decl_stmt|;
name|rule
operator|.
name|setForce
argument_list|(
name|force
argument_list|)
expr_stmt|;
name|rule
operator|.
name|setMin
argument_list|(
name|min
argument_list|)
expr_stmt|;
name|rule
operator|.
name|setMax
argument_list|(
name|max
argument_list|)
expr_stmt|;
name|p
operator|.
name|add
argument_list|(
name|rule
argument_list|)
expr_stmt|;
name|config
operator|.
name|commit
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|projectCache
operator|.
name|evict
argument_list|(
name|config
operator|.
name|getProject
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|removePermission (Project.NameKey project, String ref, String permission)
specifier|protected
name|void
name|removePermission
parameter_list|(
name|Project
operator|.
name|NameKey
name|project
parameter_list|,
name|String
name|ref
parameter_list|,
name|String
name|permission
parameter_list|)
throws|throws
name|IOException
throws|,
name|ConfigInvalidException
block|{
try|try
init|(
name|MetaDataUpdate
name|md
init|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|project
argument_list|)
init|)
block|{
name|md
operator|.
name|setMessage
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Remove %s on %s"
argument_list|,
name|permission
argument_list|,
name|ref
argument_list|)
argument_list|)
expr_stmt|;
name|ProjectConfig
name|config
init|=
name|ProjectConfig
operator|.
name|read
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|AccessSection
name|s
init|=
name|config
operator|.
name|getAccessSection
argument_list|(
name|ref
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|Permission
name|p
init|=
name|s
operator|.
name|getPermission
argument_list|(
name|permission
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|p
operator|.
name|getRules
argument_list|()
operator|.
name|clear
argument_list|()
expr_stmt|;
name|config
operator|.
name|commit
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|projectCache
operator|.
name|evict
argument_list|(
name|config
operator|.
name|getProject
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|blockRead (String ref)
specifier|protected
name|void
name|blockRead
parameter_list|(
name|String
name|ref
parameter_list|)
throws|throws
name|Exception
block|{
name|block
argument_list|(
name|ref
argument_list|,
name|Permission
operator|.
name|READ
argument_list|,
name|REGISTERED_USERS
argument_list|)
expr_stmt|;
block|}
DECL|method|blockForgeCommitter (Project.NameKey project, String ref)
specifier|protected
name|void
name|blockForgeCommitter
parameter_list|(
name|Project
operator|.
name|NameKey
name|project
parameter_list|,
name|String
name|ref
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|project
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
name|Util
operator|.
name|block
argument_list|(
name|cfg
argument_list|,
name|Permission
operator|.
name|FORGE_COMMITTER
argument_list|,
name|REGISTERED_USERS
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|saveProjectConfig
argument_list|(
name|project
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
DECL|method|pushTo (String ref)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|pushTo
parameter_list|(
name|String
name|ref
parameter_list|)
throws|throws
name|Exception
block|{
name|PushOneCommit
name|push
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|admin
operator|.
name|getIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|)
decl_stmt|;
return|return
name|push
operator|.
name|to
argument_list|(
name|ref
argument_list|)
return|;
block|}
DECL|method|approve (String id)
specifier|protected
name|void
name|approve
parameter_list|(
name|String
name|id
parameter_list|)
throws|throws
name|Exception
block|{
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|revision
argument_list|(
literal|"current"
argument_list|)
operator|.
name|review
argument_list|(
name|ReviewInput
operator|.
name|approve
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|recommend (String id)
specifier|protected
name|void
name|recommend
parameter_list|(
name|String
name|id
parameter_list|)
throws|throws
name|Exception
block|{
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|revision
argument_list|(
literal|"current"
argument_list|)
operator|.
name|review
argument_list|(
name|ReviewInput
operator|.
name|recommend
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|getActions (String id)
specifier|protected
name|Map
argument_list|<
name|String
argument_list|,
name|ActionInfo
argument_list|>
name|getActions
parameter_list|(
name|String
name|id
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|revision
argument_list|(
literal|1
argument_list|)
operator|.
name|actions
argument_list|()
return|;
block|}
DECL|method|getETag (String id)
specifier|protected
name|String
name|getETag
parameter_list|(
name|String
name|id
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|etag
argument_list|()
return|;
block|}
DECL|method|changeIds (Iterable<ChangeInfo> changes)
specifier|private
specifier|static
name|Iterable
argument_list|<
name|String
argument_list|>
name|changeIds
parameter_list|(
name|Iterable
argument_list|<
name|ChangeInfo
argument_list|>
name|changes
parameter_list|)
block|{
return|return
name|Iterables
operator|.
name|transform
argument_list|(
name|changes
argument_list|,
name|i
lambda|->
name|i
operator|.
name|changeId
argument_list|)
return|;
block|}
DECL|method|assertSubmittedTogether (String chId, String... expected)
specifier|protected
name|void
name|assertSubmittedTogether
parameter_list|(
name|String
name|chId
parameter_list|,
name|String
modifier|...
name|expected
parameter_list|)
throws|throws
name|Exception
block|{
name|List
argument_list|<
name|ChangeInfo
argument_list|>
name|actual
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|chId
argument_list|)
operator|.
name|submittedTogether
argument_list|()
decl_stmt|;
name|SubmittedTogetherInfo
name|info
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|chId
argument_list|)
operator|.
name|submittedTogether
argument_list|(
name|EnumSet
operator|.
name|of
argument_list|(
name|NON_VISIBLE_CHANGES
argument_list|)
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|info
operator|.
name|nonVisibleChanges
argument_list|)
operator|.
name|isEqualTo
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|actual
argument_list|)
operator|.
name|hasSize
argument_list|(
name|expected
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|changeIds
argument_list|(
name|actual
argument_list|)
argument_list|)
operator|.
name|containsExactly
argument_list|(
operator|(
name|Object
index|[]
operator|)
name|expected
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|changeIds
argument_list|(
name|info
operator|.
name|changes
argument_list|)
argument_list|)
operator|.
name|containsExactly
argument_list|(
operator|(
name|Object
index|[]
operator|)
name|expected
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
DECL|method|getPatchSet (PatchSet.Id psId)
specifier|protected
name|PatchSet
name|getPatchSet
parameter_list|(
name|PatchSet
operator|.
name|Id
name|psId
parameter_list|)
throws|throws
name|OrmException
block|{
return|return
name|changeDataFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|project
argument_list|,
name|psId
operator|.
name|getParentKey
argument_list|()
argument_list|)
operator|.
name|patchSet
argument_list|(
name|psId
argument_list|)
return|;
block|}
DECL|method|user (TestAccount testAccount)
specifier|protected
name|IdentifiedUser
name|user
parameter_list|(
name|TestAccount
name|testAccount
parameter_list|)
block|{
return|return
name|identifiedUserFactory
operator|.
name|create
argument_list|(
name|testAccount
operator|.
name|getId
argument_list|()
argument_list|)
return|;
block|}
DECL|method|parseCurrentRevisionResource (String changeId)
specifier|protected
name|RevisionResource
name|parseCurrentRevisionResource
parameter_list|(
name|String
name|changeId
parameter_list|)
throws|throws
name|Exception
block|{
name|ChangeResource
name|cr
init|=
name|parseChangeResource
argument_list|(
name|changeId
argument_list|)
decl_stmt|;
name|int
name|psId
init|=
name|cr
operator|.
name|getChange
argument_list|()
operator|.
name|currentPatchSetId
argument_list|()
operator|.
name|get
argument_list|()
decl_stmt|;
return|return
name|revisions
operator|.
name|parse
argument_list|(
name|cr
argument_list|,
name|IdString
operator|.
name|fromDecoded
argument_list|(
name|Integer
operator|.
name|toString
argument_list|(
name|psId
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
DECL|method|parseRevisionResource (String changeId, int n)
specifier|protected
name|RevisionResource
name|parseRevisionResource
parameter_list|(
name|String
name|changeId
parameter_list|,
name|int
name|n
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|revisions
operator|.
name|parse
argument_list|(
name|parseChangeResource
argument_list|(
name|changeId
argument_list|)
argument_list|,
name|IdString
operator|.
name|fromDecoded
argument_list|(
name|Integer
operator|.
name|toString
argument_list|(
name|n
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
DECL|method|parseRevisionResource (PushOneCommit.Result r)
specifier|protected
name|RevisionResource
name|parseRevisionResource
parameter_list|(
name|PushOneCommit
operator|.
name|Result
name|r
parameter_list|)
throws|throws
name|Exception
block|{
name|PatchSet
operator|.
name|Id
name|psId
init|=
name|r
operator|.
name|getPatchSetId
argument_list|()
decl_stmt|;
return|return
name|parseRevisionResource
argument_list|(
name|psId
operator|.
name|getParentKey
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|,
name|psId
operator|.
name|get
argument_list|()
argument_list|)
return|;
block|}
DECL|method|parseChangeResource (String changeId)
specifier|protected
name|ChangeResource
name|parseChangeResource
parameter_list|(
name|String
name|changeId
parameter_list|)
throws|throws
name|Exception
block|{
name|List
argument_list|<
name|ChangeNotes
argument_list|>
name|notes
init|=
name|changeFinder
operator|.
name|find
argument_list|(
name|changeId
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|notes
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|changeResourceFactory
operator|.
name|create
argument_list|(
name|notes
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|,
name|atrScope
operator|.
name|get
argument_list|()
operator|.
name|getUser
argument_list|()
argument_list|)
return|;
block|}
DECL|method|createGroup (String name)
specifier|protected
name|String
name|createGroup
parameter_list|(
name|String
name|name
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|createGroup
argument_list|(
name|name
argument_list|,
literal|"Administrators"
argument_list|)
return|;
block|}
DECL|method|createGroupWithRealName (String name)
specifier|protected
name|String
name|createGroupWithRealName
parameter_list|(
name|String
name|name
parameter_list|)
throws|throws
name|Exception
block|{
name|GroupInput
name|in
init|=
operator|new
name|GroupInput
argument_list|()
decl_stmt|;
name|in
operator|.
name|name
operator|=
name|name
expr_stmt|;
name|in
operator|.
name|ownerId
operator|=
literal|"Administrators"
expr_stmt|;
name|gApi
operator|.
name|groups
argument_list|()
operator|.
name|create
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
name|name
return|;
block|}
DECL|method|createGroup (String name, String owner)
specifier|protected
name|String
name|createGroup
parameter_list|(
name|String
name|name
parameter_list|,
name|String
name|owner
parameter_list|)
throws|throws
name|Exception
block|{
name|name
operator|=
name|name
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|GroupInput
name|in
init|=
operator|new
name|GroupInput
argument_list|()
decl_stmt|;
name|in
operator|.
name|name
operator|=
name|name
expr_stmt|;
name|in
operator|.
name|ownerId
operator|=
name|owner
expr_stmt|;
name|gApi
operator|.
name|groups
argument_list|()
operator|.
name|create
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
name|name
return|;
block|}
DECL|method|createAccount (String name, String group)
specifier|protected
name|String
name|createAccount
parameter_list|(
name|String
name|name
parameter_list|,
name|String
name|group
parameter_list|)
throws|throws
name|Exception
block|{
name|name
operator|=
name|name
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|accountCreator
operator|.
name|create
argument_list|(
name|name
argument_list|,
name|group
argument_list|)
expr_stmt|;
return|return
name|name
return|;
block|}
DECL|method|getHead (Repository repo, String name)
specifier|protected
name|RevCommit
name|getHead
parameter_list|(
name|Repository
name|repo
parameter_list|,
name|String
name|name
parameter_list|)
throws|throws
name|Exception
block|{
try|try
init|(
name|RevWalk
name|rw
init|=
operator|new
name|RevWalk
argument_list|(
name|repo
argument_list|)
init|)
block|{
name|Ref
name|r
init|=
name|repo
operator|.
name|exactRef
argument_list|(
name|name
argument_list|)
decl_stmt|;
return|return
name|r
operator|!=
literal|null
condition|?
name|rw
operator|.
name|parseCommit
argument_list|(
name|r
operator|.
name|getObjectId
argument_list|()
argument_list|)
else|:
literal|null
return|;
block|}
block|}
DECL|method|getHead (Repository repo)
specifier|protected
name|RevCommit
name|getHead
parameter_list|(
name|Repository
name|repo
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|getHead
argument_list|(
name|repo
argument_list|,
literal|"HEAD"
argument_list|)
return|;
block|}
DECL|method|getRemoteHead (Project.NameKey project, String branch)
specifier|protected
name|RevCommit
name|getRemoteHead
parameter_list|(
name|Project
operator|.
name|NameKey
name|project
parameter_list|,
name|String
name|branch
parameter_list|)
throws|throws
name|Exception
block|{
try|try
init|(
name|Repository
name|repo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|project
argument_list|)
init|)
block|{
return|return
name|getHead
argument_list|(
name|repo
argument_list|,
name|branch
operator|.
name|startsWith
argument_list|(
name|Constants
operator|.
name|R_REFS
argument_list|)
condition|?
name|branch
else|:
literal|"refs/heads/"
operator|+
name|branch
argument_list|)
return|;
block|}
block|}
DECL|method|getRemoteHead (String project, String branch)
specifier|protected
name|RevCommit
name|getRemoteHead
parameter_list|(
name|String
name|project
parameter_list|,
name|String
name|branch
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|getRemoteHead
argument_list|(
operator|new
name|Project
operator|.
name|NameKey
argument_list|(
name|project
argument_list|)
argument_list|,
name|branch
argument_list|)
return|;
block|}
DECL|method|getRemoteHead ()
specifier|protected
name|RevCommit
name|getRemoteHead
parameter_list|()
throws|throws
name|Exception
block|{
return|return
name|getRemoteHead
argument_list|(
name|project
argument_list|,
literal|"master"
argument_list|)
return|;
block|}
DECL|method|grantTagPermissions ()
specifier|protected
name|void
name|grantTagPermissions
parameter_list|()
throws|throws
name|Exception
block|{
name|grant
argument_list|(
name|project
argument_list|,
name|R_TAGS
operator|+
literal|"*"
argument_list|,
name|Permission
operator|.
name|CREATE
argument_list|)
expr_stmt|;
name|grant
argument_list|(
name|project
argument_list|,
name|R_TAGS
operator|+
literal|""
argument_list|,
name|Permission
operator|.
name|DELETE
argument_list|)
expr_stmt|;
name|grant
argument_list|(
name|project
argument_list|,
name|R_TAGS
operator|+
literal|"*"
argument_list|,
name|Permission
operator|.
name|CREATE_TAG
argument_list|)
expr_stmt|;
name|grant
argument_list|(
name|project
argument_list|,
name|R_TAGS
operator|+
literal|"*"
argument_list|,
name|Permission
operator|.
name|CREATE_SIGNED_TAG
argument_list|)
expr_stmt|;
block|}
DECL|method|assertMailReplyTo (Message message, String email)
specifier|protected
name|void
name|assertMailReplyTo
parameter_list|(
name|Message
name|message
parameter_list|,
name|String
name|email
parameter_list|)
throws|throws
name|Exception
block|{
name|assertThat
argument_list|(
name|message
operator|.
name|headers
argument_list|()
argument_list|)
operator|.
name|containsKey
argument_list|(
literal|"Reply-To"
argument_list|)
expr_stmt|;
name|EmailHeader
operator|.
name|String
name|replyTo
init|=
operator|(
name|EmailHeader
operator|.
name|String
operator|)
name|message
operator|.
name|headers
argument_list|()
operator|.
name|get
argument_list|(
literal|"Reply-To"
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|replyTo
operator|.
name|getString
argument_list|()
argument_list|)
operator|.
name|contains
argument_list|(
name|email
argument_list|)
expr_stmt|;
block|}
DECL|method|configureContributorAgreement (boolean autoVerify)
specifier|protected
name|ContributorAgreement
name|configureContributorAgreement
parameter_list|(
name|boolean
name|autoVerify
parameter_list|)
throws|throws
name|Exception
block|{
name|ContributorAgreement
name|ca
decl_stmt|;
if|if
condition|(
name|autoVerify
condition|)
block|{
name|String
name|g
init|=
name|createGroup
argument_list|(
literal|"cla-test-group"
argument_list|)
decl_stmt|;
name|GroupApi
name|groupApi
init|=
name|gApi
operator|.
name|groups
argument_list|()
operator|.
name|id
argument_list|(
name|g
argument_list|)
decl_stmt|;
name|groupApi
operator|.
name|description
argument_list|(
literal|"CLA test group"
argument_list|)
expr_stmt|;
name|InternalGroup
name|caGroup
init|=
name|groupCache
operator|.
name|get
argument_list|(
operator|new
name|AccountGroup
operator|.
name|UUID
argument_list|(
name|groupApi
operator|.
name|detail
argument_list|()
operator|.
name|id
argument_list|)
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
decl_stmt|;
name|GroupReference
name|groupRef
init|=
operator|new
name|GroupReference
argument_list|(
name|caGroup
operator|.
name|getGroupUUID
argument_list|()
argument_list|,
name|caGroup
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|PermissionRule
name|rule
init|=
operator|new
name|PermissionRule
argument_list|(
name|groupRef
argument_list|)
decl_stmt|;
name|rule
operator|.
name|setAction
argument_list|(
name|PermissionRule
operator|.
name|Action
operator|.
name|ALLOW
argument_list|)
expr_stmt|;
name|ca
operator|=
operator|new
name|ContributorAgreement
argument_list|(
literal|"cla-test"
argument_list|)
expr_stmt|;
name|ca
operator|.
name|setAutoVerify
argument_list|(
name|groupRef
argument_list|)
expr_stmt|;
name|ca
operator|.
name|setAccepted
argument_list|(
name|ImmutableList
operator|.
name|of
argument_list|(
name|rule
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ca
operator|=
operator|new
name|ContributorAgreement
argument_list|(
literal|"cla-test-no-auto-verify"
argument_list|)
expr_stmt|;
block|}
name|ca
operator|.
name|setDescription
argument_list|(
literal|"description"
argument_list|)
expr_stmt|;
name|ca
operator|.
name|setAgreementUrl
argument_list|(
literal|"agreement-url"
argument_list|)
expr_stmt|;
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|allProjects
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
name|cfg
operator|.
name|replace
argument_list|(
name|ca
argument_list|)
expr_stmt|;
name|saveProjectConfig
argument_list|(
name|allProjects
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
return|return
name|ca
return|;
block|}
DECL|method|submitPreview (String changeId)
specifier|protected
name|BinaryResult
name|submitPreview
parameter_list|(
name|String
name|changeId
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|submitPreview
argument_list|()
return|;
block|}
DECL|method|submitPreview (String changeId, String format)
specifier|protected
name|BinaryResult
name|submitPreview
parameter_list|(
name|String
name|changeId
parameter_list|,
name|String
name|format
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|changeId
argument_list|)
operator|.
name|current
argument_list|()
operator|.
name|submitPreview
argument_list|(
name|format
argument_list|)
return|;
block|}
DECL|method|fetchFromSubmitPreview (String changeId)
specifier|protected
name|Map
argument_list|<
name|Branch
operator|.
name|NameKey
argument_list|,
name|ObjectId
argument_list|>
name|fetchFromSubmitPreview
parameter_list|(
name|String
name|changeId
parameter_list|)
throws|throws
name|Exception
block|{
try|try
init|(
name|BinaryResult
name|result
init|=
name|submitPreview
argument_list|(
name|changeId
argument_list|)
init|)
block|{
return|return
name|fetchFromBundles
argument_list|(
name|result
argument_list|)
return|;
block|}
block|}
comment|/**    * Fetches each bundle into a newly cloned repository, then it applies the bundle, and returns the    * resulting tree id.    *    *<p>Omits NoteDb meta refs.    */
DECL|method|fetchFromBundles (BinaryResult bundles)
specifier|protected
name|Map
argument_list|<
name|Branch
operator|.
name|NameKey
argument_list|,
name|ObjectId
argument_list|>
name|fetchFromBundles
parameter_list|(
name|BinaryResult
name|bundles
parameter_list|)
throws|throws
name|Exception
block|{
name|assertThat
argument_list|(
name|bundles
operator|.
name|getContentType
argument_list|()
argument_list|)
operator|.
name|isEqualTo
argument_list|(
literal|"application/x-zip"
argument_list|)
expr_stmt|;
name|FileSystem
name|fs
init|=
name|Jimfs
operator|.
name|newFileSystem
argument_list|()
decl_stmt|;
name|Path
name|previewPath
init|=
name|fs
operator|.
name|getPath
argument_list|(
literal|"preview.zip"
argument_list|)
decl_stmt|;
try|try
init|(
name|OutputStream
name|out
init|=
name|Files
operator|.
name|newOutputStream
argument_list|(
name|previewPath
argument_list|)
init|)
block|{
name|bundles
operator|.
name|writeTo
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
name|Map
argument_list|<
name|Branch
operator|.
name|NameKey
argument_list|,
name|ObjectId
argument_list|>
name|ret
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
try|try
init|(
name|FileSystem
name|zipFs
init|=
name|FileSystems
operator|.
name|newFileSystem
argument_list|(
name|previewPath
argument_list|,
literal|null
argument_list|)
init|;
name|DirectoryStream
argument_list|<
name|Path
argument_list|>
name|dirStream
operator|=
name|Files
operator|.
name|newDirectoryStream
argument_list|(
name|Iterables
operator|.
name|getOnlyElement
argument_list|(
name|zipFs
operator|.
name|getRootDirectories
argument_list|()
argument_list|)
argument_list|)
init|)
block|{
for|for
control|(
name|Path
name|p
range|:
name|dirStream
control|)
block|{
if|if
condition|(
operator|!
name|Files
operator|.
name|isRegularFile
argument_list|(
name|p
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|String
name|bundleName
init|=
name|p
operator|.
name|getFileName
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
name|int
name|len
init|=
name|bundleName
operator|.
name|length
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|bundleName
argument_list|)
operator|.
name|endsWith
argument_list|(
literal|".git"
argument_list|)
expr_stmt|;
name|String
name|repoName
init|=
name|bundleName
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|len
operator|-
literal|4
argument_list|)
decl_stmt|;
name|Project
operator|.
name|NameKey
name|proj
init|=
operator|new
name|Project
operator|.
name|NameKey
argument_list|(
name|repoName
argument_list|)
decl_stmt|;
name|TestRepository
argument_list|<
name|?
argument_list|>
name|localRepo
init|=
name|cloneProject
argument_list|(
name|proj
argument_list|)
decl_stmt|;
try|try
init|(
name|InputStream
name|bundleStream
init|=
name|Files
operator|.
name|newInputStream
argument_list|(
name|p
argument_list|)
init|;
name|TransportBundleStream
name|tbs
operator|=
operator|new
name|TransportBundleStream
argument_list|(
name|localRepo
operator|.
name|getRepository
argument_list|()
argument_list|,
operator|new
name|URIish
argument_list|(
name|bundleName
argument_list|)
argument_list|,
name|bundleStream
argument_list|)
init|)
block|{
name|FetchResult
name|fr
init|=
name|tbs
operator|.
name|fetch
argument_list|(
name|NullProgressMonitor
operator|.
name|INSTANCE
argument_list|,
name|Arrays
operator|.
name|asList
argument_list|(
operator|new
name|RefSpec
argument_list|(
literal|"refs/*:refs/preview/*"
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
for|for
control|(
name|Ref
name|r
range|:
name|fr
operator|.
name|getAdvertisedRefs
argument_list|()
control|)
block|{
name|String
name|refName
init|=
name|r
operator|.
name|getName
argument_list|()
decl_stmt|;
if|if
condition|(
name|RefNames
operator|.
name|isNoteDbMetaRef
argument_list|(
name|refName
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|RevCommit
name|c
init|=
name|localRepo
operator|.
name|getRevWalk
argument_list|()
operator|.
name|parseCommit
argument_list|(
name|r
operator|.
name|getObjectId
argument_list|()
argument_list|)
decl_stmt|;
name|ret
operator|.
name|put
argument_list|(
operator|new
name|Branch
operator|.
name|NameKey
argument_list|(
name|proj
argument_list|,
name|refName
argument_list|)
argument_list|,
name|c
operator|.
name|getTree
argument_list|()
operator|.
name|copy
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|assertThat
argument_list|(
name|ret
argument_list|)
operator|.
name|isNotEmpty
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
comment|/** Assert that the given branches have the given tree ids. */
DECL|method|assertTrees (Project.NameKey proj, Map<Branch.NameKey, ObjectId> trees)
specifier|protected
name|void
name|assertTrees
parameter_list|(
name|Project
operator|.
name|NameKey
name|proj
parameter_list|,
name|Map
argument_list|<
name|Branch
operator|.
name|NameKey
argument_list|,
name|ObjectId
argument_list|>
name|trees
parameter_list|)
throws|throws
name|Exception
block|{
name|TestRepository
argument_list|<
name|?
argument_list|>
name|localRepo
init|=
name|cloneProject
argument_list|(
name|proj
argument_list|)
decl_stmt|;
name|GitUtil
operator|.
name|fetch
argument_list|(
name|localRepo
argument_list|,
literal|"refs/*:refs/*"
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Ref
argument_list|>
name|refs
init|=
name|localRepo
operator|.
name|getRepository
argument_list|()
operator|.
name|getAllRefs
argument_list|()
decl_stmt|;
name|Map
argument_list|<
name|Branch
operator|.
name|NameKey
argument_list|,
name|RevTree
argument_list|>
name|refValues
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|Branch
operator|.
name|NameKey
name|b
range|:
name|trees
operator|.
name|keySet
argument_list|()
control|)
block|{
if|if
condition|(
operator|!
name|b
operator|.
name|getParentKey
argument_list|()
operator|.
name|equals
argument_list|(
name|proj
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|Ref
name|r
init|=
name|refs
operator|.
name|get
argument_list|(
name|b
operator|.
name|get
argument_list|()
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|r
argument_list|)
operator|.
name|isNotNull
argument_list|()
expr_stmt|;
name|RevWalk
name|rw
init|=
name|localRepo
operator|.
name|getRevWalk
argument_list|()
decl_stmt|;
name|RevCommit
name|c
init|=
name|rw
operator|.
name|parseCommit
argument_list|(
name|r
operator|.
name|getObjectId
argument_list|()
argument_list|)
decl_stmt|;
name|refValues
operator|.
name|put
argument_list|(
name|b
argument_list|,
name|c
operator|.
name|getTree
argument_list|()
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|trees
operator|.
name|get
argument_list|(
name|b
argument_list|)
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|refValues
operator|.
name|get
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|assertThat
argument_list|(
name|refValues
operator|.
name|keySet
argument_list|()
argument_list|)
operator|.
name|containsAnyIn
argument_list|(
name|trees
operator|.
name|keySet
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|assertDiffForNewFile ( DiffInfo diff, RevCommit commit, String path, String expectedContentSideB)
specifier|protected
name|void
name|assertDiffForNewFile
parameter_list|(
name|DiffInfo
name|diff
parameter_list|,
name|RevCommit
name|commit
parameter_list|,
name|String
name|path
parameter_list|,
name|String
name|expectedContentSideB
parameter_list|)
throws|throws
name|Exception
block|{
name|List
argument_list|<
name|String
argument_list|>
name|expectedLines
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|line
range|:
name|expectedContentSideB
operator|.
name|split
argument_list|(
literal|"\n"
argument_list|)
control|)
block|{
name|expectedLines
operator|.
name|add
argument_list|(
name|line
argument_list|)
expr_stmt|;
block|}
name|assertThat
argument_list|(
name|diff
operator|.
name|binary
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|changeType
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|ChangeType
operator|.
name|ADDED
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|diffHeader
argument_list|)
operator|.
name|isNotNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|intralineStatus
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|webLinks
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaA
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaB
argument_list|)
operator|.
name|isNotNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaB
operator|.
name|commitId
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|commit
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|expectedContentType
init|=
literal|"text/plain"
decl_stmt|;
if|if
condition|(
name|COMMIT_MSG
operator|.
name|equals
argument_list|(
name|path
argument_list|)
condition|)
block|{
name|expectedContentType
operator|=
name|FileContentUtil
operator|.
name|TEXT_X_GERRIT_COMMIT_MESSAGE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|MERGE_LIST
operator|.
name|equals
argument_list|(
name|path
argument_list|)
condition|)
block|{
name|expectedContentType
operator|=
name|FileContentUtil
operator|.
name|TEXT_X_GERRIT_MERGE_LIST
expr_stmt|;
block|}
name|assertThat
argument_list|(
name|diff
operator|.
name|metaB
operator|.
name|contentType
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|expectedContentType
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaB
operator|.
name|lines
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|expectedLines
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaB
operator|.
name|name
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|metaB
operator|.
name|webLinks
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|diff
operator|.
name|content
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|DiffInfo
operator|.
name|ContentEntry
name|contentEntry
init|=
name|diff
operator|.
name|content
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|contentEntry
operator|.
name|b
argument_list|)
operator|.
name|containsExactlyElementsIn
argument_list|(
name|expectedLines
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|contentEntry
operator|.
name|a
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|contentEntry
operator|.
name|ab
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|contentEntry
operator|.
name|common
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|contentEntry
operator|.
name|editA
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|contentEntry
operator|.
name|editB
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|contentEntry
operator|.
name|skip
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
DECL|method|createProjectWithPush ( String name, @Nullable Project.NameKey parent, SubmitType submitType)
specifier|protected
name|TestRepository
argument_list|<
name|?
argument_list|>
name|createProjectWithPush
parameter_list|(
name|String
name|name
parameter_list|,
annotation|@
name|Nullable
name|Project
operator|.
name|NameKey
name|parent
parameter_list|,
name|SubmitType
name|submitType
parameter_list|)
throws|throws
name|Exception
block|{
name|Project
operator|.
name|NameKey
name|project
init|=
name|createProject
argument_list|(
name|name
argument_list|,
name|parent
argument_list|,
literal|true
argument_list|,
name|submitType
argument_list|)
decl_stmt|;
name|grant
argument_list|(
name|project
argument_list|,
literal|"refs/heads/*"
argument_list|,
name|Permission
operator|.
name|PUSH
argument_list|)
expr_stmt|;
name|grant
argument_list|(
name|project
argument_list|,
literal|"refs/for/refs/heads/*"
argument_list|,
name|Permission
operator|.
name|SUBMIT
argument_list|)
expr_stmt|;
return|return
name|cloneProject
argument_list|(
name|project
argument_list|)
return|;
block|}
DECL|method|assertPermitted (ChangeInfo info, String label, Integer... expected)
specifier|protected
name|void
name|assertPermitted
parameter_list|(
name|ChangeInfo
name|info
parameter_list|,
name|String
name|label
parameter_list|,
name|Integer
modifier|...
name|expected
parameter_list|)
block|{
name|assertThat
argument_list|(
name|info
operator|.
name|permittedLabels
argument_list|)
operator|.
name|isNotNull
argument_list|()
expr_stmt|;
name|Collection
argument_list|<
name|String
argument_list|>
name|strs
init|=
name|info
operator|.
name|permittedLabels
operator|.
name|get
argument_list|(
name|label
argument_list|)
decl_stmt|;
if|if
condition|(
name|expected
operator|.
name|length
operator|==
literal|0
condition|)
block|{
name|assertThat
argument_list|(
name|strs
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|assertThat
argument_list|(
name|strs
operator|.
name|stream
argument_list|()
operator|.
name|map
argument_list|(
name|s
lambda|->
name|Integer
operator|.
name|valueOf
argument_list|(
name|s
operator|.
name|trim
argument_list|()
argument_list|)
argument_list|)
operator|.
name|collect
argument_list|(
name|toList
argument_list|()
argument_list|)
argument_list|)
operator|.
name|containsExactlyElementsIn
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|expected
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|assertNotifyTo (TestAccount expected)
specifier|protected
name|void
name|assertNotifyTo
parameter_list|(
name|TestAccount
name|expected
parameter_list|)
block|{
name|assertNotifyTo
argument_list|(
name|expected
operator|.
name|emailAddress
argument_list|)
expr_stmt|;
block|}
DECL|method|assertNotifyTo (Address expected)
specifier|protected
name|void
name|assertNotifyTo
parameter_list|(
name|Address
name|expected
parameter_list|)
block|{
name|assertThat
argument_list|(
name|sender
operator|.
name|getMessages
argument_list|()
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|Message
name|m
init|=
name|sender
operator|.
name|getMessages
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|m
operator|.
name|rcpt
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|expected
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
operator|(
operator|(
name|EmailHeader
operator|.
name|AddressList
operator|)
name|m
operator|.
name|headers
argument_list|()
operator|.
name|get
argument_list|(
literal|"To"
argument_list|)
operator|)
operator|.
name|getAddressList
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|expected
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|m
operator|.
name|headers
argument_list|()
operator|.
name|get
argument_list|(
literal|"CC"
argument_list|)
operator|.
name|isEmpty
argument_list|()
argument_list|)
operator|.
name|isTrue
argument_list|()
expr_stmt|;
block|}
DECL|method|assertNotifyCc (TestAccount expected)
specifier|protected
name|void
name|assertNotifyCc
parameter_list|(
name|TestAccount
name|expected
parameter_list|)
block|{
name|assertNotifyCc
argument_list|(
name|expected
operator|.
name|emailAddress
argument_list|)
expr_stmt|;
block|}
DECL|method|assertNotifyCc (Address expected)
specifier|protected
name|void
name|assertNotifyCc
parameter_list|(
name|Address
name|expected
parameter_list|)
block|{
name|assertThat
argument_list|(
name|sender
operator|.
name|getMessages
argument_list|()
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|Message
name|m
init|=
name|sender
operator|.
name|getMessages
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|m
operator|.
name|rcpt
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|expected
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|m
operator|.
name|headers
argument_list|()
operator|.
name|get
argument_list|(
literal|"To"
argument_list|)
operator|.
name|isEmpty
argument_list|()
argument_list|)
operator|.
name|isTrue
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
operator|(
operator|(
name|EmailHeader
operator|.
name|AddressList
operator|)
name|m
operator|.
name|headers
argument_list|()
operator|.
name|get
argument_list|(
literal|"CC"
argument_list|)
operator|)
operator|.
name|getAddressList
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|expected
argument_list|)
expr_stmt|;
block|}
DECL|method|assertNotifyBcc (TestAccount expected)
specifier|protected
name|void
name|assertNotifyBcc
parameter_list|(
name|TestAccount
name|expected
parameter_list|)
block|{
name|assertThat
argument_list|(
name|sender
operator|.
name|getMessages
argument_list|()
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|Message
name|m
init|=
name|sender
operator|.
name|getMessages
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|m
operator|.
name|rcpt
argument_list|()
argument_list|)
operator|.
name|containsExactly
argument_list|(
name|expected
operator|.
name|emailAddress
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|m
operator|.
name|headers
argument_list|()
operator|.
name|get
argument_list|(
literal|"To"
argument_list|)
operator|.
name|isEmpty
argument_list|()
argument_list|)
operator|.
name|isTrue
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|m
operator|.
name|headers
argument_list|()
operator|.
name|get
argument_list|(
literal|"CC"
argument_list|)
operator|.
name|isEmpty
argument_list|()
argument_list|)
operator|.
name|isTrue
argument_list|()
expr_stmt|;
block|}
DECL|interface|ProjectWatchInfoConfiguration
specifier|protected
interface|interface
name|ProjectWatchInfoConfiguration
block|{
DECL|method|configure (ProjectWatchInfo pwi)
name|void
name|configure
parameter_list|(
name|ProjectWatchInfo
name|pwi
parameter_list|)
function_decl|;
block|}
DECL|method|watch (String project, ProjectWatchInfoConfiguration config)
specifier|protected
name|void
name|watch
parameter_list|(
name|String
name|project
parameter_list|,
name|ProjectWatchInfoConfiguration
name|config
parameter_list|)
throws|throws
name|RestApiException
block|{
name|ProjectWatchInfo
name|pwi
init|=
operator|new
name|ProjectWatchInfo
argument_list|()
decl_stmt|;
name|pwi
operator|.
name|project
operator|=
name|project
expr_stmt|;
name|config
operator|.
name|configure
argument_list|(
name|pwi
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|self
argument_list|()
operator|.
name|setWatchedProjects
argument_list|(
name|ImmutableList
operator|.
name|of
argument_list|(
name|pwi
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|watch (PushOneCommit.Result r, ProjectWatchInfoConfiguration config)
specifier|protected
name|void
name|watch
parameter_list|(
name|PushOneCommit
operator|.
name|Result
name|r
parameter_list|,
name|ProjectWatchInfoConfiguration
name|config
parameter_list|)
throws|throws
name|OrmException
throws|,
name|RestApiException
block|{
name|watch
argument_list|(
name|r
operator|.
name|getChange
argument_list|()
operator|.
name|project
argument_list|()
operator|.
name|get
argument_list|()
argument_list|,
name|config
argument_list|)
expr_stmt|;
block|}
DECL|method|watch (String project, String filter)
specifier|protected
name|void
name|watch
parameter_list|(
name|String
name|project
parameter_list|,
name|String
name|filter
parameter_list|)
throws|throws
name|RestApiException
block|{
name|watch
argument_list|(
name|project
argument_list|,
name|pwi
lambda|->
block|{
name|pwi
operator|.
name|filter
operator|=
name|filter
expr_stmt|;
name|pwi
operator|.
name|notifyAbandonedChanges
operator|=
literal|true
expr_stmt|;
name|pwi
operator|.
name|notifyNewChanges
operator|=
literal|true
expr_stmt|;
name|pwi
operator|.
name|notifyAllComments
operator|=
literal|true
expr_stmt|;
block|}
argument_list|)
expr_stmt|;
block|}
DECL|method|watch (String project)
specifier|protected
name|void
name|watch
parameter_list|(
name|String
name|project
parameter_list|)
throws|throws
name|RestApiException
block|{
name|watch
argument_list|(
name|project
argument_list|,
operator|(
name|String
operator|)
literal|null
argument_list|)
expr_stmt|;
block|}
DECL|method|assertContent (PushOneCommit.Result pushResult, String path, String expectedContent)
specifier|protected
name|void
name|assertContent
parameter_list|(
name|PushOneCommit
operator|.
name|Result
name|pushResult
parameter_list|,
name|String
name|path
parameter_list|,
name|String
name|expectedContent
parameter_list|)
throws|throws
name|Exception
block|{
name|BinaryResult
name|bin
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|pushResult
operator|.
name|getChangeId
argument_list|()
argument_list|)
operator|.
name|revision
argument_list|(
name|pushResult
operator|.
name|getCommit
argument_list|()
operator|.
name|name
argument_list|()
argument_list|)
operator|.
name|file
argument_list|(
name|path
argument_list|)
operator|.
name|content
argument_list|()
decl_stmt|;
name|ByteArrayOutputStream
name|os
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|bin
operator|.
name|writeTo
argument_list|(
name|os
argument_list|)
expr_stmt|;
name|String
name|res
init|=
operator|new
name|String
argument_list|(
name|os
operator|.
name|toByteArray
argument_list|()
argument_list|,
name|UTF_8
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|res
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|expectedContent
argument_list|)
expr_stmt|;
block|}
DECL|method|createNewCommitWithoutChangeId (String branch, String file, String content)
specifier|protected
name|RevCommit
name|createNewCommitWithoutChangeId
parameter_list|(
name|String
name|branch
parameter_list|,
name|String
name|file
parameter_list|,
name|String
name|content
parameter_list|)
throws|throws
name|Exception
block|{
try|try
init|(
name|Repository
name|repo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|project
argument_list|)
init|;
name|RevWalk
name|walk
operator|=
operator|new
name|RevWalk
argument_list|(
name|repo
argument_list|)
init|)
block|{
name|Ref
name|ref
init|=
name|repo
operator|.
name|exactRef
argument_list|(
name|branch
argument_list|)
decl_stmt|;
name|RevCommit
name|tip
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|ref
operator|!=
literal|null
condition|)
block|{
name|tip
operator|=
name|walk
operator|.
name|parseCommit
argument_list|(
name|ref
operator|.
name|getObjectId
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|TestRepository
argument_list|<
name|?
argument_list|>
name|testSrcRepo
init|=
operator|new
name|TestRepository
argument_list|<>
argument_list|(
name|repo
argument_list|)
decl_stmt|;
name|TestRepository
argument_list|<
name|?
argument_list|>
operator|.
name|BranchBuilder
name|builder
init|=
name|testSrcRepo
operator|.
name|branch
argument_list|(
name|branch
argument_list|)
decl_stmt|;
name|RevCommit
name|revCommit
init|=
name|tip
operator|==
literal|null
condition|?
name|builder
operator|.
name|commit
argument_list|()
operator|.
name|message
argument_list|(
literal|"commit 1"
argument_list|)
operator|.
name|add
argument_list|(
name|file
argument_list|,
name|content
argument_list|)
operator|.
name|create
argument_list|()
else|:
name|builder
operator|.
name|commit
argument_list|()
operator|.
name|parent
argument_list|(
name|tip
argument_list|)
operator|.
name|message
argument_list|(
literal|"commit 1"
argument_list|)
operator|.
name|add
argument_list|(
name|file
argument_list|,
name|content
argument_list|)
operator|.
name|create
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|GitUtil
operator|.
name|getChangeId
argument_list|(
name|testSrcRepo
argument_list|,
name|revCommit
argument_list|)
operator|.
name|isPresent
argument_list|()
argument_list|)
operator|.
name|isFalse
argument_list|()
expr_stmt|;
return|return
name|revCommit
return|;
block|}
block|}
DECL|method|parseCurrentRevision (RevWalk rw, PushOneCommit.Result r)
specifier|protected
name|RevCommit
name|parseCurrentRevision
parameter_list|(
name|RevWalk
name|rw
parameter_list|,
name|PushOneCommit
operator|.
name|Result
name|r
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|parseCurrentRevision
argument_list|(
name|rw
argument_list|,
name|r
operator|.
name|getChangeId
argument_list|()
argument_list|)
return|;
block|}
DECL|method|parseCurrentRevision (RevWalk rw, String changeId)
specifier|protected
name|RevCommit
name|parseCurrentRevision
parameter_list|(
name|RevWalk
name|rw
parameter_list|,
name|String
name|changeId
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|rw
operator|.
name|parseCommit
argument_list|(
name|ObjectId
operator|.
name|fromString
argument_list|(
name|get
argument_list|(
name|changeId
argument_list|,
name|ListChangesOption
operator|.
name|CURRENT_REVISION
argument_list|)
operator|.
name|currentRevision
argument_list|)
argument_list|)
return|;
block|}
DECL|method|enableCreateNewChangeForAllNotInTarget ()
specifier|protected
name|void
name|enableCreateNewChangeForAllNotInTarget
parameter_list|()
throws|throws
name|Exception
block|{
name|ProjectConfig
name|config
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|project
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
name|config
operator|.
name|getProject
argument_list|()
operator|.
name|setCreateNewChangeForAllNotInTarget
argument_list|(
name|InheritableBoolean
operator|.
name|TRUE
argument_list|)
expr_stmt|;
name|saveProjectConfig
argument_list|(
name|project
argument_list|,
name|config
argument_list|)
expr_stmt|;
block|}
DECL|method|configLabel (String label, LabelFunction func)
specifier|protected
name|void
name|configLabel
parameter_list|(
name|String
name|label
parameter_list|,
name|LabelFunction
name|func
parameter_list|)
throws|throws
name|Exception
block|{
name|configLabel
argument_list|(
name|label
argument_list|,
name|func
argument_list|,
name|ImmutableList
operator|.
name|of
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|configLabel (String label, LabelFunction func, List<String> refPatterns)
specifier|protected
name|void
name|configLabel
parameter_list|(
name|String
name|label
parameter_list|,
name|LabelFunction
name|func
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|refPatterns
parameter_list|)
throws|throws
name|Exception
block|{
name|configLabel
argument_list|(
name|project
argument_list|,
name|label
argument_list|,
name|func
argument_list|,
name|refPatterns
argument_list|,
name|value
argument_list|(
literal|1
argument_list|,
literal|"Passes"
argument_list|)
argument_list|,
name|value
argument_list|(
literal|0
argument_list|,
literal|"No score"
argument_list|)
argument_list|,
name|value
argument_list|(
operator|-
literal|1
argument_list|,
literal|"Failed"
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|configLabel ( Project.NameKey project, String label, LabelFunction func, List<String> refPatterns, LabelValue... value)
specifier|private
name|void
name|configLabel
parameter_list|(
name|Project
operator|.
name|NameKey
name|project
parameter_list|,
name|String
name|label
parameter_list|,
name|LabelFunction
name|func
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|refPatterns
parameter_list|,
name|LabelValue
modifier|...
name|value
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|project
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
name|LabelType
name|labelType
init|=
name|category
argument_list|(
name|label
argument_list|,
name|value
argument_list|)
decl_stmt|;
name|labelType
operator|.
name|setFunction
argument_list|(
name|func
argument_list|)
expr_stmt|;
name|labelType
operator|.
name|setRefPatterns
argument_list|(
name|refPatterns
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|getLabelSections
argument_list|()
operator|.
name|put
argument_list|(
name|labelType
operator|.
name|getName
argument_list|()
argument_list|,
name|labelType
argument_list|)
expr_stmt|;
name|saveProjectConfig
argument_list|(
name|project
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

