begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|// Copyright (C) 2013 The Android Open Source Project
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Licensed under the Apache License, Version 2.0 (the "License");
end_comment

begin_comment
comment|// you may not use this file except in compliance with the License.
end_comment

begin_comment
comment|// You may obtain a copy of the License at
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// http://www.apache.org/licenses/LICENSE-2.0
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Unless required by applicable law or agreed to in writing, software
end_comment

begin_comment
comment|// distributed under the License is distributed on an "AS IS" BASIS,
end_comment

begin_comment
comment|// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
end_comment

begin_comment
comment|// See the License for the specific language governing permissions and
end_comment

begin_comment
comment|// limitations under the License.
end_comment

begin_package
DECL|package|com.google.gerrit.acceptance
package|package
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
package|;
end_package

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|truth
operator|.
name|Truth
operator|.
name|assertThat
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|GitUtil
operator|.
name|initSsh
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|group
operator|.
name|SystemGroupBackend
operator|.
name|REGISTERED_USERS
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|project
operator|.
name|Util
operator|.
name|block
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Function
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Optional
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Strings
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Iterables
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Sets
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|primitives
operator|.
name|Chars
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|AcceptanceTestRequestScope
operator|.
name|Context
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|Nullable
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|AccessSection
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|Permission
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|PermissionRule
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|GerritApi
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|changes
operator|.
name|ReviewInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|changes
operator|.
name|RevisionApi
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|projects
operator|.
name|BranchApi
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|projects
operator|.
name|BranchInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|projects
operator|.
name|ProjectInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|InheritableBoolean
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|ListChangesOption
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|SubmitType
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|ActionInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|ChangeInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|EditInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|RestApiException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|AccountGroup
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|Branch
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|Project
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|server
operator|.
name|ReviewDb
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|AnonymousUser
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|GerritPersonIdent
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|IdentifiedUser
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|OutputFormat
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|AccountCache
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|GroupCache
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|config
operator|.
name|AllProjectsName
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|config
operator|.
name|CanonicalWebUrl
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|config
operator|.
name|GerritServerConfig
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|git
operator|.
name|GitRepositoryManager
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|git
operator|.
name|MetaDataUpdate
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|git
operator|.
name|ProjectConfig
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|index
operator|.
name|ChangeIndexer
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|notedb
operator|.
name|NotesMigration
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|project
operator|.
name|ProjectCache
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|project
operator|.
name|Util
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|query
operator|.
name|change
operator|.
name|InternalChangeQuery
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|testutil
operator|.
name|ConfigSuite
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|testutil
operator|.
name|TempFileUtil
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gson
operator|.
name|Gson
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gwtorm
operator|.
name|server
operator|.
name|SchemaFactory
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|Inject
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|Provider
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|util
operator|.
name|Providers
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|api
operator|.
name|Git
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|errors
operator|.
name|ConfigInvalidException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|errors
operator|.
name|RepositoryNotFoundException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|internal
operator|.
name|storage
operator|.
name|dfs
operator|.
name|InMemoryRepository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|junit
operator|.
name|TestRepository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|Config
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|ObjectId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|PersonIdent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|Repository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|transport
operator|.
name|Transport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|AfterClass
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Rule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|rules
operator|.
name|ExpectedException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|rules
operator|.
name|TemporaryFolder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|rules
operator|.
name|TestRule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|runner
operator|.
name|Description
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|runner
operator|.
name|RunWith
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|runners
operator|.
name|model
operator|.
name|Statement
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import

begin_class
annotation|@
name|RunWith
argument_list|(
name|ConfigSuite
operator|.
name|class
argument_list|)
DECL|class|AbstractDaemonTest
specifier|public
specifier|abstract
class|class
name|AbstractDaemonTest
block|{
DECL|field|commonServer
specifier|private
specifier|static
name|GerritServer
name|commonServer
decl_stmt|;
annotation|@
name|ConfigSuite
operator|.
name|Parameter
DECL|field|baseConfig
specifier|public
name|Config
name|baseConfig
decl_stmt|;
annotation|@
name|ConfigSuite
operator|.
name|Name
DECL|field|configName
specifier|private
name|String
name|configName
decl_stmt|;
annotation|@
name|Inject
DECL|field|allProjects
specifier|protected
name|AllProjectsName
name|allProjects
decl_stmt|;
annotation|@
name|Inject
DECL|field|accounts
specifier|protected
name|AccountCreator
name|accounts
decl_stmt|;
annotation|@
name|Inject
DECL|field|reviewDbProvider
specifier|private
name|SchemaFactory
argument_list|<
name|ReviewDb
argument_list|>
name|reviewDbProvider
decl_stmt|;
annotation|@
name|Inject
DECL|field|gApi
specifier|protected
name|GerritApi
name|gApi
decl_stmt|;
annotation|@
name|Inject
DECL|field|atrScope
specifier|protected
name|AcceptanceTestRequestScope
name|atrScope
decl_stmt|;
annotation|@
name|Inject
DECL|field|accountCache
specifier|protected
name|AccountCache
name|accountCache
decl_stmt|;
annotation|@
name|Inject
DECL|field|identifiedUserFactory
specifier|private
name|IdentifiedUser
operator|.
name|GenericFactory
name|identifiedUserFactory
decl_stmt|;
annotation|@
name|Inject
DECL|field|pushFactory
specifier|protected
name|PushOneCommit
operator|.
name|Factory
name|pushFactory
decl_stmt|;
annotation|@
name|Inject
DECL|field|metaDataUpdateFactory
specifier|protected
name|MetaDataUpdate
operator|.
name|Server
name|metaDataUpdateFactory
decl_stmt|;
annotation|@
name|Inject
DECL|field|projectCache
specifier|protected
name|ProjectCache
name|projectCache
decl_stmt|;
annotation|@
name|Inject
DECL|field|groupCache
specifier|protected
name|GroupCache
name|groupCache
decl_stmt|;
annotation|@
name|Inject
DECL|field|repoManager
specifier|protected
name|GitRepositoryManager
name|repoManager
decl_stmt|;
annotation|@
name|Inject
DECL|field|indexer
specifier|protected
name|ChangeIndexer
name|indexer
decl_stmt|;
annotation|@
name|Inject
DECL|field|queryProvider
specifier|protected
name|Provider
argument_list|<
name|InternalChangeQuery
argument_list|>
name|queryProvider
decl_stmt|;
annotation|@
name|Inject
annotation|@
name|CanonicalWebUrl
DECL|field|canonicalWebUrl
specifier|protected
name|Provider
argument_list|<
name|String
argument_list|>
name|canonicalWebUrl
decl_stmt|;
annotation|@
name|Inject
annotation|@
name|GerritServerConfig
DECL|field|cfg
specifier|protected
name|Config
name|cfg
decl_stmt|;
annotation|@
name|Inject
DECL|field|inProcessProtocol
specifier|private
name|InProcessProtocol
name|inProcessProtocol
decl_stmt|;
annotation|@
name|Inject
DECL|field|anonymousUser
specifier|private
name|Provider
argument_list|<
name|AnonymousUser
argument_list|>
name|anonymousUser
decl_stmt|;
annotation|@
name|Inject
annotation|@
name|GerritPersonIdent
DECL|field|serverIdent
specifier|protected
name|Provider
argument_list|<
name|PersonIdent
argument_list|>
name|serverIdent
decl_stmt|;
DECL|field|testRepo
specifier|protected
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|testRepo
decl_stmt|;
DECL|field|server
specifier|protected
name|GerritServer
name|server
decl_stmt|;
DECL|field|admin
specifier|protected
name|TestAccount
name|admin
decl_stmt|;
DECL|field|user
specifier|protected
name|TestAccount
name|user
decl_stmt|;
DECL|field|adminSession
specifier|protected
name|RestSession
name|adminSession
decl_stmt|;
DECL|field|userSession
specifier|protected
name|RestSession
name|userSession
decl_stmt|;
DECL|field|sshSession
specifier|protected
name|SshSession
name|sshSession
decl_stmt|;
DECL|field|db
specifier|protected
name|ReviewDb
name|db
decl_stmt|;
DECL|field|project
specifier|protected
name|Project
operator|.
name|NameKey
name|project
decl_stmt|;
annotation|@
name|Inject
DECL|field|notesMigration
specifier|protected
name|NotesMigration
name|notesMigration
decl_stmt|;
annotation|@
name|Rule
DECL|field|exception
specifier|public
name|ExpectedException
name|exception
init|=
name|ExpectedException
operator|.
name|none
argument_list|()
decl_stmt|;
DECL|field|resourcePrefix
specifier|private
name|String
name|resourcePrefix
decl_stmt|;
DECL|field|toClose
specifier|private
name|List
argument_list|<
name|Repository
argument_list|>
name|toClose
decl_stmt|;
annotation|@
name|Rule
DECL|field|testRunner
specifier|public
name|TestRule
name|testRunner
init|=
operator|new
name|TestRule
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Statement
name|apply
parameter_list|(
specifier|final
name|Statement
name|base
parameter_list|,
specifier|final
name|Description
name|description
parameter_list|)
block|{
return|return
operator|new
name|Statement
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|evaluate
parameter_list|()
throws|throws
name|Throwable
block|{
name|beforeTest
argument_list|(
name|description
argument_list|)
expr_stmt|;
try|try
block|{
name|base
operator|.
name|evaluate
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|afterTest
argument_list|()
expr_stmt|;
block|}
block|}
block|}
return|;
block|}
block|}
decl_stmt|;
annotation|@
name|Rule
DECL|field|tempSiteDir
specifier|public
name|TemporaryFolder
name|tempSiteDir
init|=
operator|new
name|TemporaryFolder
argument_list|()
decl_stmt|;
annotation|@
name|AfterClass
DECL|method|stopCommonServer ()
specifier|public
specifier|static
name|void
name|stopCommonServer
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|commonServer
operator|!=
literal|null
condition|)
block|{
name|commonServer
operator|.
name|stop
argument_list|()
expr_stmt|;
name|commonServer
operator|=
literal|null
expr_stmt|;
block|}
name|TempFileUtil
operator|.
name|cleanup
argument_list|()
expr_stmt|;
block|}
DECL|method|submitWholeTopicEnabledConfig ()
specifier|protected
specifier|static
name|Config
name|submitWholeTopicEnabledConfig
parameter_list|()
block|{
name|Config
name|cfg
init|=
operator|new
name|Config
argument_list|()
decl_stmt|;
name|cfg
operator|.
name|setBoolean
argument_list|(
literal|"change"
argument_list|,
literal|null
argument_list|,
literal|"submitWholeTopic"
argument_list|,
literal|true
argument_list|)
expr_stmt|;
return|return
name|cfg
return|;
block|}
DECL|method|allowDraftsDisabledConfig ()
specifier|protected
specifier|static
name|Config
name|allowDraftsDisabledConfig
parameter_list|()
block|{
name|Config
name|cfg
init|=
operator|new
name|Config
argument_list|()
decl_stmt|;
name|cfg
operator|.
name|setBoolean
argument_list|(
literal|"change"
argument_list|,
literal|null
argument_list|,
literal|"allowDrafts"
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
name|cfg
return|;
block|}
DECL|method|isAllowDrafts ()
specifier|protected
name|boolean
name|isAllowDrafts
parameter_list|()
block|{
return|return
name|cfg
operator|.
name|getBoolean
argument_list|(
literal|"change"
argument_list|,
literal|"allowDrafts"
argument_list|,
literal|true
argument_list|)
return|;
block|}
DECL|method|isSubmitWholeTopicEnabled ()
specifier|protected
name|boolean
name|isSubmitWholeTopicEnabled
parameter_list|()
block|{
return|return
name|cfg
operator|.
name|getBoolean
argument_list|(
literal|"change"
argument_list|,
literal|null
argument_list|,
literal|"submitWholeTopic"
argument_list|,
literal|false
argument_list|)
return|;
block|}
DECL|method|isNoteDbTestEnabled ()
specifier|private
specifier|static
name|boolean
name|isNoteDbTestEnabled
parameter_list|()
block|{
specifier|final
name|String
index|[]
name|RUN_FLAGS
init|=
block|{
literal|"yes"
block|,
literal|"y"
block|,
literal|"true"
block|}
decl_stmt|;
name|String
name|value
init|=
name|System
operator|.
name|getenv
argument_list|(
literal|"GERRIT_ENABLE_NOTEDB"
argument_list|)
decl_stmt|;
return|return
name|value
operator|!=
literal|null
operator|&&
name|Arrays
operator|.
name|asList
argument_list|(
name|RUN_FLAGS
argument_list|)
operator|.
name|contains
argument_list|(
name|value
operator|.
name|toLowerCase
argument_list|()
argument_list|)
return|;
block|}
DECL|method|beforeTest (Description description)
specifier|protected
name|void
name|beforeTest
parameter_list|(
name|Description
name|description
parameter_list|)
throws|throws
name|Exception
block|{
name|GerritServer
operator|.
name|Description
name|classDesc
init|=
name|GerritServer
operator|.
name|Description
operator|.
name|forTestClass
argument_list|(
name|description
argument_list|,
name|configName
argument_list|)
decl_stmt|;
name|GerritServer
operator|.
name|Description
name|methodDesc
init|=
name|GerritServer
operator|.
name|Description
operator|.
name|forTestMethod
argument_list|(
name|description
argument_list|,
name|configName
argument_list|)
decl_stmt|;
if|if
condition|(
name|isNoteDbTestEnabled
argument_list|()
condition|)
block|{
name|NotesMigration
operator|.
name|setAllEnabledConfig
argument_list|(
name|baseConfig
argument_list|)
expr_stmt|;
block|}
name|baseConfig
operator|.
name|setString
argument_list|(
literal|"gerrit"
argument_list|,
literal|null
argument_list|,
literal|"tempSiteDir"
argument_list|,
name|tempSiteDir
operator|.
name|getRoot
argument_list|()
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|classDesc
operator|.
name|equals
argument_list|(
name|methodDesc
argument_list|)
operator|&&
operator|!
name|classDesc
operator|.
name|sandboxed
argument_list|()
operator|&&
operator|!
name|methodDesc
operator|.
name|sandboxed
argument_list|()
condition|)
block|{
if|if
condition|(
name|commonServer
operator|==
literal|null
condition|)
block|{
name|commonServer
operator|=
name|GerritServer
operator|.
name|start
argument_list|(
name|classDesc
argument_list|,
name|baseConfig
argument_list|)
expr_stmt|;
block|}
name|server
operator|=
name|commonServer
expr_stmt|;
block|}
else|else
block|{
name|server
operator|=
name|GerritServer
operator|.
name|start
argument_list|(
name|methodDesc
argument_list|,
name|baseConfig
argument_list|)
expr_stmt|;
block|}
name|server
operator|.
name|getTestInjector
argument_list|()
operator|.
name|injectMembers
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|Transport
operator|.
name|register
argument_list|(
name|inProcessProtocol
argument_list|)
expr_stmt|;
name|toClose
operator|=
name|Collections
operator|.
name|synchronizedList
argument_list|(
operator|new
name|ArrayList
argument_list|<
name|Repository
argument_list|>
argument_list|()
argument_list|)
expr_stmt|;
name|admin
operator|=
name|accounts
operator|.
name|admin
argument_list|()
expr_stmt|;
name|user
operator|=
name|accounts
operator|.
name|user
argument_list|()
expr_stmt|;
comment|// Evict cached user state in case tests modify it.
name|accountCache
operator|.
name|evict
argument_list|(
name|admin
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|accountCache
operator|.
name|evict
argument_list|(
name|user
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|adminSession
operator|=
operator|new
name|RestSession
argument_list|(
name|server
argument_list|,
name|admin
argument_list|)
expr_stmt|;
name|userSession
operator|=
operator|new
name|RestSession
argument_list|(
name|server
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|initSsh
argument_list|(
name|admin
argument_list|)
expr_stmt|;
name|db
operator|=
name|reviewDbProvider
operator|.
name|open
argument_list|()
expr_stmt|;
name|Context
name|ctx
init|=
name|newRequestContext
argument_list|(
name|admin
argument_list|)
decl_stmt|;
name|atrScope
operator|.
name|set
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|sshSession
operator|=
name|ctx
operator|.
name|getSession
argument_list|()
expr_stmt|;
name|sshSession
operator|.
name|open
argument_list|()
expr_stmt|;
name|resourcePrefix
operator|=
name|UNSAFE_PROJECT_NAME
operator|.
name|matcher
argument_list|(
name|description
operator|.
name|getClassName
argument_list|()
operator|+
literal|"_"
operator|+
name|description
operator|.
name|getMethodName
argument_list|()
operator|+
literal|"_"
argument_list|)
operator|.
name|replaceAll
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|project
operator|=
name|createProject
argument_list|(
name|projectInput
argument_list|(
name|description
argument_list|)
argument_list|)
expr_stmt|;
name|testRepo
operator|=
name|cloneProject
argument_list|(
name|project
argument_list|,
name|getCloneAsAccount
argument_list|(
name|description
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|getCloneAsAccount (Description description)
specifier|private
name|TestAccount
name|getCloneAsAccount
parameter_list|(
name|Description
name|description
parameter_list|)
block|{
name|TestProjectInput
name|ann
init|=
name|description
operator|.
name|getAnnotation
argument_list|(
name|TestProjectInput
operator|.
name|class
argument_list|)
decl_stmt|;
return|return
name|accounts
operator|.
name|get
argument_list|(
name|ann
operator|!=
literal|null
condition|?
name|ann
operator|.
name|cloneAs
argument_list|()
else|:
literal|"admin"
argument_list|)
return|;
block|}
DECL|method|projectInput (Description description)
specifier|private
name|ProjectInput
name|projectInput
parameter_list|(
name|Description
name|description
parameter_list|)
block|{
name|ProjectInput
name|in
init|=
operator|new
name|ProjectInput
argument_list|()
decl_stmt|;
name|TestProjectInput
name|ann
init|=
name|description
operator|.
name|getAnnotation
argument_list|(
name|TestProjectInput
operator|.
name|class
argument_list|)
decl_stmt|;
name|in
operator|.
name|name
operator|=
name|name
argument_list|(
literal|"project"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ann
operator|!=
literal|null
condition|)
block|{
name|in
operator|.
name|parent
operator|=
name|Strings
operator|.
name|emptyToNull
argument_list|(
name|ann
operator|.
name|parent
argument_list|()
argument_list|)
expr_stmt|;
name|in
operator|.
name|description
operator|=
name|Strings
operator|.
name|emptyToNull
argument_list|(
name|ann
operator|.
name|description
argument_list|()
argument_list|)
expr_stmt|;
name|in
operator|.
name|createEmptyCommit
operator|=
name|ann
operator|.
name|createEmptyCommit
argument_list|()
expr_stmt|;
name|in
operator|.
name|submitType
operator|=
name|ann
operator|.
name|submitType
argument_list|()
expr_stmt|;
name|in
operator|.
name|useContentMerge
operator|=
name|ann
operator|.
name|useContributorAgreements
argument_list|()
expr_stmt|;
name|in
operator|.
name|useSignedOffBy
operator|=
name|ann
operator|.
name|useSignedOffBy
argument_list|()
expr_stmt|;
name|in
operator|.
name|useContentMerge
operator|=
name|ann
operator|.
name|useContentMerge
argument_list|()
expr_stmt|;
block|}
else|else
block|{
comment|// Defaults should match TestProjectConfig, omitting nullable values.
name|in
operator|.
name|createEmptyCommit
operator|=
literal|true
expr_stmt|;
block|}
name|updateProjectInput
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
name|in
return|;
block|}
DECL|field|UNSAFE_PROJECT_NAME
specifier|private
specifier|static
specifier|final
name|Pattern
name|UNSAFE_PROJECT_NAME
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"[^a-zA-Z0-9._/-]+"
argument_list|)
decl_stmt|;
DECL|method|git ()
specifier|protected
name|Git
name|git
parameter_list|()
block|{
return|return
name|testRepo
operator|.
name|git
argument_list|()
return|;
block|}
DECL|method|repo ()
specifier|protected
name|InMemoryRepository
name|repo
parameter_list|()
block|{
return|return
name|testRepo
operator|.
name|getRepository
argument_list|()
return|;
block|}
comment|/**    * Return a resource name scoped to this test method.    *<p>    * Test methods in a single class by default share a running server. For any    * resource name you require to be unique to a test method, wrap it in a call    * to this method.    *    * @param name resource name (group, project, topic, etc.)    * @return name prefixed by a string unique to this test method.    */
DECL|method|name (String name)
specifier|protected
name|String
name|name
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|resourcePrefix
operator|+
name|name
return|;
block|}
DECL|method|createProject (String nameSuffix)
specifier|protected
name|Project
operator|.
name|NameKey
name|createProject
parameter_list|(
name|String
name|nameSuffix
parameter_list|)
throws|throws
name|RestApiException
block|{
return|return
name|createProject
argument_list|(
name|nameSuffix
argument_list|,
literal|null
argument_list|)
return|;
block|}
DECL|method|createProject (String nameSuffix, Project.NameKey parent)
specifier|protected
name|Project
operator|.
name|NameKey
name|createProject
parameter_list|(
name|String
name|nameSuffix
parameter_list|,
name|Project
operator|.
name|NameKey
name|parent
parameter_list|)
throws|throws
name|RestApiException
block|{
comment|// Default for createEmptyCommit should match TestProjectConfig.
return|return
name|createProject
argument_list|(
name|nameSuffix
argument_list|,
name|parent
argument_list|,
literal|true
argument_list|)
return|;
block|}
DECL|method|createProject (String nameSuffix, Project.NameKey parent, boolean createEmptyCommit)
specifier|protected
name|Project
operator|.
name|NameKey
name|createProject
parameter_list|(
name|String
name|nameSuffix
parameter_list|,
name|Project
operator|.
name|NameKey
name|parent
parameter_list|,
name|boolean
name|createEmptyCommit
parameter_list|)
throws|throws
name|RestApiException
block|{
return|return
name|createProject
argument_list|(
name|nameSuffix
argument_list|,
name|parent
argument_list|,
name|createEmptyCommit
argument_list|,
name|SubmitType
operator|.
name|MERGE_IF_NECESSARY
argument_list|)
return|;
block|}
DECL|method|createProject (String nameSuffix, Project.NameKey parent, boolean createEmptyCommit, SubmitType submitType)
specifier|protected
name|Project
operator|.
name|NameKey
name|createProject
parameter_list|(
name|String
name|nameSuffix
parameter_list|,
name|Project
operator|.
name|NameKey
name|parent
parameter_list|,
name|boolean
name|createEmptyCommit
parameter_list|,
name|SubmitType
name|submitType
parameter_list|)
throws|throws
name|RestApiException
block|{
name|ProjectInput
name|in
init|=
operator|new
name|ProjectInput
argument_list|()
decl_stmt|;
name|in
operator|.
name|name
operator|=
name|name
argument_list|(
name|nameSuffix
argument_list|)
expr_stmt|;
name|in
operator|.
name|parent
operator|=
name|parent
operator|!=
literal|null
condition|?
name|parent
operator|.
name|get
argument_list|()
else|:
literal|null
expr_stmt|;
name|in
operator|.
name|createEmptyCommit
operator|=
name|createEmptyCommit
expr_stmt|;
name|in
operator|.
name|submitType
operator|=
name|submitType
expr_stmt|;
return|return
name|createProject
argument_list|(
name|in
argument_list|)
return|;
block|}
DECL|method|createProject (ProjectInput in)
specifier|private
name|Project
operator|.
name|NameKey
name|createProject
parameter_list|(
name|ProjectInput
name|in
parameter_list|)
throws|throws
name|RestApiException
block|{
name|gApi
operator|.
name|projects
argument_list|()
operator|.
name|create
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
operator|new
name|Project
operator|.
name|NameKey
argument_list|(
name|in
operator|.
name|name
argument_list|)
return|;
block|}
comment|/**    * Modify a project input before creating the initial test project.    *    * @param in input; may be modified in place.    */
DECL|method|updateProjectInput (ProjectInput in)
specifier|protected
name|void
name|updateProjectInput
parameter_list|(
name|ProjectInput
name|in
parameter_list|)
block|{
comment|// Default implementation does nothing.
block|}
DECL|method|cloneProject (Project.NameKey p)
specifier|protected
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|cloneProject
parameter_list|(
name|Project
operator|.
name|NameKey
name|p
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|cloneProject
argument_list|(
name|p
argument_list|,
name|admin
argument_list|)
return|;
block|}
DECL|method|cloneProject (Project.NameKey p, TestAccount testAccount)
specifier|protected
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|cloneProject
parameter_list|(
name|Project
operator|.
name|NameKey
name|p
parameter_list|,
name|TestAccount
name|testAccount
parameter_list|)
throws|throws
name|Exception
block|{
name|InProcessProtocol
operator|.
name|Context
name|ctx
init|=
operator|new
name|InProcessProtocol
operator|.
name|Context
argument_list|(
name|reviewDbProvider
argument_list|,
name|identifiedUserFactory
argument_list|,
name|testAccount
operator|.
name|getId
argument_list|()
argument_list|,
name|p
argument_list|)
decl_stmt|;
name|Repository
name|repo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|p
argument_list|)
decl_stmt|;
name|toClose
operator|.
name|add
argument_list|(
name|repo
argument_list|)
expr_stmt|;
return|return
name|GitUtil
operator|.
name|cloneProject
argument_list|(
name|p
argument_list|,
name|inProcessProtocol
operator|.
name|register
argument_list|(
name|ctx
argument_list|,
name|repo
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
return|;
block|}
DECL|method|afterTest ()
specifier|private
name|void
name|afterTest
parameter_list|()
throws|throws
name|Exception
block|{
name|Transport
operator|.
name|unregister
argument_list|(
name|inProcessProtocol
argument_list|)
expr_stmt|;
for|for
control|(
name|Repository
name|repo
range|:
name|toClose
control|)
block|{
name|repo
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
name|db
operator|.
name|close
argument_list|()
expr_stmt|;
name|sshSession
operator|.
name|close
argument_list|()
expr_stmt|;
if|if
condition|(
name|server
operator|!=
name|commonServer
condition|)
block|{
name|server
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|commitBuilder ()
specifier|protected
name|TestRepository
argument_list|<
name|?
argument_list|>
operator|.
name|CommitBuilder
name|commitBuilder
parameter_list|()
throws|throws
name|Exception
block|{
return|return
name|testRepo
operator|.
name|branch
argument_list|(
literal|"HEAD"
argument_list|)
operator|.
name|commit
argument_list|()
operator|.
name|insertChangeId
argument_list|()
return|;
block|}
DECL|method|amendBuilder ()
specifier|protected
name|TestRepository
argument_list|<
name|?
argument_list|>
operator|.
name|CommitBuilder
name|amendBuilder
parameter_list|()
throws|throws
name|Exception
block|{
name|ObjectId
name|head
init|=
name|repo
argument_list|()
operator|.
name|exactRef
argument_list|(
literal|"HEAD"
argument_list|)
operator|.
name|getObjectId
argument_list|()
decl_stmt|;
name|TestRepository
argument_list|<
name|?
argument_list|>
operator|.
name|CommitBuilder
name|b
init|=
name|testRepo
operator|.
name|amendRef
argument_list|(
literal|"HEAD"
argument_list|)
decl_stmt|;
name|Optional
argument_list|<
name|String
argument_list|>
name|id
init|=
name|GitUtil
operator|.
name|getChangeId
argument_list|(
name|testRepo
argument_list|,
name|head
argument_list|)
decl_stmt|;
comment|// TestRepository behaves like "git commit --amend -m foo", which does not
comment|// preserve an existing Change-Id. Tests probably want this.
if|if
condition|(
name|id
operator|.
name|isPresent
argument_list|()
condition|)
block|{
name|b
operator|.
name|insertChangeId
argument_list|(
name|id
operator|.
name|get
argument_list|()
operator|.
name|substring
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|b
operator|.
name|insertChangeId
argument_list|()
expr_stmt|;
block|}
return|return
name|b
return|;
block|}
DECL|method|createChange ()
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|createChange
parameter_list|()
throws|throws
name|Exception
block|{
name|PushOneCommit
name|push
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|admin
operator|.
name|getIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|)
decl_stmt|;
name|PushOneCommit
operator|.
name|Result
name|result
init|=
name|push
operator|.
name|to
argument_list|(
literal|"refs/for/master"
argument_list|)
decl_stmt|;
name|result
operator|.
name|assertOkStatus
argument_list|()
expr_stmt|;
return|return
name|result
return|;
block|}
DECL|method|createBranchWithRevision (Branch.NameKey branch, String revision)
specifier|protected
name|BranchApi
name|createBranchWithRevision
parameter_list|(
name|Branch
operator|.
name|NameKey
name|branch
parameter_list|,
name|String
name|revision
parameter_list|)
throws|throws
name|Exception
block|{
name|BranchInput
name|in
init|=
operator|new
name|BranchInput
argument_list|()
decl_stmt|;
name|in
operator|.
name|revision
operator|=
name|revision
expr_stmt|;
return|return
name|gApi
operator|.
name|projects
argument_list|()
operator|.
name|name
argument_list|(
name|branch
operator|.
name|getParentKey
argument_list|()
operator|.
name|get
argument_list|()
argument_list|)
operator|.
name|branch
argument_list|(
name|branch
operator|.
name|get
argument_list|()
argument_list|)
operator|.
name|create
argument_list|(
name|in
argument_list|)
return|;
block|}
DECL|field|RANDOM
specifier|private
specifier|static
specifier|final
name|List
argument_list|<
name|Character
argument_list|>
name|RANDOM
init|=
name|Chars
operator|.
name|asList
argument_list|(
operator|new
name|char
index|[]
block|{
literal|'a'
block|,
literal|'b'
block|,
literal|'c'
block|,
literal|'d'
block|,
literal|'e'
block|,
literal|'f'
block|,
literal|'g'
block|,
literal|'h'
block|}
argument_list|)
decl_stmt|;
DECL|method|amendChange (String changeId)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|amendChange
parameter_list|(
name|String
name|changeId
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|amendChange
argument_list|(
name|changeId
argument_list|,
literal|"refs/for/master"
argument_list|)
return|;
block|}
DECL|method|amendChange (String changeId, String ref)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|amendChange
parameter_list|(
name|String
name|changeId
parameter_list|,
name|String
name|ref
parameter_list|)
throws|throws
name|Exception
block|{
name|Collections
operator|.
name|shuffle
argument_list|(
name|RANDOM
argument_list|)
expr_stmt|;
name|PushOneCommit
name|push
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|admin
operator|.
name|getIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|,
name|PushOneCommit
operator|.
name|SUBJECT
argument_list|,
name|PushOneCommit
operator|.
name|FILE_NAME
argument_list|,
operator|new
name|String
argument_list|(
name|Chars
operator|.
name|toArray
argument_list|(
name|RANDOM
argument_list|)
argument_list|)
argument_list|,
name|changeId
argument_list|)
decl_stmt|;
return|return
name|push
operator|.
name|to
argument_list|(
name|ref
argument_list|)
return|;
block|}
DECL|method|amendChangeAsDraft (String changeId)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|amendChangeAsDraft
parameter_list|(
name|String
name|changeId
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|amendChange
argument_list|(
name|changeId
argument_list|,
literal|"refs/drafts/master"
argument_list|)
return|;
block|}
DECL|method|info (String id)
specifier|protected
name|ChangeInfo
name|info
parameter_list|(
name|String
name|id
parameter_list|)
throws|throws
name|RestApiException
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|info
argument_list|()
return|;
block|}
DECL|method|get (String id)
specifier|protected
name|ChangeInfo
name|get
parameter_list|(
name|String
name|id
parameter_list|)
throws|throws
name|RestApiException
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|get
argument_list|()
return|;
block|}
DECL|method|getEdit (String id)
specifier|protected
name|EditInfo
name|getEdit
parameter_list|(
name|String
name|id
parameter_list|)
throws|throws
name|RestApiException
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|getEdit
argument_list|()
return|;
block|}
DECL|method|get (String id, ListChangesOption... options)
specifier|protected
name|ChangeInfo
name|get
parameter_list|(
name|String
name|id
parameter_list|,
name|ListChangesOption
modifier|...
name|options
parameter_list|)
throws|throws
name|RestApiException
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|get
argument_list|(
name|Sets
operator|.
name|newEnumSet
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|options
argument_list|)
argument_list|,
name|ListChangesOption
operator|.
name|class
argument_list|)
argument_list|)
return|;
block|}
DECL|method|query (String q)
specifier|protected
name|List
argument_list|<
name|ChangeInfo
argument_list|>
name|query
parameter_list|(
name|String
name|q
parameter_list|)
throws|throws
name|RestApiException
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|query
argument_list|(
name|q
argument_list|)
operator|.
name|get
argument_list|()
return|;
block|}
DECL|method|newRequestContext (TestAccount account)
specifier|private
name|Context
name|newRequestContext
parameter_list|(
name|TestAccount
name|account
parameter_list|)
block|{
return|return
name|atrScope
operator|.
name|newContext
argument_list|(
name|reviewDbProvider
argument_list|,
operator|new
name|SshSession
argument_list|(
name|server
argument_list|,
name|admin
argument_list|)
argument_list|,
name|identifiedUserFactory
operator|.
name|create
argument_list|(
name|Providers
operator|.
name|of
argument_list|(
name|db
argument_list|)
argument_list|,
name|account
operator|.
name|getId
argument_list|()
argument_list|)
argument_list|)
return|;
block|}
DECL|method|setApiUser (TestAccount account)
specifier|protected
name|Context
name|setApiUser
parameter_list|(
name|TestAccount
name|account
parameter_list|)
block|{
return|return
name|atrScope
operator|.
name|set
argument_list|(
name|newRequestContext
argument_list|(
name|account
argument_list|)
argument_list|)
return|;
block|}
DECL|method|setApiUserAnonymous ()
specifier|protected
name|Context
name|setApiUserAnonymous
parameter_list|()
block|{
return|return
name|atrScope
operator|.
name|newContext
argument_list|(
name|reviewDbProvider
argument_list|,
literal|null
argument_list|,
name|anonymousUser
operator|.
name|get
argument_list|()
argument_list|)
return|;
block|}
DECL|method|newGson ()
specifier|protected
specifier|static
name|Gson
name|newGson
parameter_list|()
block|{
return|return
name|OutputFormat
operator|.
name|JSON_COMPACT
operator|.
name|newGson
argument_list|()
return|;
block|}
DECL|method|revision (PushOneCommit.Result r)
specifier|protected
name|RevisionApi
name|revision
parameter_list|(
name|PushOneCommit
operator|.
name|Result
name|r
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|r
operator|.
name|getChangeId
argument_list|()
argument_list|)
operator|.
name|current
argument_list|()
return|;
block|}
DECL|method|allow (String permission, AccountGroup.UUID id, String ref)
specifier|protected
name|void
name|allow
parameter_list|(
name|String
name|permission
parameter_list|,
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|,
name|String
name|ref
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|project
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
name|Util
operator|.
name|allow
argument_list|(
name|cfg
argument_list|,
name|permission
argument_list|,
name|id
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|saveProjectConfig
argument_list|(
name|project
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
DECL|method|allowGlobalCapabilities (AccountGroup.UUID id, String... capabilityNames)
specifier|protected
name|void
name|allowGlobalCapabilities
parameter_list|(
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|,
name|String
modifier|...
name|capabilityNames
parameter_list|)
throws|throws
name|Exception
block|{
name|allowGlobalCapabilities
argument_list|(
name|id
argument_list|,
name|Arrays
operator|.
name|asList
argument_list|(
name|capabilityNames
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|allowGlobalCapabilities (AccountGroup.UUID id, Iterable<String> capabilityNames)
specifier|protected
name|void
name|allowGlobalCapabilities
parameter_list|(
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|,
name|Iterable
argument_list|<
name|String
argument_list|>
name|capabilityNames
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|allProjects
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|capabilityName
range|:
name|capabilityNames
control|)
block|{
name|Util
operator|.
name|allow
argument_list|(
name|cfg
argument_list|,
name|capabilityName
argument_list|,
name|id
argument_list|)
expr_stmt|;
block|}
name|saveProjectConfig
argument_list|(
name|allProjects
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
DECL|method|removeGlobalCapabilities (AccountGroup.UUID id, String... capabilityNames)
specifier|protected
name|void
name|removeGlobalCapabilities
parameter_list|(
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|,
name|String
modifier|...
name|capabilityNames
parameter_list|)
throws|throws
name|Exception
block|{
name|removeGlobalCapabilities
argument_list|(
name|id
argument_list|,
name|Arrays
operator|.
name|asList
argument_list|(
name|capabilityNames
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|removeGlobalCapabilities (AccountGroup.UUID id, Iterable<String> capabilityNames)
specifier|protected
name|void
name|removeGlobalCapabilities
parameter_list|(
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|,
name|Iterable
argument_list|<
name|String
argument_list|>
name|capabilityNames
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|allProjects
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|capabilityName
range|:
name|capabilityNames
control|)
block|{
name|Util
operator|.
name|remove
argument_list|(
name|cfg
argument_list|,
name|capabilityName
argument_list|,
name|id
argument_list|)
expr_stmt|;
block|}
name|saveProjectConfig
argument_list|(
name|allProjects
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
DECL|method|setUseContributorAgreements (InheritableBoolean value)
specifier|protected
name|void
name|setUseContributorAgreements
parameter_list|(
name|InheritableBoolean
name|value
parameter_list|)
throws|throws
name|Exception
block|{
name|MetaDataUpdate
name|md
init|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|project
argument_list|)
decl_stmt|;
name|ProjectConfig
name|config
init|=
name|ProjectConfig
operator|.
name|read
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|config
operator|.
name|getProject
argument_list|()
operator|.
name|setUseContributorAgreements
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|config
operator|.
name|commit
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|projectCache
operator|.
name|evict
argument_list|(
name|config
operator|.
name|getProject
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|setUseSignedOffBy (InheritableBoolean value)
specifier|protected
name|void
name|setUseSignedOffBy
parameter_list|(
name|InheritableBoolean
name|value
parameter_list|)
throws|throws
name|Exception
block|{
name|MetaDataUpdate
name|md
init|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|project
argument_list|)
decl_stmt|;
name|ProjectConfig
name|config
init|=
name|ProjectConfig
operator|.
name|read
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|config
operator|.
name|getProject
argument_list|()
operator|.
name|setUseSignedOffBy
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|config
operator|.
name|commit
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|projectCache
operator|.
name|evict
argument_list|(
name|config
operator|.
name|getProject
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|deny (String permission, AccountGroup.UUID id, String ref)
specifier|protected
name|void
name|deny
parameter_list|(
name|String
name|permission
parameter_list|,
name|AccountGroup
operator|.
name|UUID
name|id
parameter_list|,
name|String
name|ref
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|project
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
name|Util
operator|.
name|deny
argument_list|(
name|cfg
argument_list|,
name|permission
argument_list|,
name|id
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|saveProjectConfig
argument_list|(
name|project
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
DECL|method|saveProjectConfig (Project.NameKey p, ProjectConfig cfg)
specifier|protected
name|void
name|saveProjectConfig
parameter_list|(
name|Project
operator|.
name|NameKey
name|p
parameter_list|,
name|ProjectConfig
name|cfg
parameter_list|)
throws|throws
name|Exception
block|{
name|MetaDataUpdate
name|md
init|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|p
argument_list|)
decl_stmt|;
try|try
block|{
name|cfg
operator|.
name|commit
argument_list|(
name|md
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|md
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
name|projectCache
operator|.
name|evict
argument_list|(
name|cfg
operator|.
name|getProject
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|grant (String permission, Project.NameKey project, String ref)
specifier|protected
name|void
name|grant
parameter_list|(
name|String
name|permission
parameter_list|,
name|Project
operator|.
name|NameKey
name|project
parameter_list|,
name|String
name|ref
parameter_list|)
throws|throws
name|RepositoryNotFoundException
throws|,
name|IOException
throws|,
name|ConfigInvalidException
block|{
name|grant
argument_list|(
name|permission
argument_list|,
name|project
argument_list|,
name|ref
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
DECL|method|grant (String permission, Project.NameKey project, String ref, boolean force)
specifier|protected
name|void
name|grant
parameter_list|(
name|String
name|permission
parameter_list|,
name|Project
operator|.
name|NameKey
name|project
parameter_list|,
name|String
name|ref
parameter_list|,
name|boolean
name|force
parameter_list|)
throws|throws
name|RepositoryNotFoundException
throws|,
name|IOException
throws|,
name|ConfigInvalidException
block|{
name|MetaDataUpdate
name|md
init|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|project
argument_list|)
decl_stmt|;
name|md
operator|.
name|setMessage
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Grant %s on %s"
argument_list|,
name|permission
argument_list|,
name|ref
argument_list|)
argument_list|)
expr_stmt|;
name|ProjectConfig
name|config
init|=
name|ProjectConfig
operator|.
name|read
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|AccessSection
name|s
init|=
name|config
operator|.
name|getAccessSection
argument_list|(
name|ref
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|Permission
name|p
init|=
name|s
operator|.
name|getPermission
argument_list|(
name|permission
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|AccountGroup
name|adminGroup
init|=
name|groupCache
operator|.
name|get
argument_list|(
operator|new
name|AccountGroup
operator|.
name|NameKey
argument_list|(
literal|"Administrators"
argument_list|)
argument_list|)
decl_stmt|;
name|PermissionRule
name|rule
init|=
operator|new
name|PermissionRule
argument_list|(
name|config
operator|.
name|resolve
argument_list|(
name|adminGroup
argument_list|)
argument_list|)
decl_stmt|;
name|rule
operator|.
name|setForce
argument_list|(
name|force
argument_list|)
expr_stmt|;
name|p
operator|.
name|add
argument_list|(
name|rule
argument_list|)
expr_stmt|;
name|config
operator|.
name|commit
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|projectCache
operator|.
name|evict
argument_list|(
name|config
operator|.
name|getProject
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|blockRead (Project.NameKey project, String ref)
specifier|protected
name|void
name|blockRead
parameter_list|(
name|Project
operator|.
name|NameKey
name|project
parameter_list|,
name|String
name|ref
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|project
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
name|block
argument_list|(
name|cfg
argument_list|,
name|Permission
operator|.
name|READ
argument_list|,
name|REGISTERED_USERS
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|saveProjectConfig
argument_list|(
name|project
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
DECL|method|blockForgeCommitter (Project.NameKey project, String ref)
specifier|protected
name|void
name|blockForgeCommitter
parameter_list|(
name|Project
operator|.
name|NameKey
name|project
parameter_list|,
name|String
name|ref
parameter_list|)
throws|throws
name|Exception
block|{
name|ProjectConfig
name|cfg
init|=
name|projectCache
operator|.
name|checkedGet
argument_list|(
name|project
argument_list|)
operator|.
name|getConfig
argument_list|()
decl_stmt|;
name|block
argument_list|(
name|cfg
argument_list|,
name|Permission
operator|.
name|FORGE_COMMITTER
argument_list|,
name|REGISTERED_USERS
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|saveProjectConfig
argument_list|(
name|project
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
DECL|method|pushTo (String ref)
specifier|protected
name|PushOneCommit
operator|.
name|Result
name|pushTo
parameter_list|(
name|String
name|ref
parameter_list|)
throws|throws
name|Exception
block|{
name|PushOneCommit
name|push
init|=
name|pushFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|admin
operator|.
name|getIdent
argument_list|()
argument_list|,
name|testRepo
argument_list|)
decl_stmt|;
return|return
name|push
operator|.
name|to
argument_list|(
name|ref
argument_list|)
return|;
block|}
DECL|method|approve (String id)
specifier|protected
name|void
name|approve
parameter_list|(
name|String
name|id
parameter_list|)
throws|throws
name|Exception
block|{
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|revision
argument_list|(
literal|"current"
argument_list|)
operator|.
name|review
argument_list|(
name|ReviewInput
operator|.
name|approve
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|getActions (String id)
specifier|protected
name|Map
argument_list|<
name|String
argument_list|,
name|ActionInfo
argument_list|>
name|getActions
parameter_list|(
name|String
name|id
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|id
argument_list|)
operator|.
name|revision
argument_list|(
literal|1
argument_list|)
operator|.
name|actions
argument_list|()
return|;
block|}
DECL|method|assertSubmittedTogether (String chId, String... expected)
specifier|protected
name|void
name|assertSubmittedTogether
parameter_list|(
name|String
name|chId
parameter_list|,
name|String
modifier|...
name|expected
parameter_list|)
throws|throws
name|Exception
block|{
name|List
argument_list|<
name|ChangeInfo
argument_list|>
name|actual
init|=
name|gApi
operator|.
name|changes
argument_list|()
operator|.
name|id
argument_list|(
name|chId
argument_list|)
operator|.
name|submittedTogether
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|actual
argument_list|)
operator|.
name|hasSize
argument_list|(
name|expected
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|Iterables
operator|.
name|transform
argument_list|(
name|actual
argument_list|,
operator|new
name|Function
argument_list|<
name|ChangeInfo
argument_list|,
name|String
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|String
name|apply
parameter_list|(
name|ChangeInfo
name|input
parameter_list|)
block|{
return|return
name|input
operator|.
name|changeId
return|;
block|}
block|}
argument_list|)
argument_list|)
operator|.
name|containsExactly
argument_list|(
operator|(
name|Object
index|[]
operator|)
name|expected
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
DECL|method|createProjectWithPush (String name, @Nullable Project.NameKey parent, SubmitType submitType)
specifier|protected
name|TestRepository
argument_list|<
name|?
argument_list|>
name|createProjectWithPush
parameter_list|(
name|String
name|name
parameter_list|,
annotation|@
name|Nullable
name|Project
operator|.
name|NameKey
name|parent
parameter_list|,
name|SubmitType
name|submitType
parameter_list|)
throws|throws
name|Exception
block|{
name|Project
operator|.
name|NameKey
name|project
init|=
name|createProject
argument_list|(
name|name
argument_list|,
name|parent
argument_list|,
literal|true
argument_list|,
name|submitType
argument_list|)
decl_stmt|;
name|grant
argument_list|(
name|Permission
operator|.
name|PUSH
argument_list|,
name|project
argument_list|,
literal|"refs/heads/*"
argument_list|)
expr_stmt|;
name|grant
argument_list|(
name|Permission
operator|.
name|SUBMIT
argument_list|,
name|project
argument_list|,
literal|"refs/for/refs/heads/*"
argument_list|)
expr_stmt|;
return|return
name|cloneProject
argument_list|(
name|project
argument_list|)
return|;
block|}
block|}
end_class

end_unit

