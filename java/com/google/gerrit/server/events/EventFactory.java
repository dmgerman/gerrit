begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|// Copyright (C) 2010 The Android Open Source Project
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Licensed under the Apache License, Version 2.0 (the "License");
end_comment

begin_comment
comment|// you may not use this file except in compliance with the License.
end_comment

begin_comment
comment|// You may obtain a copy of the License at
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// http://www.apache.org/licenses/LICENSE-2.0
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Unless required by applicable law or agreed to in writing, software
end_comment

begin_comment
comment|// distributed under the License is distributed on an "AS IS" BASIS,
end_comment

begin_comment
comment|// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
end_comment

begin_comment
comment|// See the License for the specific language governing permissions and
end_comment

begin_comment
comment|// limitations under the License.
end_comment

begin_package
DECL|package|com.google.gerrit.server.events
package|package
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|events
package|;
end_package

begin_import
import|import static
name|java
operator|.
name|util
operator|.
name|Comparator
operator|.
name|comparing
import|;
end_import

begin_import
import|import static
name|java
operator|.
name|util
operator|.
name|Objects
operator|.
name|requireNonNull
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ListMultimap
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Lists
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|flogger
operator|.
name|FluentLogger
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|LabelType
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|LabelTypes
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|SubmitRecord
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|SubmitRequirement
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|registration
operator|.
name|DynamicItem
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|index
operator|.
name|IndexConfig
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|Account
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|Branch
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|Change
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|ChangeMessage
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|Comment
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|Patch
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|PatchSet
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|PatchSetApproval
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|UserIdentity
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|server
operator|.
name|ReviewDb
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|ApprovalsUtil
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|GerritPersonIdent
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|AccountCache
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|AccountState
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|Emails
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|change
operator|.
name|ChangeKindCache
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|config
operator|.
name|UrlFormatter
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|data
operator|.
name|AccountAttribute
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|data
operator|.
name|ApprovalAttribute
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|data
operator|.
name|ChangeAttribute
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|data
operator|.
name|DependencyAttribute
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|data
operator|.
name|MessageAttribute
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|data
operator|.
name|PatchAttribute
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|data
operator|.
name|PatchSetAttribute
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|data
operator|.
name|PatchSetCommentAttribute
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|data
operator|.
name|RefUpdateAttribute
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|data
operator|.
name|SubmitLabelAttribute
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|data
operator|.
name|SubmitRecordAttribute
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|data
operator|.
name|SubmitRequirementAttribute
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|data
operator|.
name|TrackingIdAttribute
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|notedb
operator|.
name|ChangeNotes
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|patch
operator|.
name|PatchList
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|patch
operator|.
name|PatchListCache
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|patch
operator|.
name|PatchListEntry
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|patch
operator|.
name|PatchListNotAvailableException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|patch
operator|.
name|PatchListObjectTooLargeException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|query
operator|.
name|change
operator|.
name|ChangeData
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|query
operator|.
name|change
operator|.
name|InternalChangeQuery
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gwtorm
operator|.
name|server
operator|.
name|OrmException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gwtorm
operator|.
name|server
operator|.
name|SchemaFactory
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|Inject
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|Provider
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|Singleton
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|sql
operator|.
name|Timestamp
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|ObjectId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|PersonIdent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|revwalk
operator|.
name|RevCommit
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|revwalk
operator|.
name|RevWalk
import|;
end_import

begin_class
annotation|@
name|Singleton
DECL|class|EventFactory
specifier|public
class|class
name|EventFactory
block|{
DECL|field|logger
specifier|private
specifier|static
specifier|final
name|FluentLogger
name|logger
init|=
name|FluentLogger
operator|.
name|forEnclosingClass
argument_list|()
decl_stmt|;
DECL|field|accountCache
specifier|private
specifier|final
name|AccountCache
name|accountCache
decl_stmt|;
DECL|field|urlFormatter
specifier|private
specifier|final
name|DynamicItem
argument_list|<
name|UrlFormatter
argument_list|>
name|urlFormatter
decl_stmt|;
DECL|field|emails
specifier|private
specifier|final
name|Emails
name|emails
decl_stmt|;
DECL|field|patchListCache
specifier|private
specifier|final
name|PatchListCache
name|patchListCache
decl_stmt|;
DECL|field|myIdent
specifier|private
specifier|final
name|Provider
argument_list|<
name|PersonIdent
argument_list|>
name|myIdent
decl_stmt|;
DECL|field|changeDataFactory
specifier|private
specifier|final
name|ChangeData
operator|.
name|Factory
name|changeDataFactory
decl_stmt|;
DECL|field|approvalsUtil
specifier|private
specifier|final
name|ApprovalsUtil
name|approvalsUtil
decl_stmt|;
DECL|field|changeKindCache
specifier|private
specifier|final
name|ChangeKindCache
name|changeKindCache
decl_stmt|;
DECL|field|queryProvider
specifier|private
specifier|final
name|Provider
argument_list|<
name|InternalChangeQuery
argument_list|>
name|queryProvider
decl_stmt|;
DECL|field|schema
specifier|private
specifier|final
name|SchemaFactory
argument_list|<
name|ReviewDb
argument_list|>
name|schema
decl_stmt|;
DECL|field|indexConfig
specifier|private
specifier|final
name|IndexConfig
name|indexConfig
decl_stmt|;
annotation|@
name|Inject
DECL|method|EventFactory ( AccountCache accountCache, Emails emails, DynamicItem<UrlFormatter> urlFormatter, PatchListCache patchListCache, @GerritPersonIdent Provider<PersonIdent> myIdent, ChangeData.Factory changeDataFactory, ApprovalsUtil approvalsUtil, ChangeKindCache changeKindCache, Provider<InternalChangeQuery> queryProvider, SchemaFactory<ReviewDb> schema, IndexConfig indexConfig)
name|EventFactory
parameter_list|(
name|AccountCache
name|accountCache
parameter_list|,
name|Emails
name|emails
parameter_list|,
name|DynamicItem
argument_list|<
name|UrlFormatter
argument_list|>
name|urlFormatter
parameter_list|,
name|PatchListCache
name|patchListCache
parameter_list|,
annotation|@
name|GerritPersonIdent
name|Provider
argument_list|<
name|PersonIdent
argument_list|>
name|myIdent
parameter_list|,
name|ChangeData
operator|.
name|Factory
name|changeDataFactory
parameter_list|,
name|ApprovalsUtil
name|approvalsUtil
parameter_list|,
name|ChangeKindCache
name|changeKindCache
parameter_list|,
name|Provider
argument_list|<
name|InternalChangeQuery
argument_list|>
name|queryProvider
parameter_list|,
name|SchemaFactory
argument_list|<
name|ReviewDb
argument_list|>
name|schema
parameter_list|,
name|IndexConfig
name|indexConfig
parameter_list|)
block|{
name|this
operator|.
name|accountCache
operator|=
name|accountCache
expr_stmt|;
name|this
operator|.
name|urlFormatter
operator|=
name|urlFormatter
expr_stmt|;
name|this
operator|.
name|emails
operator|=
name|emails
expr_stmt|;
name|this
operator|.
name|patchListCache
operator|=
name|patchListCache
expr_stmt|;
name|this
operator|.
name|myIdent
operator|=
name|myIdent
expr_stmt|;
name|this
operator|.
name|changeDataFactory
operator|=
name|changeDataFactory
expr_stmt|;
name|this
operator|.
name|approvalsUtil
operator|=
name|approvalsUtil
expr_stmt|;
name|this
operator|.
name|changeKindCache
operator|=
name|changeKindCache
expr_stmt|;
name|this
operator|.
name|queryProvider
operator|=
name|queryProvider
expr_stmt|;
name|this
operator|.
name|schema
operator|=
name|schema
expr_stmt|;
name|this
operator|.
name|indexConfig
operator|=
name|indexConfig
expr_stmt|;
block|}
comment|/**    * Create a ChangeAttribute for the given change suitable for serialization to JSON.    *    * @param change    * @return object suitable for serialization to JSON    */
DECL|method|asChangeAttribute (Change change, ChangeNotes notes)
specifier|public
name|ChangeAttribute
name|asChangeAttribute
parameter_list|(
name|Change
name|change
parameter_list|,
name|ChangeNotes
name|notes
parameter_list|)
block|{
try|try
init|(
name|ReviewDb
name|db
init|=
name|schema
operator|.
name|open
argument_list|()
init|)
block|{
return|return
name|asChangeAttribute
argument_list|(
name|db
argument_list|,
name|change
argument_list|,
name|notes
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|OrmException
name|e
parameter_list|)
block|{
name|logger
operator|.
name|atSevere
argument_list|()
operator|.
name|withCause
argument_list|(
name|e
argument_list|)
operator|.
name|log
argument_list|(
literal|"Cannot open database connection"
argument_list|)
expr_stmt|;
return|return
operator|new
name|ChangeAttribute
argument_list|()
return|;
block|}
block|}
comment|/**    * Create a ChangeAttribute for the given change suitable for serialization to JSON.    *    * @param db Review database    * @param change    * @return object suitable for serialization to JSON    */
DECL|method|asChangeAttribute (ReviewDb db, Change change)
specifier|public
name|ChangeAttribute
name|asChangeAttribute
parameter_list|(
name|ReviewDb
name|db
parameter_list|,
name|Change
name|change
parameter_list|)
block|{
name|ChangeAttribute
name|a
init|=
operator|new
name|ChangeAttribute
argument_list|()
decl_stmt|;
name|a
operator|.
name|project
operator|=
name|change
operator|.
name|getProject
argument_list|()
operator|.
name|get
argument_list|()
expr_stmt|;
name|a
operator|.
name|branch
operator|=
name|change
operator|.
name|getDest
argument_list|()
operator|.
name|getShortName
argument_list|()
expr_stmt|;
name|a
operator|.
name|topic
operator|=
name|change
operator|.
name|getTopic
argument_list|()
expr_stmt|;
name|a
operator|.
name|id
operator|=
name|change
operator|.
name|getKey
argument_list|()
operator|.
name|get
argument_list|()
expr_stmt|;
name|a
operator|.
name|number
operator|=
name|change
operator|.
name|getId
argument_list|()
operator|.
name|get
argument_list|()
expr_stmt|;
name|a
operator|.
name|subject
operator|=
name|change
operator|.
name|getSubject
argument_list|()
expr_stmt|;
try|try
block|{
name|a
operator|.
name|commitMessage
operator|=
name|changeDataFactory
operator|.
name|create
argument_list|(
name|db
argument_list|,
name|change
argument_list|)
operator|.
name|commitMessage
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|logger
operator|.
name|atSevere
argument_list|()
operator|.
name|withCause
argument_list|(
name|e
argument_list|)
operator|.
name|log
argument_list|(
literal|"Error while getting full commit message for change %d"
argument_list|,
name|a
operator|.
name|number
argument_list|)
expr_stmt|;
block|}
name|a
operator|.
name|url
operator|=
name|getChangeUrl
argument_list|(
name|change
argument_list|)
expr_stmt|;
name|a
operator|.
name|owner
operator|=
name|asAccountAttribute
argument_list|(
name|change
operator|.
name|getOwner
argument_list|()
argument_list|)
expr_stmt|;
name|a
operator|.
name|assignee
operator|=
name|asAccountAttribute
argument_list|(
name|change
operator|.
name|getAssignee
argument_list|()
argument_list|)
expr_stmt|;
name|a
operator|.
name|status
operator|=
name|change
operator|.
name|getStatus
argument_list|()
expr_stmt|;
name|a
operator|.
name|createdOn
operator|=
name|change
operator|.
name|getCreatedOn
argument_list|()
operator|.
name|getTime
argument_list|()
operator|/
literal|1000L
expr_stmt|;
name|a
operator|.
name|wip
operator|=
name|change
operator|.
name|isWorkInProgress
argument_list|()
condition|?
literal|true
else|:
literal|null
expr_stmt|;
name|a
operator|.
name|isPrivate
operator|=
name|change
operator|.
name|isPrivate
argument_list|()
condition|?
literal|true
else|:
literal|null
expr_stmt|;
return|return
name|a
return|;
block|}
comment|/**    * Create a ChangeAttribute for the given change suitable for serialization to JSON.    *    * @param db Review database    * @param change    * @param notes    * @return object suitable for serialization to JSON    */
DECL|method|asChangeAttribute (ReviewDb db, Change change, ChangeNotes notes)
specifier|public
name|ChangeAttribute
name|asChangeAttribute
parameter_list|(
name|ReviewDb
name|db
parameter_list|,
name|Change
name|change
parameter_list|,
name|ChangeNotes
name|notes
parameter_list|)
throws|throws
name|OrmException
block|{
name|ChangeAttribute
name|a
init|=
name|asChangeAttribute
argument_list|(
name|db
argument_list|,
name|change
argument_list|)
decl_stmt|;
name|Set
argument_list|<
name|String
argument_list|>
name|hashtags
init|=
name|notes
operator|.
name|load
argument_list|()
operator|.
name|getHashtags
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|hashtags
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|a
operator|.
name|hashtags
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|hashtags
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|a
operator|.
name|hashtags
operator|.
name|addAll
argument_list|(
name|hashtags
argument_list|)
expr_stmt|;
block|}
return|return
name|a
return|;
block|}
comment|/**    * Create a RefUpdateAttribute for the given old ObjectId, new ObjectId, and branch that is    * suitable for serialization to JSON.    *    * @param oldId    * @param newId    * @param refName    * @return object suitable for serialization to JSON    */
DECL|method|asRefUpdateAttribute ( ObjectId oldId, ObjectId newId, Branch.NameKey refName)
specifier|public
name|RefUpdateAttribute
name|asRefUpdateAttribute
parameter_list|(
name|ObjectId
name|oldId
parameter_list|,
name|ObjectId
name|newId
parameter_list|,
name|Branch
operator|.
name|NameKey
name|refName
parameter_list|)
block|{
name|RefUpdateAttribute
name|ru
init|=
operator|new
name|RefUpdateAttribute
argument_list|()
decl_stmt|;
name|ru
operator|.
name|newRev
operator|=
name|newId
operator|!=
literal|null
condition|?
name|newId
operator|.
name|getName
argument_list|()
else|:
name|ObjectId
operator|.
name|zeroId
argument_list|()
operator|.
name|getName
argument_list|()
expr_stmt|;
name|ru
operator|.
name|oldRev
operator|=
name|oldId
operator|!=
literal|null
condition|?
name|oldId
operator|.
name|getName
argument_list|()
else|:
name|ObjectId
operator|.
name|zeroId
argument_list|()
operator|.
name|getName
argument_list|()
expr_stmt|;
name|ru
operator|.
name|project
operator|=
name|refName
operator|.
name|getParentKey
argument_list|()
operator|.
name|get
argument_list|()
expr_stmt|;
name|ru
operator|.
name|refName
operator|=
name|refName
operator|.
name|get
argument_list|()
expr_stmt|;
return|return
name|ru
return|;
block|}
comment|/**    * Extend the existing ChangeAttribute with additional fields.    *    * @param a    * @param change    */
DECL|method|extend (ChangeAttribute a, Change change)
specifier|public
name|void
name|extend
parameter_list|(
name|ChangeAttribute
name|a
parameter_list|,
name|Change
name|change
parameter_list|)
block|{
name|a
operator|.
name|lastUpdated
operator|=
name|change
operator|.
name|getLastUpdatedOn
argument_list|()
operator|.
name|getTime
argument_list|()
operator|/
literal|1000L
expr_stmt|;
name|a
operator|.
name|open
operator|=
name|change
operator|.
name|getStatus
argument_list|()
operator|.
name|isOpen
argument_list|()
expr_stmt|;
block|}
comment|/**    * Add allReviewers to an existing ChangeAttribute.    *    * @param a    * @param notes    */
DECL|method|addAllReviewers (ReviewDb db, ChangeAttribute a, ChangeNotes notes)
specifier|public
name|void
name|addAllReviewers
parameter_list|(
name|ReviewDb
name|db
parameter_list|,
name|ChangeAttribute
name|a
parameter_list|,
name|ChangeNotes
name|notes
parameter_list|)
throws|throws
name|OrmException
block|{
name|Collection
argument_list|<
name|Account
operator|.
name|Id
argument_list|>
name|reviewers
init|=
name|approvalsUtil
operator|.
name|getReviewers
argument_list|(
name|db
argument_list|,
name|notes
argument_list|)
operator|.
name|all
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|reviewers
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|a
operator|.
name|allReviewers
operator|=
name|Lists
operator|.
name|newArrayListWithCapacity
argument_list|(
name|reviewers
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|Account
operator|.
name|Id
name|id
range|:
name|reviewers
control|)
block|{
name|a
operator|.
name|allReviewers
operator|.
name|add
argument_list|(
name|asAccountAttribute
argument_list|(
name|id
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**    * Add submitRecords to an existing ChangeAttribute.    *    * @param ca    * @param submitRecords    */
DECL|method|addSubmitRecords (ChangeAttribute ca, List<SubmitRecord> submitRecords)
specifier|public
name|void
name|addSubmitRecords
parameter_list|(
name|ChangeAttribute
name|ca
parameter_list|,
name|List
argument_list|<
name|SubmitRecord
argument_list|>
name|submitRecords
parameter_list|)
block|{
name|ca
operator|.
name|submitRecords
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
expr_stmt|;
for|for
control|(
name|SubmitRecord
name|submitRecord
range|:
name|submitRecords
control|)
block|{
name|SubmitRecordAttribute
name|sa
init|=
operator|new
name|SubmitRecordAttribute
argument_list|()
decl_stmt|;
name|sa
operator|.
name|status
operator|=
name|submitRecord
operator|.
name|status
operator|.
name|name
argument_list|()
expr_stmt|;
if|if
condition|(
name|submitRecord
operator|.
name|status
operator|!=
name|SubmitRecord
operator|.
name|Status
operator|.
name|RULE_ERROR
condition|)
block|{
name|addSubmitRecordLabels
argument_list|(
name|submitRecord
argument_list|,
name|sa
argument_list|)
expr_stmt|;
name|addSubmitRecordRequirements
argument_list|(
name|submitRecord
argument_list|,
name|sa
argument_list|)
expr_stmt|;
block|}
name|ca
operator|.
name|submitRecords
operator|.
name|add
argument_list|(
name|sa
argument_list|)
expr_stmt|;
block|}
comment|// Remove empty lists so a confusing label won't be displayed in the output.
if|if
condition|(
name|ca
operator|.
name|submitRecords
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|ca
operator|.
name|submitRecords
operator|=
literal|null
expr_stmt|;
block|}
block|}
DECL|method|addSubmitRecordLabels (SubmitRecord submitRecord, SubmitRecordAttribute sa)
specifier|private
name|void
name|addSubmitRecordLabels
parameter_list|(
name|SubmitRecord
name|submitRecord
parameter_list|,
name|SubmitRecordAttribute
name|sa
parameter_list|)
block|{
if|if
condition|(
name|submitRecord
operator|.
name|labels
operator|!=
literal|null
operator|&&
operator|!
name|submitRecord
operator|.
name|labels
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|sa
operator|.
name|labels
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
expr_stmt|;
for|for
control|(
name|SubmitRecord
operator|.
name|Label
name|lbl
range|:
name|submitRecord
operator|.
name|labels
control|)
block|{
name|SubmitLabelAttribute
name|la
init|=
operator|new
name|SubmitLabelAttribute
argument_list|()
decl_stmt|;
name|la
operator|.
name|label
operator|=
name|lbl
operator|.
name|label
expr_stmt|;
name|la
operator|.
name|status
operator|=
name|lbl
operator|.
name|status
operator|.
name|name
argument_list|()
expr_stmt|;
if|if
condition|(
name|lbl
operator|.
name|appliedBy
operator|!=
literal|null
condition|)
block|{
name|la
operator|.
name|by
operator|=
name|asAccountAttribute
argument_list|(
name|lbl
operator|.
name|appliedBy
argument_list|)
expr_stmt|;
block|}
name|sa
operator|.
name|labels
operator|.
name|add
argument_list|(
name|la
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|addSubmitRecordRequirements (SubmitRecord submitRecord, SubmitRecordAttribute sa)
specifier|private
name|void
name|addSubmitRecordRequirements
parameter_list|(
name|SubmitRecord
name|submitRecord
parameter_list|,
name|SubmitRecordAttribute
name|sa
parameter_list|)
block|{
if|if
condition|(
name|submitRecord
operator|.
name|requirements
operator|!=
literal|null
operator|&&
operator|!
name|submitRecord
operator|.
name|requirements
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|sa
operator|.
name|requirements
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
expr_stmt|;
for|for
control|(
name|SubmitRequirement
name|req
range|:
name|submitRecord
operator|.
name|requirements
control|)
block|{
name|SubmitRequirementAttribute
name|re
init|=
operator|new
name|SubmitRequirementAttribute
argument_list|()
decl_stmt|;
name|re
operator|.
name|fallbackText
operator|=
name|req
operator|.
name|fallbackText
argument_list|()
expr_stmt|;
name|re
operator|.
name|type
operator|=
name|req
operator|.
name|type
argument_list|()
expr_stmt|;
name|re
operator|.
name|data
operator|=
name|req
operator|.
name|data
argument_list|()
expr_stmt|;
name|sa
operator|.
name|requirements
operator|.
name|add
argument_list|(
name|re
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|addDependencies (RevWalk rw, ChangeAttribute ca, Change change, PatchSet currentPs)
specifier|public
name|void
name|addDependencies
parameter_list|(
name|RevWalk
name|rw
parameter_list|,
name|ChangeAttribute
name|ca
parameter_list|,
name|Change
name|change
parameter_list|,
name|PatchSet
name|currentPs
parameter_list|)
block|{
if|if
condition|(
name|change
operator|==
literal|null
operator|||
name|currentPs
operator|==
literal|null
condition|)
block|{
return|return;
block|}
name|ca
operator|.
name|dependsOn
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
expr_stmt|;
name|ca
operator|.
name|neededBy
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
expr_stmt|;
try|try
block|{
name|addDependsOn
argument_list|(
name|rw
argument_list|,
name|ca
argument_list|,
name|change
argument_list|,
name|currentPs
argument_list|)
expr_stmt|;
name|addNeededBy
argument_list|(
name|rw
argument_list|,
name|ca
argument_list|,
name|change
argument_list|,
name|currentPs
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|OrmException
decl||
name|IOException
name|e
parameter_list|)
block|{
comment|// Squash DB exceptions and leave dependency lists partially filled.
block|}
comment|// Remove empty lists so a confusing label won't be displayed in the output.
if|if
condition|(
name|ca
operator|.
name|dependsOn
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|ca
operator|.
name|dependsOn
operator|=
literal|null
expr_stmt|;
block|}
if|if
condition|(
name|ca
operator|.
name|neededBy
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|ca
operator|.
name|neededBy
operator|=
literal|null
expr_stmt|;
block|}
block|}
DECL|method|addDependsOn (RevWalk rw, ChangeAttribute ca, Change change, PatchSet currentPs)
specifier|private
name|void
name|addDependsOn
parameter_list|(
name|RevWalk
name|rw
parameter_list|,
name|ChangeAttribute
name|ca
parameter_list|,
name|Change
name|change
parameter_list|,
name|PatchSet
name|currentPs
parameter_list|)
throws|throws
name|OrmException
throws|,
name|IOException
block|{
name|RevCommit
name|commit
init|=
name|rw
operator|.
name|parseCommit
argument_list|(
name|ObjectId
operator|.
name|fromString
argument_list|(
name|currentPs
operator|.
name|getRevision
argument_list|()
operator|.
name|get
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|parentNames
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|commit
operator|.
name|getParentCount
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|RevCommit
name|p
range|:
name|commit
operator|.
name|getParents
argument_list|()
control|)
block|{
name|parentNames
operator|.
name|add
argument_list|(
name|p
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// Find changes in this project having a patch set matching any parent of
comment|// this patch set's revision.
for|for
control|(
name|ChangeData
name|cd
range|:
name|queryProvider
operator|.
name|get
argument_list|()
operator|.
name|byProjectCommits
argument_list|(
name|change
operator|.
name|getProject
argument_list|()
argument_list|,
name|parentNames
argument_list|)
control|)
block|{
for|for
control|(
name|PatchSet
name|ps
range|:
name|cd
operator|.
name|patchSets
argument_list|()
control|)
block|{
for|for
control|(
name|String
name|p
range|:
name|parentNames
control|)
block|{
if|if
condition|(
operator|!
name|ps
operator|.
name|getRevision
argument_list|()
operator|.
name|get
argument_list|()
operator|.
name|equals
argument_list|(
name|p
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|ca
operator|.
name|dependsOn
operator|.
name|add
argument_list|(
name|newDependsOn
argument_list|(
name|requireNonNull
argument_list|(
name|cd
operator|.
name|change
argument_list|()
argument_list|)
argument_list|,
name|ps
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|// Sort by original parent order.
name|ca
operator|.
name|dependsOn
operator|.
name|sort
argument_list|(
name|comparing
argument_list|(
name|d
lambda|->
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|parentNames
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|parentNames
operator|.
name|get
argument_list|(
name|i
argument_list|)
operator|.
name|equals
argument_list|(
name|d
operator|.
name|revision
argument_list|)
condition|)
block|{
return|return
name|i
return|;
block|}
block|}
return|return
name|parentNames
operator|.
name|size
argument_list|()
operator|+
literal|1
return|;
block|}
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|addNeededBy (RevWalk rw, ChangeAttribute ca, Change change, PatchSet currentPs)
specifier|private
name|void
name|addNeededBy
parameter_list|(
name|RevWalk
name|rw
parameter_list|,
name|ChangeAttribute
name|ca
parameter_list|,
name|Change
name|change
parameter_list|,
name|PatchSet
name|currentPs
parameter_list|)
throws|throws
name|OrmException
throws|,
name|IOException
block|{
if|if
condition|(
name|currentPs
operator|.
name|getGroups
argument_list|()
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
return|return;
block|}
name|String
name|rev
init|=
name|currentPs
operator|.
name|getRevision
argument_list|()
operator|.
name|get
argument_list|()
decl_stmt|;
comment|// Find changes in the same related group as this patch set, having a patch
comment|// set whose parent matches this patch set's revision.
for|for
control|(
name|ChangeData
name|cd
range|:
name|InternalChangeQuery
operator|.
name|byProjectGroups
argument_list|(
name|queryProvider
argument_list|,
name|indexConfig
argument_list|,
name|change
operator|.
name|getProject
argument_list|()
argument_list|,
name|currentPs
operator|.
name|getGroups
argument_list|()
argument_list|)
control|)
block|{
name|PATCH_SETS
label|:
for|for
control|(
name|PatchSet
name|ps
range|:
name|cd
operator|.
name|patchSets
argument_list|()
control|)
block|{
name|RevCommit
name|commit
init|=
name|rw
operator|.
name|parseCommit
argument_list|(
name|ObjectId
operator|.
name|fromString
argument_list|(
name|ps
operator|.
name|getRevision
argument_list|()
operator|.
name|get
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
for|for
control|(
name|RevCommit
name|p
range|:
name|commit
operator|.
name|getParents
argument_list|()
control|)
block|{
if|if
condition|(
operator|!
name|p
operator|.
name|name
argument_list|()
operator|.
name|equals
argument_list|(
name|rev
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|ca
operator|.
name|neededBy
operator|.
name|add
argument_list|(
name|newNeededBy
argument_list|(
name|requireNonNull
argument_list|(
name|cd
operator|.
name|change
argument_list|()
argument_list|)
argument_list|,
name|ps
argument_list|)
argument_list|)
expr_stmt|;
continue|continue
name|PATCH_SETS
continue|;
block|}
block|}
block|}
block|}
DECL|method|newDependsOn (Change c, PatchSet ps)
specifier|private
name|DependencyAttribute
name|newDependsOn
parameter_list|(
name|Change
name|c
parameter_list|,
name|PatchSet
name|ps
parameter_list|)
block|{
name|DependencyAttribute
name|d
init|=
name|newDependencyAttribute
argument_list|(
name|c
argument_list|,
name|ps
argument_list|)
decl_stmt|;
name|d
operator|.
name|isCurrentPatchSet
operator|=
name|ps
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
name|c
operator|.
name|currentPatchSetId
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|d
return|;
block|}
DECL|method|newNeededBy (Change c, PatchSet ps)
specifier|private
name|DependencyAttribute
name|newNeededBy
parameter_list|(
name|Change
name|c
parameter_list|,
name|PatchSet
name|ps
parameter_list|)
block|{
return|return
name|newDependencyAttribute
argument_list|(
name|c
argument_list|,
name|ps
argument_list|)
return|;
block|}
DECL|method|newDependencyAttribute (Change c, PatchSet ps)
specifier|private
name|DependencyAttribute
name|newDependencyAttribute
parameter_list|(
name|Change
name|c
parameter_list|,
name|PatchSet
name|ps
parameter_list|)
block|{
name|DependencyAttribute
name|d
init|=
operator|new
name|DependencyAttribute
argument_list|()
decl_stmt|;
name|d
operator|.
name|number
operator|=
name|c
operator|.
name|getId
argument_list|()
operator|.
name|get
argument_list|()
expr_stmt|;
name|d
operator|.
name|id
operator|=
name|c
operator|.
name|getKey
argument_list|()
operator|.
name|toString
argument_list|()
expr_stmt|;
name|d
operator|.
name|revision
operator|=
name|ps
operator|.
name|getRevision
argument_list|()
operator|.
name|get
argument_list|()
expr_stmt|;
name|d
operator|.
name|ref
operator|=
name|ps
operator|.
name|getRefName
argument_list|()
expr_stmt|;
return|return
name|d
return|;
block|}
DECL|method|addTrackingIds (ChangeAttribute a, ListMultimap<String, String> set)
specifier|public
name|void
name|addTrackingIds
parameter_list|(
name|ChangeAttribute
name|a
parameter_list|,
name|ListMultimap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|set
parameter_list|)
block|{
if|if
condition|(
operator|!
name|set
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|a
operator|.
name|trackingIds
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|set
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|Collection
argument_list|<
name|String
argument_list|>
argument_list|>
name|e
range|:
name|set
operator|.
name|asMap
argument_list|()
operator|.
name|entrySet
argument_list|()
control|)
block|{
for|for
control|(
name|String
name|id
range|:
name|e
operator|.
name|getValue
argument_list|()
control|)
block|{
name|TrackingIdAttribute
name|t
init|=
operator|new
name|TrackingIdAttribute
argument_list|()
decl_stmt|;
name|t
operator|.
name|system
operator|=
name|e
operator|.
name|getKey
argument_list|()
expr_stmt|;
name|t
operator|.
name|id
operator|=
name|id
expr_stmt|;
name|a
operator|.
name|trackingIds
operator|.
name|add
argument_list|(
name|t
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
DECL|method|addCommitMessage (ChangeAttribute a, String commitMessage)
specifier|public
name|void
name|addCommitMessage
parameter_list|(
name|ChangeAttribute
name|a
parameter_list|,
name|String
name|commitMessage
parameter_list|)
block|{
name|a
operator|.
name|commitMessage
operator|=
name|commitMessage
expr_stmt|;
block|}
DECL|method|addPatchSets ( ReviewDb db, RevWalk revWalk, ChangeAttribute ca, Collection<PatchSet> ps, Map<PatchSet.Id, Collection<PatchSetApproval>> approvals, LabelTypes labelTypes)
specifier|public
name|void
name|addPatchSets
parameter_list|(
name|ReviewDb
name|db
parameter_list|,
name|RevWalk
name|revWalk
parameter_list|,
name|ChangeAttribute
name|ca
parameter_list|,
name|Collection
argument_list|<
name|PatchSet
argument_list|>
name|ps
parameter_list|,
name|Map
argument_list|<
name|PatchSet
operator|.
name|Id
argument_list|,
name|Collection
argument_list|<
name|PatchSetApproval
argument_list|>
argument_list|>
name|approvals
parameter_list|,
name|LabelTypes
name|labelTypes
parameter_list|)
block|{
name|addPatchSets
argument_list|(
name|db
argument_list|,
name|revWalk
argument_list|,
name|ca
argument_list|,
name|ps
argument_list|,
name|approvals
argument_list|,
literal|false
argument_list|,
literal|null
argument_list|,
name|labelTypes
argument_list|)
expr_stmt|;
block|}
DECL|method|addPatchSets ( ReviewDb db, RevWalk revWalk, ChangeAttribute ca, Collection<PatchSet> ps, Map<PatchSet.Id, Collection<PatchSetApproval>> approvals, boolean includeFiles, Change change, LabelTypes labelTypes)
specifier|public
name|void
name|addPatchSets
parameter_list|(
name|ReviewDb
name|db
parameter_list|,
name|RevWalk
name|revWalk
parameter_list|,
name|ChangeAttribute
name|ca
parameter_list|,
name|Collection
argument_list|<
name|PatchSet
argument_list|>
name|ps
parameter_list|,
name|Map
argument_list|<
name|PatchSet
operator|.
name|Id
argument_list|,
name|Collection
argument_list|<
name|PatchSetApproval
argument_list|>
argument_list|>
name|approvals
parameter_list|,
name|boolean
name|includeFiles
parameter_list|,
name|Change
name|change
parameter_list|,
name|LabelTypes
name|labelTypes
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ps
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|ca
operator|.
name|patchSets
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|ps
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|PatchSet
name|p
range|:
name|ps
control|)
block|{
name|PatchSetAttribute
name|psa
init|=
name|asPatchSetAttribute
argument_list|(
name|db
argument_list|,
name|revWalk
argument_list|,
name|change
argument_list|,
name|p
argument_list|)
decl_stmt|;
if|if
condition|(
name|approvals
operator|!=
literal|null
condition|)
block|{
name|addApprovals
argument_list|(
name|psa
argument_list|,
name|p
operator|.
name|getId
argument_list|()
argument_list|,
name|approvals
argument_list|,
name|labelTypes
argument_list|)
expr_stmt|;
block|}
name|ca
operator|.
name|patchSets
operator|.
name|add
argument_list|(
name|psa
argument_list|)
expr_stmt|;
if|if
condition|(
name|includeFiles
condition|)
block|{
name|addPatchSetFileNames
argument_list|(
name|psa
argument_list|,
name|change
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
DECL|method|addPatchSetComments ( PatchSetAttribute patchSetAttribute, Collection<Comment> comments)
specifier|public
name|void
name|addPatchSetComments
parameter_list|(
name|PatchSetAttribute
name|patchSetAttribute
parameter_list|,
name|Collection
argument_list|<
name|Comment
argument_list|>
name|comments
parameter_list|)
block|{
for|for
control|(
name|Comment
name|comment
range|:
name|comments
control|)
block|{
if|if
condition|(
name|comment
operator|.
name|key
operator|.
name|patchSetId
operator|==
name|patchSetAttribute
operator|.
name|number
condition|)
block|{
if|if
condition|(
name|patchSetAttribute
operator|.
name|comments
operator|==
literal|null
condition|)
block|{
name|patchSetAttribute
operator|.
name|comments
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
expr_stmt|;
block|}
name|patchSetAttribute
operator|.
name|comments
operator|.
name|add
argument_list|(
name|asPatchSetLineAttribute
argument_list|(
name|comment
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|addPatchSetFileNames ( PatchSetAttribute patchSetAttribute, Change change, PatchSet patchSet)
specifier|public
name|void
name|addPatchSetFileNames
parameter_list|(
name|PatchSetAttribute
name|patchSetAttribute
parameter_list|,
name|Change
name|change
parameter_list|,
name|PatchSet
name|patchSet
parameter_list|)
block|{
try|try
block|{
name|PatchList
name|patchList
init|=
name|patchListCache
operator|.
name|get
argument_list|(
name|change
argument_list|,
name|patchSet
argument_list|)
decl_stmt|;
for|for
control|(
name|PatchListEntry
name|patch
range|:
name|patchList
operator|.
name|getPatches
argument_list|()
control|)
block|{
if|if
condition|(
name|patchSetAttribute
operator|.
name|files
operator|==
literal|null
condition|)
block|{
name|patchSetAttribute
operator|.
name|files
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
expr_stmt|;
block|}
name|PatchAttribute
name|p
init|=
operator|new
name|PatchAttribute
argument_list|()
decl_stmt|;
name|p
operator|.
name|file
operator|=
name|patch
operator|.
name|getNewName
argument_list|()
expr_stmt|;
name|p
operator|.
name|fileOld
operator|=
name|patch
operator|.
name|getOldName
argument_list|()
expr_stmt|;
name|p
operator|.
name|type
operator|=
name|patch
operator|.
name|getChangeType
argument_list|()
expr_stmt|;
name|p
operator|.
name|deletions
operator|-=
name|patch
operator|.
name|getDeletions
argument_list|()
expr_stmt|;
name|p
operator|.
name|insertions
operator|=
name|patch
operator|.
name|getInsertions
argument_list|()
expr_stmt|;
name|patchSetAttribute
operator|.
name|files
operator|.
name|add
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|PatchListObjectTooLargeException
name|e
parameter_list|)
block|{
name|logger
operator|.
name|atWarning
argument_list|()
operator|.
name|log
argument_list|(
literal|"Cannot get patch list: %s"
argument_list|,
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|PatchListNotAvailableException
name|e
parameter_list|)
block|{
name|logger
operator|.
name|atSevere
argument_list|()
operator|.
name|withCause
argument_list|(
name|e
argument_list|)
operator|.
name|log
argument_list|(
literal|"Cannot get patch list"
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|addComments (ChangeAttribute ca, Collection<ChangeMessage> messages)
specifier|public
name|void
name|addComments
parameter_list|(
name|ChangeAttribute
name|ca
parameter_list|,
name|Collection
argument_list|<
name|ChangeMessage
argument_list|>
name|messages
parameter_list|)
block|{
if|if
condition|(
operator|!
name|messages
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|ca
operator|.
name|comments
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
expr_stmt|;
for|for
control|(
name|ChangeMessage
name|message
range|:
name|messages
control|)
block|{
name|ca
operator|.
name|comments
operator|.
name|add
argument_list|(
name|asMessageAttribute
argument_list|(
name|message
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**    * Create a PatchSetAttribute for the given patchset suitable for serialization to JSON.    *    * @param revWalk    * @param patchSet    * @return object suitable for serialization to JSON    */
DECL|method|asPatchSetAttribute (RevWalk revWalk, Change change, PatchSet patchSet)
specifier|public
name|PatchSetAttribute
name|asPatchSetAttribute
parameter_list|(
name|RevWalk
name|revWalk
parameter_list|,
name|Change
name|change
parameter_list|,
name|PatchSet
name|patchSet
parameter_list|)
block|{
try|try
init|(
name|ReviewDb
name|db
init|=
name|schema
operator|.
name|open
argument_list|()
init|)
block|{
return|return
name|asPatchSetAttribute
argument_list|(
name|db
argument_list|,
name|revWalk
argument_list|,
name|change
argument_list|,
name|patchSet
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|OrmException
name|e
parameter_list|)
block|{
name|logger
operator|.
name|atSevere
argument_list|()
operator|.
name|withCause
argument_list|(
name|e
argument_list|)
operator|.
name|log
argument_list|(
literal|"Cannot open database connection"
argument_list|)
expr_stmt|;
return|return
operator|new
name|PatchSetAttribute
argument_list|()
return|;
block|}
block|}
comment|/**    * Create a PatchSetAttribute for the given patchset suitable for serialization to JSON.    *    * @param db Review database    * @param patchSet    * @return object suitable for serialization to JSON    */
DECL|method|asPatchSetAttribute ( ReviewDb db, RevWalk revWalk, Change change, PatchSet patchSet)
specifier|public
name|PatchSetAttribute
name|asPatchSetAttribute
parameter_list|(
name|ReviewDb
name|db
parameter_list|,
name|RevWalk
name|revWalk
parameter_list|,
name|Change
name|change
parameter_list|,
name|PatchSet
name|patchSet
parameter_list|)
block|{
name|PatchSetAttribute
name|p
init|=
operator|new
name|PatchSetAttribute
argument_list|()
decl_stmt|;
name|p
operator|.
name|revision
operator|=
name|patchSet
operator|.
name|getRevision
argument_list|()
operator|.
name|get
argument_list|()
expr_stmt|;
name|p
operator|.
name|number
operator|=
name|patchSet
operator|.
name|getPatchSetId
argument_list|()
expr_stmt|;
name|p
operator|.
name|ref
operator|=
name|patchSet
operator|.
name|getRefName
argument_list|()
expr_stmt|;
name|p
operator|.
name|uploader
operator|=
name|asAccountAttribute
argument_list|(
name|patchSet
operator|.
name|getUploader
argument_list|()
argument_list|)
expr_stmt|;
name|p
operator|.
name|createdOn
operator|=
name|patchSet
operator|.
name|getCreatedOn
argument_list|()
operator|.
name|getTime
argument_list|()
operator|/
literal|1000L
expr_stmt|;
name|PatchSet
operator|.
name|Id
name|pId
init|=
name|patchSet
operator|.
name|getId
argument_list|()
decl_stmt|;
try|try
block|{
name|p
operator|.
name|parents
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
expr_stmt|;
name|RevCommit
name|c
init|=
name|revWalk
operator|.
name|parseCommit
argument_list|(
name|ObjectId
operator|.
name|fromString
argument_list|(
name|p
operator|.
name|revision
argument_list|)
argument_list|)
decl_stmt|;
for|for
control|(
name|RevCommit
name|parent
range|:
name|c
operator|.
name|getParents
argument_list|()
control|)
block|{
name|p
operator|.
name|parents
operator|.
name|add
argument_list|(
name|parent
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|UserIdentity
name|author
init|=
name|toUserIdentity
argument_list|(
name|c
operator|.
name|getAuthorIdent
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|author
operator|.
name|getAccount
argument_list|()
operator|==
literal|null
condition|)
block|{
name|p
operator|.
name|author
operator|=
operator|new
name|AccountAttribute
argument_list|()
expr_stmt|;
name|p
operator|.
name|author
operator|.
name|email
operator|=
name|author
operator|.
name|getEmail
argument_list|()
expr_stmt|;
name|p
operator|.
name|author
operator|.
name|name
operator|=
name|author
operator|.
name|getName
argument_list|()
expr_stmt|;
name|p
operator|.
name|author
operator|.
name|username
operator|=
literal|""
expr_stmt|;
block|}
else|else
block|{
name|p
operator|.
name|author
operator|=
name|asAccountAttribute
argument_list|(
name|author
operator|.
name|getAccount
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|List
argument_list|<
name|Patch
argument_list|>
name|list
init|=
name|patchListCache
operator|.
name|get
argument_list|(
name|change
argument_list|,
name|patchSet
argument_list|)
operator|.
name|toPatchList
argument_list|(
name|pId
argument_list|)
decl_stmt|;
for|for
control|(
name|Patch
name|pe
range|:
name|list
control|)
block|{
if|if
condition|(
operator|!
name|Patch
operator|.
name|isMagic
argument_list|(
name|pe
operator|.
name|getFileName
argument_list|()
argument_list|)
condition|)
block|{
name|p
operator|.
name|sizeDeletions
operator|-=
name|pe
operator|.
name|getDeletions
argument_list|()
expr_stmt|;
name|p
operator|.
name|sizeInsertions
operator|+=
name|pe
operator|.
name|getInsertions
argument_list|()
expr_stmt|;
block|}
block|}
name|p
operator|.
name|kind
operator|=
name|changeKindCache
operator|.
name|getChangeKind
argument_list|(
name|db
argument_list|,
name|change
argument_list|,
name|patchSet
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
decl||
name|OrmException
name|e
parameter_list|)
block|{
name|logger
operator|.
name|atSevere
argument_list|()
operator|.
name|withCause
argument_list|(
name|e
argument_list|)
operator|.
name|log
argument_list|(
literal|"Cannot load patch set data for %s"
argument_list|,
name|patchSet
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|PatchListObjectTooLargeException
name|e
parameter_list|)
block|{
name|logger
operator|.
name|atWarning
argument_list|()
operator|.
name|log
argument_list|(
literal|"Cannot get size information for %s: %s"
argument_list|,
name|pId
argument_list|,
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|PatchListNotAvailableException
name|e
parameter_list|)
block|{
name|logger
operator|.
name|atSevere
argument_list|()
operator|.
name|withCause
argument_list|(
name|e
argument_list|)
operator|.
name|log
argument_list|(
literal|"Cannot get size information for %s."
argument_list|,
name|pId
argument_list|)
expr_stmt|;
block|}
return|return
name|p
return|;
block|}
comment|// TODO: The same method exists in PatchSetInfoFactory, find a common place
comment|// for it
DECL|method|toUserIdentity (PersonIdent who)
specifier|private
name|UserIdentity
name|toUserIdentity
parameter_list|(
name|PersonIdent
name|who
parameter_list|)
throws|throws
name|IOException
throws|,
name|OrmException
block|{
name|UserIdentity
name|u
init|=
operator|new
name|UserIdentity
argument_list|()
decl_stmt|;
name|u
operator|.
name|setName
argument_list|(
name|who
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|u
operator|.
name|setEmail
argument_list|(
name|who
operator|.
name|getEmailAddress
argument_list|()
argument_list|)
expr_stmt|;
name|u
operator|.
name|setDate
argument_list|(
operator|new
name|Timestamp
argument_list|(
name|who
operator|.
name|getWhen
argument_list|()
operator|.
name|getTime
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|.
name|setTimeZone
argument_list|(
name|who
operator|.
name|getTimeZoneOffset
argument_list|()
argument_list|)
expr_stmt|;
comment|// If only one account has access to this email address, select it
comment|// as the identity of the user.
comment|//
name|Set
argument_list|<
name|Account
operator|.
name|Id
argument_list|>
name|a
init|=
name|emails
operator|.
name|getAccountFor
argument_list|(
name|u
operator|.
name|getEmail
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|a
operator|.
name|size
argument_list|()
operator|==
literal|1
condition|)
block|{
name|u
operator|.
name|setAccount
argument_list|(
name|a
operator|.
name|iterator
argument_list|()
operator|.
name|next
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|u
return|;
block|}
DECL|method|addApprovals ( PatchSetAttribute p, PatchSet.Id id, Map<PatchSet.Id, Collection<PatchSetApproval>> all, LabelTypes labelTypes)
specifier|public
name|void
name|addApprovals
parameter_list|(
name|PatchSetAttribute
name|p
parameter_list|,
name|PatchSet
operator|.
name|Id
name|id
parameter_list|,
name|Map
argument_list|<
name|PatchSet
operator|.
name|Id
argument_list|,
name|Collection
argument_list|<
name|PatchSetApproval
argument_list|>
argument_list|>
name|all
parameter_list|,
name|LabelTypes
name|labelTypes
parameter_list|)
block|{
name|Collection
argument_list|<
name|PatchSetApproval
argument_list|>
name|list
init|=
name|all
operator|.
name|get
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|list
operator|!=
literal|null
condition|)
block|{
name|addApprovals
argument_list|(
name|p
argument_list|,
name|list
argument_list|,
name|labelTypes
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|addApprovals ( PatchSetAttribute p, Collection<PatchSetApproval> list, LabelTypes labelTypes)
specifier|public
name|void
name|addApprovals
parameter_list|(
name|PatchSetAttribute
name|p
parameter_list|,
name|Collection
argument_list|<
name|PatchSetApproval
argument_list|>
name|list
parameter_list|,
name|LabelTypes
name|labelTypes
parameter_list|)
block|{
if|if
condition|(
operator|!
name|list
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|p
operator|.
name|approvals
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|list
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|PatchSetApproval
name|a
range|:
name|list
control|)
block|{
if|if
condition|(
name|a
operator|.
name|getValue
argument_list|()
operator|!=
literal|0
condition|)
block|{
name|p
operator|.
name|approvals
operator|.
name|add
argument_list|(
name|asApprovalAttribute
argument_list|(
name|a
argument_list|,
name|labelTypes
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|p
operator|.
name|approvals
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|p
operator|.
name|approvals
operator|=
literal|null
expr_stmt|;
block|}
block|}
block|}
comment|/**    * Create an AuthorAttribute for the given account suitable for serialization to JSON.    *    * @param id    * @return object suitable for serialization to JSON    */
DECL|method|asAccountAttribute (Account.Id id)
specifier|public
name|AccountAttribute
name|asAccountAttribute
parameter_list|(
name|Account
operator|.
name|Id
name|id
parameter_list|)
block|{
if|if
condition|(
name|id
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
return|return
name|accountCache
operator|.
name|get
argument_list|(
name|id
argument_list|)
operator|.
name|map
argument_list|(
name|this
operator|::
name|asAccountAttribute
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
return|;
block|}
comment|/**    * Create an AuthorAttribute for the given account suitable for serialization to JSON.    *    * @param accountState the account state    * @return object suitable for serialization to JSON    */
DECL|method|asAccountAttribute (AccountState accountState)
specifier|public
name|AccountAttribute
name|asAccountAttribute
parameter_list|(
name|AccountState
name|accountState
parameter_list|)
block|{
name|AccountAttribute
name|who
init|=
operator|new
name|AccountAttribute
argument_list|()
decl_stmt|;
name|who
operator|.
name|name
operator|=
name|accountState
operator|.
name|getAccount
argument_list|()
operator|.
name|getFullName
argument_list|()
expr_stmt|;
name|who
operator|.
name|email
operator|=
name|accountState
operator|.
name|getAccount
argument_list|()
operator|.
name|getPreferredEmail
argument_list|()
expr_stmt|;
name|who
operator|.
name|username
operator|=
name|accountState
operator|.
name|getUserName
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
expr_stmt|;
return|return
name|who
return|;
block|}
comment|/**    * Create an AuthorAttribute for the given person ident suitable for serialization to JSON.    *    * @param ident    * @return object suitable for serialization to JSON    */
DECL|method|asAccountAttribute (PersonIdent ident)
specifier|public
name|AccountAttribute
name|asAccountAttribute
parameter_list|(
name|PersonIdent
name|ident
parameter_list|)
block|{
name|AccountAttribute
name|who
init|=
operator|new
name|AccountAttribute
argument_list|()
decl_stmt|;
name|who
operator|.
name|name
operator|=
name|ident
operator|.
name|getName
argument_list|()
expr_stmt|;
name|who
operator|.
name|email
operator|=
name|ident
operator|.
name|getEmailAddress
argument_list|()
expr_stmt|;
return|return
name|who
return|;
block|}
comment|/**    * Create an ApprovalAttribute for the given approval suitable for serialization to JSON.    *    * @param approval    * @param labelTypes label types for the containing project    * @return object suitable for serialization to JSON    */
DECL|method|asApprovalAttribute (PatchSetApproval approval, LabelTypes labelTypes)
specifier|public
name|ApprovalAttribute
name|asApprovalAttribute
parameter_list|(
name|PatchSetApproval
name|approval
parameter_list|,
name|LabelTypes
name|labelTypes
parameter_list|)
block|{
name|ApprovalAttribute
name|a
init|=
operator|new
name|ApprovalAttribute
argument_list|()
decl_stmt|;
name|a
operator|.
name|type
operator|=
name|approval
operator|.
name|getLabelId
argument_list|()
operator|.
name|get
argument_list|()
expr_stmt|;
name|a
operator|.
name|value
operator|=
name|Short
operator|.
name|toString
argument_list|(
name|approval
operator|.
name|getValue
argument_list|()
argument_list|)
expr_stmt|;
name|a
operator|.
name|by
operator|=
name|asAccountAttribute
argument_list|(
name|approval
operator|.
name|getAccountId
argument_list|()
argument_list|)
expr_stmt|;
name|a
operator|.
name|grantedOn
operator|=
name|approval
operator|.
name|getGranted
argument_list|()
operator|.
name|getTime
argument_list|()
operator|/
literal|1000L
expr_stmt|;
name|a
operator|.
name|oldValue
operator|=
literal|null
expr_stmt|;
name|LabelType
name|lt
init|=
name|labelTypes
operator|.
name|byLabel
argument_list|(
name|approval
operator|.
name|getLabelId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|lt
operator|!=
literal|null
condition|)
block|{
name|a
operator|.
name|description
operator|=
name|lt
operator|.
name|getName
argument_list|()
expr_stmt|;
block|}
return|return
name|a
return|;
block|}
DECL|method|asMessageAttribute (ChangeMessage message)
specifier|public
name|MessageAttribute
name|asMessageAttribute
parameter_list|(
name|ChangeMessage
name|message
parameter_list|)
block|{
name|MessageAttribute
name|a
init|=
operator|new
name|MessageAttribute
argument_list|()
decl_stmt|;
name|a
operator|.
name|timestamp
operator|=
name|message
operator|.
name|getWrittenOn
argument_list|()
operator|.
name|getTime
argument_list|()
operator|/
literal|1000L
expr_stmt|;
name|a
operator|.
name|reviewer
operator|=
name|message
operator|.
name|getAuthor
argument_list|()
operator|!=
literal|null
condition|?
name|asAccountAttribute
argument_list|(
name|message
operator|.
name|getAuthor
argument_list|()
argument_list|)
else|:
name|asAccountAttribute
argument_list|(
name|myIdent
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
name|a
operator|.
name|message
operator|=
name|message
operator|.
name|getMessage
argument_list|()
expr_stmt|;
return|return
name|a
return|;
block|}
DECL|method|asPatchSetLineAttribute (Comment c)
specifier|public
name|PatchSetCommentAttribute
name|asPatchSetLineAttribute
parameter_list|(
name|Comment
name|c
parameter_list|)
block|{
name|PatchSetCommentAttribute
name|a
init|=
operator|new
name|PatchSetCommentAttribute
argument_list|()
decl_stmt|;
name|a
operator|.
name|reviewer
operator|=
name|asAccountAttribute
argument_list|(
name|c
operator|.
name|author
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|a
operator|.
name|file
operator|=
name|c
operator|.
name|key
operator|.
name|filename
expr_stmt|;
name|a
operator|.
name|line
operator|=
name|c
operator|.
name|lineNbr
expr_stmt|;
name|a
operator|.
name|message
operator|=
name|c
operator|.
name|message
expr_stmt|;
return|return
name|a
return|;
block|}
comment|/** Get a link to the change; null if the server doesn't know its own address. */
DECL|method|getChangeUrl (Change change)
specifier|private
name|String
name|getChangeUrl
parameter_list|(
name|Change
name|change
parameter_list|)
block|{
if|if
condition|(
name|change
operator|!=
literal|null
condition|)
block|{
return|return
name|urlFormatter
operator|.
name|get
argument_list|()
operator|.
name|getChangeViewUrl
argument_list|(
name|change
operator|.
name|getProject
argument_list|()
argument_list|,
name|change
operator|.
name|getId
argument_list|()
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
return|;
block|}
return|return
literal|null
return|;
block|}
block|}
end_class

end_unit

