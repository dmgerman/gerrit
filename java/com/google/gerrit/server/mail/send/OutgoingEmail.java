begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|// Copyright (C) 2016 The Android Open Source Project
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Licensed under the Apache License, Version 2.0 (the "License");
end_comment

begin_comment
comment|// you may not use this file except in compliance with the License.
end_comment

begin_comment
comment|// You may obtain a copy of the License at
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// http://www.apache.org/licenses/LICENSE-2.0
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Unless required by applicable law or agreed to in writing, software
end_comment

begin_comment
comment|// distributed under the License is distributed on an "AS IS" BASIS,
end_comment

begin_comment
comment|// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
end_comment

begin_comment
comment|// See the License for the specific language governing permissions and
end_comment

begin_comment
comment|// limitations under the License.
end_comment

begin_package
DECL|package|com.google.gerrit.server.mail.send
package|package
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|mail
operator|.
name|send
package|;
end_package

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|GeneralPreferencesInfo
operator|.
name|EmailStrategy
operator|.
name|CC_ON_OWN_COMMENTS
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|GeneralPreferencesInfo
operator|.
name|EmailStrategy
operator|.
name|DISABLED
import|;
end_import

begin_import
import|import static
name|java
operator|.
name|util
operator|.
name|Objects
operator|.
name|requireNonNull
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Sets
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|flogger
operator|.
name|FluentLogger
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|Nullable
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|entities
operator|.
name|Account
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|entities
operator|.
name|UserIdentity
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|exceptions
operator|.
name|EmailException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|changes
operator|.
name|RecipientType
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|GeneralPreferencesInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|client
operator|.
name|GeneralPreferencesInfo
operator|.
name|EmailFormat
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|mail
operator|.
name|Address
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|mail
operator|.
name|EmailHeader
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|mail
operator|.
name|EmailHeader
operator|.
name|AddressList
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|mail
operator|.
name|MailHeader
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|AccountState
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|change
operator|.
name|NotifyResolver
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|permissions
operator|.
name|PermissionBackendException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|validators
operator|.
name|OutgoingEmailValidationListener
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|validators
operator|.
name|ValidationException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|template
operator|.
name|soy
operator|.
name|jbcsrc
operator|.
name|api
operator|.
name|SoySauce
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|MalformedURLException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URL
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Date
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedHashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Optional
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|StringJoiner
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|james
operator|.
name|mime4j
operator|.
name|dom
operator|.
name|field
operator|.
name|FieldName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|util
operator|.
name|SystemReader
import|;
end_import

begin_comment
comment|/** Sends an email to one or more interested parties. */
end_comment

begin_class
DECL|class|OutgoingEmail
specifier|public
specifier|abstract
class|class
name|OutgoingEmail
block|{
DECL|field|SOY_TEMPLATE_NAMESPACE
specifier|private
specifier|static
specifier|final
name|String
name|SOY_TEMPLATE_NAMESPACE
init|=
literal|"com.google.gerrit.server.mail.template."
decl_stmt|;
DECL|field|logger
specifier|private
specifier|static
specifier|final
name|FluentLogger
name|logger
init|=
name|FluentLogger
operator|.
name|forEnclosingClass
argument_list|()
decl_stmt|;
DECL|field|messageClass
specifier|protected
name|String
name|messageClass
decl_stmt|;
DECL|field|rcptTo
specifier|private
specifier|final
name|Set
argument_list|<
name|Account
operator|.
name|Id
argument_list|>
name|rcptTo
init|=
operator|new
name|HashSet
argument_list|<>
argument_list|()
decl_stmt|;
DECL|field|headers
specifier|private
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|EmailHeader
argument_list|>
name|headers
decl_stmt|;
DECL|field|smtpRcptTo
specifier|private
specifier|final
name|Set
argument_list|<
name|Address
argument_list|>
name|smtpRcptTo
init|=
operator|new
name|HashSet
argument_list|<>
argument_list|()
decl_stmt|;
DECL|field|smtpFromAddress
specifier|private
name|Address
name|smtpFromAddress
decl_stmt|;
DECL|field|textBody
specifier|private
name|StringBuilder
name|textBody
decl_stmt|;
DECL|field|htmlBody
specifier|private
name|StringBuilder
name|htmlBody
decl_stmt|;
DECL|field|soyContext
specifier|protected
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|soyContext
decl_stmt|;
DECL|field|soyContextEmailData
specifier|protected
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|soyContextEmailData
decl_stmt|;
DECL|field|footers
specifier|protected
name|List
argument_list|<
name|String
argument_list|>
name|footers
decl_stmt|;
DECL|field|args
specifier|protected
specifier|final
name|EmailArguments
name|args
decl_stmt|;
DECL|field|fromId
specifier|protected
name|Account
operator|.
name|Id
name|fromId
decl_stmt|;
DECL|field|notify
specifier|protected
name|NotifyResolver
operator|.
name|Result
name|notify
init|=
name|NotifyResolver
operator|.
name|Result
operator|.
name|all
argument_list|()
decl_stmt|;
DECL|method|OutgoingEmail (EmailArguments args, String messageClass)
specifier|protected
name|OutgoingEmail
parameter_list|(
name|EmailArguments
name|args
parameter_list|,
name|String
name|messageClass
parameter_list|)
block|{
name|this
operator|.
name|args
operator|=
name|args
expr_stmt|;
name|this
operator|.
name|messageClass
operator|=
name|messageClass
expr_stmt|;
name|this
operator|.
name|headers
operator|=
operator|new
name|LinkedHashMap
argument_list|<>
argument_list|()
expr_stmt|;
block|}
DECL|method|setFrom (Account.Id id)
specifier|public
name|void
name|setFrom
parameter_list|(
name|Account
operator|.
name|Id
name|id
parameter_list|)
block|{
name|fromId
operator|=
name|id
expr_stmt|;
block|}
DECL|method|setNotify (NotifyResolver.Result notify)
specifier|public
name|void
name|setNotify
parameter_list|(
name|NotifyResolver
operator|.
name|Result
name|notify
parameter_list|)
block|{
name|this
operator|.
name|notify
operator|=
name|requireNonNull
argument_list|(
name|notify
argument_list|)
expr_stmt|;
block|}
comment|/**    * Format and enqueue the message for delivery.    *    * @throws EmailException    */
DECL|method|send ()
specifier|public
name|void
name|send
parameter_list|()
throws|throws
name|EmailException
block|{
if|if
condition|(
operator|!
name|args
operator|.
name|emailSender
operator|.
name|isEnabled
argument_list|()
condition|)
block|{
comment|// Server has explicitly disabled email sending.
comment|//
name|logger
operator|.
name|atFine
argument_list|()
operator|.
name|log
argument_list|(
literal|"Not sending '%s': Email sending is disabled by server config"
argument_list|,
name|messageClass
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|notify
operator|.
name|shouldNotify
argument_list|()
condition|)
block|{
name|logger
operator|.
name|atFine
argument_list|()
operator|.
name|log
argument_list|(
literal|"Not sending '%s': Notify handling is NONE"
argument_list|,
name|messageClass
argument_list|)
expr_stmt|;
return|return;
block|}
name|init
argument_list|()
expr_stmt|;
if|if
condition|(
name|useHtml
argument_list|()
condition|)
block|{
name|appendHtml
argument_list|(
name|soyHtmlTemplate
argument_list|(
literal|"HeaderHtml"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|format
argument_list|()
expr_stmt|;
name|appendText
argument_list|(
name|textTemplate
argument_list|(
literal|"Footer"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|useHtml
argument_list|()
condition|)
block|{
name|appendHtml
argument_list|(
name|soyHtmlTemplate
argument_list|(
literal|"FooterHtml"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|Set
argument_list|<
name|Address
argument_list|>
name|smtpRcptToPlaintextOnly
init|=
operator|new
name|HashSet
argument_list|<>
argument_list|()
decl_stmt|;
if|if
condition|(
name|shouldSendMessage
argument_list|()
condition|)
block|{
if|if
condition|(
name|fromId
operator|!=
literal|null
condition|)
block|{
name|Optional
argument_list|<
name|AccountState
argument_list|>
name|fromUser
init|=
name|args
operator|.
name|accountCache
operator|.
name|get
argument_list|(
name|fromId
argument_list|)
decl_stmt|;
if|if
condition|(
name|fromUser
operator|.
name|isPresent
argument_list|()
condition|)
block|{
name|GeneralPreferencesInfo
name|senderPrefs
init|=
name|fromUser
operator|.
name|get
argument_list|()
operator|.
name|generalPreferences
argument_list|()
decl_stmt|;
if|if
condition|(
name|senderPrefs
operator|!=
literal|null
operator|&&
name|senderPrefs
operator|.
name|getEmailStrategy
argument_list|()
operator|==
name|CC_ON_OWN_COMMENTS
condition|)
block|{
comment|// If we are impersonating a user, make sure they receive a CC of
comment|// this message so they can always review and audit what we sent
comment|// on their behalf to others.
comment|//
name|add
argument_list|(
name|RecipientType
operator|.
name|CC
argument_list|,
name|fromId
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|notify
operator|.
name|accounts
argument_list|()
operator|.
name|containsValue
argument_list|(
name|fromId
argument_list|)
operator|&&
name|rcptTo
operator|.
name|remove
argument_list|(
name|fromId
argument_list|)
condition|)
block|{
comment|// If they don't want a copy, but we queued one up anyway,
comment|// drop them from the recipient lists.
comment|//
name|removeUser
argument_list|(
name|fromUser
operator|.
name|get
argument_list|()
operator|.
name|account
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|// Check the preferences of all recipients. If any user has disabled
comment|// his email notifications then drop him from recipients' list.
comment|// In addition, check if users only want to receive plaintext email.
for|for
control|(
name|Account
operator|.
name|Id
name|id
range|:
name|rcptTo
control|)
block|{
name|Optional
argument_list|<
name|AccountState
argument_list|>
name|thisUser
init|=
name|args
operator|.
name|accountCache
operator|.
name|get
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|thisUser
operator|.
name|isPresent
argument_list|()
condition|)
block|{
name|Account
name|thisUserAccount
init|=
name|thisUser
operator|.
name|get
argument_list|()
operator|.
name|account
argument_list|()
decl_stmt|;
name|GeneralPreferencesInfo
name|prefs
init|=
name|thisUser
operator|.
name|get
argument_list|()
operator|.
name|generalPreferences
argument_list|()
decl_stmt|;
if|if
condition|(
name|prefs
operator|==
literal|null
operator|||
name|prefs
operator|.
name|getEmailStrategy
argument_list|()
operator|==
name|DISABLED
condition|)
block|{
name|removeUser
argument_list|(
name|thisUserAccount
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|useHtml
argument_list|()
operator|&&
name|prefs
operator|.
name|getEmailFormat
argument_list|()
operator|==
name|EmailFormat
operator|.
name|PLAINTEXT
condition|)
block|{
name|removeUser
argument_list|(
name|thisUserAccount
argument_list|)
expr_stmt|;
name|smtpRcptToPlaintextOnly
operator|.
name|add
argument_list|(
operator|new
name|Address
argument_list|(
name|thisUserAccount
operator|.
name|fullName
argument_list|()
argument_list|,
name|thisUserAccount
operator|.
name|preferredEmail
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|smtpRcptTo
operator|.
name|isEmpty
argument_list|()
operator|&&
name|smtpRcptToPlaintextOnly
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|logger
operator|.
name|atFine
argument_list|()
operator|.
name|log
argument_list|(
literal|"Not sending '%s': No SMTP recipients"
argument_list|,
name|messageClass
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|// Set Reply-To only if it hasn't been set by a child class
comment|// Reply-To will already be populated for the message types where Gerrit supports
comment|// inbound email replies.
if|if
condition|(
operator|!
name|headers
operator|.
name|containsKey
argument_list|(
name|FieldName
operator|.
name|REPLY_TO
argument_list|)
condition|)
block|{
name|StringJoiner
name|j
init|=
operator|new
name|StringJoiner
argument_list|(
literal|", "
argument_list|)
decl_stmt|;
if|if
condition|(
name|fromId
operator|!=
literal|null
condition|)
block|{
name|Address
name|address
init|=
name|toAddress
argument_list|(
name|fromId
argument_list|)
decl_stmt|;
if|if
condition|(
name|address
operator|!=
literal|null
condition|)
block|{
name|j
operator|.
name|add
argument_list|(
name|address
operator|.
name|getEmail
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
name|smtpRcptTo
operator|.
name|stream
argument_list|()
operator|.
name|forEach
argument_list|(
name|a
lambda|->
name|j
operator|.
name|add
argument_list|(
name|a
operator|.
name|getEmail
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|smtpRcptToPlaintextOnly
operator|.
name|stream
argument_list|()
operator|.
name|forEach
argument_list|(
name|a
lambda|->
name|j
operator|.
name|add
argument_list|(
name|a
operator|.
name|getEmail
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|setHeader
argument_list|(
name|FieldName
operator|.
name|REPLY_TO
argument_list|,
name|j
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|String
name|textPart
init|=
name|textBody
operator|.
name|toString
argument_list|()
decl_stmt|;
name|OutgoingEmailValidationListener
operator|.
name|Args
name|va
init|=
operator|new
name|OutgoingEmailValidationListener
operator|.
name|Args
argument_list|()
decl_stmt|;
name|va
operator|.
name|messageClass
operator|=
name|messageClass
expr_stmt|;
name|va
operator|.
name|smtpFromAddress
operator|=
name|smtpFromAddress
expr_stmt|;
name|va
operator|.
name|smtpRcptTo
operator|=
name|smtpRcptTo
expr_stmt|;
name|va
operator|.
name|headers
operator|=
name|headers
expr_stmt|;
name|va
operator|.
name|body
operator|=
name|textPart
expr_stmt|;
if|if
condition|(
name|useHtml
argument_list|()
condition|)
block|{
name|va
operator|.
name|htmlBody
operator|=
name|htmlBody
operator|.
name|toString
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|va
operator|.
name|htmlBody
operator|=
literal|null
expr_stmt|;
block|}
for|for
control|(
name|OutgoingEmailValidationListener
name|validator
range|:
name|args
operator|.
name|outgoingEmailValidationListeners
control|)
block|{
try|try
block|{
name|validator
operator|.
name|validateOutgoingEmail
argument_list|(
name|va
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ValidationException
name|e
parameter_list|)
block|{
name|logger
operator|.
name|atFine
argument_list|()
operator|.
name|log
argument_list|(
literal|"Not sending '%s': Rejected by outgoing email validator: %s"
argument_list|,
name|messageClass
argument_list|,
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|Set
argument_list|<
name|Address
argument_list|>
name|intersection
init|=
name|Sets
operator|.
name|intersection
argument_list|(
name|smtpRcptTo
argument_list|,
name|smtpRcptToPlaintextOnly
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|intersection
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|logger
operator|.
name|atSevere
argument_list|()
operator|.
name|log
argument_list|(
literal|"Email '%s' will be sent twice to %s"
argument_list|,
name|messageClass
argument_list|,
name|intersection
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|smtpRcptTo
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|// Send multipart message
name|logger
operator|.
name|atFine
argument_list|()
operator|.
name|log
argument_list|(
literal|"Sending multipart '%s'"
argument_list|,
name|messageClass
argument_list|)
expr_stmt|;
name|args
operator|.
name|emailSender
operator|.
name|send
argument_list|(
name|va
operator|.
name|smtpFromAddress
argument_list|,
name|va
operator|.
name|smtpRcptTo
argument_list|,
name|va
operator|.
name|headers
argument_list|,
name|va
operator|.
name|body
argument_list|,
name|va
operator|.
name|htmlBody
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|smtpRcptToPlaintextOnly
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|logger
operator|.
name|atFine
argument_list|()
operator|.
name|log
argument_list|(
literal|"Sending plaintext '%s'"
argument_list|,
name|messageClass
argument_list|)
expr_stmt|;
comment|// Send plaintext message
name|Map
argument_list|<
name|String
argument_list|,
name|EmailHeader
argument_list|>
name|shallowCopy
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|shallowCopy
operator|.
name|putAll
argument_list|(
name|headers
argument_list|)
expr_stmt|;
comment|// Remove To and Cc
name|shallowCopy
operator|.
name|remove
argument_list|(
name|FieldName
operator|.
name|TO
argument_list|)
expr_stmt|;
name|shallowCopy
operator|.
name|remove
argument_list|(
name|FieldName
operator|.
name|CC
argument_list|)
expr_stmt|;
for|for
control|(
name|Address
name|a
range|:
name|smtpRcptToPlaintextOnly
control|)
block|{
comment|// Add new To
name|EmailHeader
operator|.
name|AddressList
name|to
init|=
operator|new
name|EmailHeader
operator|.
name|AddressList
argument_list|()
decl_stmt|;
name|to
operator|.
name|add
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|shallowCopy
operator|.
name|put
argument_list|(
name|FieldName
operator|.
name|TO
argument_list|,
name|to
argument_list|)
expr_stmt|;
block|}
name|args
operator|.
name|emailSender
operator|.
name|send
argument_list|(
name|va
operator|.
name|smtpFromAddress
argument_list|,
name|smtpRcptToPlaintextOnly
argument_list|,
name|shallowCopy
argument_list|,
name|va
operator|.
name|body
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/** Format the message body by calling {@link #appendText(String)}. */
DECL|method|format ()
specifier|protected
specifier|abstract
name|void
name|format
parameter_list|()
throws|throws
name|EmailException
function_decl|;
comment|/**    * Setup the message headers and envelope (TO, CC, BCC).    *    * @throws EmailException if an error occurred.    */
DECL|method|init ()
specifier|protected
name|void
name|init
parameter_list|()
throws|throws
name|EmailException
block|{
name|setupSoyContext
argument_list|()
expr_stmt|;
name|smtpFromAddress
operator|=
name|args
operator|.
name|fromAddressGenerator
operator|.
name|from
argument_list|(
name|fromId
argument_list|)
expr_stmt|;
name|setHeader
argument_list|(
name|FieldName
operator|.
name|DATE
argument_list|,
operator|new
name|Date
argument_list|()
argument_list|)
expr_stmt|;
name|headers
operator|.
name|put
argument_list|(
name|FieldName
operator|.
name|FROM
argument_list|,
operator|new
name|EmailHeader
operator|.
name|AddressList
argument_list|(
name|smtpFromAddress
argument_list|)
argument_list|)
expr_stmt|;
name|headers
operator|.
name|put
argument_list|(
name|FieldName
operator|.
name|TO
argument_list|,
operator|new
name|EmailHeader
operator|.
name|AddressList
argument_list|()
argument_list|)
expr_stmt|;
name|headers
operator|.
name|put
argument_list|(
name|FieldName
operator|.
name|CC
argument_list|,
operator|new
name|EmailHeader
operator|.
name|AddressList
argument_list|()
argument_list|)
expr_stmt|;
name|setHeader
argument_list|(
name|FieldName
operator|.
name|MESSAGE_ID
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|setHeader
argument_list|(
name|MailHeader
operator|.
name|AUTO_SUBMITTED
operator|.
name|fieldName
argument_list|()
argument_list|,
literal|"auto-generated"
argument_list|)
expr_stmt|;
for|for
control|(
name|RecipientType
name|recipientType
range|:
name|notify
operator|.
name|accounts
argument_list|()
operator|.
name|keySet
argument_list|()
control|)
block|{
name|add
argument_list|(
name|recipientType
argument_list|,
name|notify
operator|.
name|accounts
argument_list|()
operator|.
name|get
argument_list|(
name|recipientType
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|setHeader
argument_list|(
name|MailHeader
operator|.
name|MESSAGE_TYPE
operator|.
name|fieldName
argument_list|()
argument_list|,
name|messageClass
argument_list|)
expr_stmt|;
name|footers
operator|.
name|add
argument_list|(
name|MailHeader
operator|.
name|MESSAGE_TYPE
operator|.
name|withDelimiter
argument_list|()
operator|+
name|messageClass
argument_list|)
expr_stmt|;
name|textBody
operator|=
operator|new
name|StringBuilder
argument_list|()
expr_stmt|;
name|htmlBody
operator|=
operator|new
name|StringBuilder
argument_list|()
expr_stmt|;
if|if
condition|(
name|fromId
operator|!=
literal|null
operator|&&
name|args
operator|.
name|fromAddressGenerator
operator|.
name|isGenericAddress
argument_list|(
name|fromId
argument_list|)
condition|)
block|{
name|appendText
argument_list|(
name|getFromLine
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|getFromLine ()
specifier|protected
name|String
name|getFromLine
parameter_list|()
block|{
name|StringBuilder
name|f
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|Optional
argument_list|<
name|Account
argument_list|>
name|account
init|=
name|args
operator|.
name|accountCache
operator|.
name|get
argument_list|(
name|fromId
argument_list|)
operator|.
name|map
argument_list|(
name|AccountState
operator|::
name|account
argument_list|)
decl_stmt|;
if|if
condition|(
name|account
operator|.
name|isPresent
argument_list|()
condition|)
block|{
name|String
name|name
init|=
name|account
operator|.
name|get
argument_list|()
operator|.
name|fullName
argument_list|()
decl_stmt|;
name|String
name|email
init|=
name|account
operator|.
name|get
argument_list|()
operator|.
name|preferredEmail
argument_list|()
decl_stmt|;
if|if
condition|(
operator|(
name|name
operator|!=
literal|null
operator|&&
operator|!
name|name
operator|.
name|isEmpty
argument_list|()
operator|)
operator|||
operator|(
name|email
operator|!=
literal|null
operator|&&
operator|!
name|email
operator|.
name|isEmpty
argument_list|()
operator|)
condition|)
block|{
name|f
operator|.
name|append
argument_list|(
literal|"From"
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|!=
literal|null
operator|&&
operator|!
name|name
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|f
operator|.
name|append
argument_list|(
literal|" "
argument_list|)
operator|.
name|append
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|email
operator|!=
literal|null
operator|&&
operator|!
name|email
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|f
operator|.
name|append
argument_list|(
literal|"<"
argument_list|)
operator|.
name|append
argument_list|(
name|email
argument_list|)
operator|.
name|append
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
block|}
name|f
operator|.
name|append
argument_list|(
literal|":\n\n"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|f
operator|.
name|toString
argument_list|()
return|;
block|}
DECL|method|getGerritHost ()
specifier|public
name|String
name|getGerritHost
parameter_list|()
block|{
if|if
condition|(
name|getGerritUrl
argument_list|()
operator|!=
literal|null
condition|)
block|{
try|try
block|{
return|return
operator|new
name|URL
argument_list|(
name|getGerritUrl
argument_list|()
argument_list|)
operator|.
name|getHost
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|MalformedURLException
name|e
parameter_list|)
block|{
comment|// Try something else.
block|}
block|}
comment|// Fall back onto whatever the local operating system thinks
comment|// this server is called. We hopefully didn't get here as a
comment|// good admin would have configured the canonical url.
comment|//
return|return
name|SystemReader
operator|.
name|getInstance
argument_list|()
operator|.
name|getHostname
argument_list|()
return|;
block|}
DECL|method|getSettingsUrl ()
specifier|public
name|String
name|getSettingsUrl
parameter_list|()
block|{
return|return
name|args
operator|.
name|urlFormatter
operator|.
name|get
argument_list|()
operator|.
name|getSettingsUrl
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
return|;
block|}
DECL|method|getGerritUrl ()
specifier|private
name|String
name|getGerritUrl
parameter_list|()
block|{
return|return
name|args
operator|.
name|urlFormatter
operator|.
name|get
argument_list|()
operator|.
name|getWebUrl
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
return|;
block|}
comment|/** Set a header in the outgoing message. */
DECL|method|setHeader (String name, String value)
specifier|protected
name|void
name|setHeader
parameter_list|(
name|String
name|name
parameter_list|,
name|String
name|value
parameter_list|)
block|{
name|headers
operator|.
name|put
argument_list|(
name|name
argument_list|,
operator|new
name|EmailHeader
operator|.
name|String
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/** Remove a header from the outgoing message. */
DECL|method|removeHeader (String name)
specifier|protected
name|void
name|removeHeader
parameter_list|(
name|String
name|name
parameter_list|)
block|{
name|headers
operator|.
name|remove
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
DECL|method|setHeader (String name, Date date)
specifier|protected
name|void
name|setHeader
parameter_list|(
name|String
name|name
parameter_list|,
name|Date
name|date
parameter_list|)
block|{
name|headers
operator|.
name|put
argument_list|(
name|name
argument_list|,
operator|new
name|EmailHeader
operator|.
name|Date
argument_list|(
name|date
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/** Append text to the outgoing email body. */
DECL|method|appendText (String text)
specifier|protected
name|void
name|appendText
parameter_list|(
name|String
name|text
parameter_list|)
block|{
if|if
condition|(
name|text
operator|!=
literal|null
condition|)
block|{
name|textBody
operator|.
name|append
argument_list|(
name|text
argument_list|)
expr_stmt|;
block|}
block|}
comment|/** Append html to the outgoing email body. */
DECL|method|appendHtml (String html)
specifier|protected
name|void
name|appendHtml
parameter_list|(
name|String
name|html
parameter_list|)
block|{
if|if
condition|(
name|html
operator|!=
literal|null
condition|)
block|{
name|htmlBody
operator|.
name|append
argument_list|(
name|html
argument_list|)
expr_stmt|;
block|}
block|}
comment|/** Lookup a human readable name for an account, usually the "full name". */
DECL|method|getNameFor (@ullable Account.Id accountId)
specifier|protected
name|String
name|getNameFor
parameter_list|(
annotation|@
name|Nullable
name|Account
operator|.
name|Id
name|accountId
parameter_list|)
block|{
if|if
condition|(
name|accountId
operator|==
literal|null
condition|)
block|{
return|return
name|args
operator|.
name|gerritPersonIdent
operator|.
name|getName
argument_list|()
return|;
block|}
name|Optional
argument_list|<
name|Account
argument_list|>
name|account
init|=
name|args
operator|.
name|accountCache
operator|.
name|get
argument_list|(
name|accountId
argument_list|)
operator|.
name|map
argument_list|(
name|AccountState
operator|::
name|account
argument_list|)
decl_stmt|;
name|String
name|name
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|account
operator|.
name|isPresent
argument_list|()
condition|)
block|{
name|name
operator|=
name|account
operator|.
name|get
argument_list|()
operator|.
name|fullName
argument_list|()
expr_stmt|;
if|if
condition|(
name|name
operator|==
literal|null
condition|)
block|{
name|name
operator|=
name|account
operator|.
name|get
argument_list|()
operator|.
name|preferredEmail
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
name|name
operator|==
literal|null
condition|)
block|{
name|name
operator|=
name|args
operator|.
name|anonymousCowardName
operator|+
literal|" #"
operator|+
name|accountId
expr_stmt|;
block|}
return|return
name|name
return|;
block|}
comment|/**    * Gets the human readable name and email for an account; if neither are available, returns the    * Anonymous Coward name.    *    * @param accountId user to fetch.    * @return name/email of account, or Anonymous Coward if unset.    */
DECL|method|getNameEmailFor (@ullable Account.Id accountId)
specifier|protected
name|String
name|getNameEmailFor
parameter_list|(
annotation|@
name|Nullable
name|Account
operator|.
name|Id
name|accountId
parameter_list|)
block|{
if|if
condition|(
name|accountId
operator|==
literal|null
condition|)
block|{
return|return
name|args
operator|.
name|gerritPersonIdent
operator|.
name|getName
argument_list|()
operator|+
literal|"<"
operator|+
name|args
operator|.
name|gerritPersonIdent
operator|.
name|getEmailAddress
argument_list|()
operator|+
literal|">"
return|;
block|}
name|Optional
argument_list|<
name|Account
argument_list|>
name|account
init|=
name|args
operator|.
name|accountCache
operator|.
name|get
argument_list|(
name|accountId
argument_list|)
operator|.
name|map
argument_list|(
name|AccountState
operator|::
name|account
argument_list|)
decl_stmt|;
if|if
condition|(
name|account
operator|.
name|isPresent
argument_list|()
condition|)
block|{
name|String
name|name
init|=
name|account
operator|.
name|get
argument_list|()
operator|.
name|fullName
argument_list|()
decl_stmt|;
name|String
name|email
init|=
name|account
operator|.
name|get
argument_list|()
operator|.
name|preferredEmail
argument_list|()
decl_stmt|;
if|if
condition|(
name|name
operator|!=
literal|null
operator|&&
name|email
operator|!=
literal|null
condition|)
block|{
return|return
name|name
operator|+
literal|"<"
operator|+
name|email
operator|+
literal|">"
return|;
block|}
elseif|else
if|if
condition|(
name|name
operator|!=
literal|null
condition|)
block|{
return|return
name|name
return|;
block|}
elseif|else
if|if
condition|(
name|email
operator|!=
literal|null
condition|)
block|{
return|return
name|email
return|;
block|}
block|}
return|return
name|args
operator|.
name|anonymousCowardName
operator|+
literal|" #"
operator|+
name|accountId
return|;
block|}
comment|/**    * Gets the human readable name and email for an account; if both are unavailable, returns the    * username. If no username is set, this function returns null.    *    * @param accountId user to fetch.    * @return name/email of account, username, or null if unset.    */
DECL|method|getUserNameEmailFor (Account.Id accountId)
specifier|protected
name|String
name|getUserNameEmailFor
parameter_list|(
name|Account
operator|.
name|Id
name|accountId
parameter_list|)
block|{
name|Optional
argument_list|<
name|AccountState
argument_list|>
name|accountState
init|=
name|args
operator|.
name|accountCache
operator|.
name|get
argument_list|(
name|accountId
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|accountState
operator|.
name|isPresent
argument_list|()
condition|)
block|{
return|return
literal|null
return|;
block|}
name|Account
name|account
init|=
name|accountState
operator|.
name|get
argument_list|()
operator|.
name|account
argument_list|()
decl_stmt|;
name|String
name|name
init|=
name|account
operator|.
name|fullName
argument_list|()
decl_stmt|;
name|String
name|email
init|=
name|account
operator|.
name|preferredEmail
argument_list|()
decl_stmt|;
if|if
condition|(
name|name
operator|!=
literal|null
operator|&&
name|email
operator|!=
literal|null
condition|)
block|{
return|return
name|name
operator|+
literal|"<"
operator|+
name|email
operator|+
literal|">"
return|;
block|}
elseif|else
if|if
condition|(
name|email
operator|!=
literal|null
condition|)
block|{
return|return
name|email
return|;
block|}
elseif|else
if|if
condition|(
name|name
operator|!=
literal|null
condition|)
block|{
return|return
name|name
return|;
block|}
return|return
name|accountState
operator|.
name|get
argument_list|()
operator|.
name|userName
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
return|;
block|}
DECL|method|shouldSendMessage ()
specifier|protected
name|boolean
name|shouldSendMessage
parameter_list|()
block|{
if|if
condition|(
name|textBody
operator|.
name|length
argument_list|()
operator|==
literal|0
condition|)
block|{
comment|// If we have no message body, don't send.
name|logger
operator|.
name|atFine
argument_list|()
operator|.
name|log
argument_list|(
literal|"Not sending '%s': No message body"
argument_list|,
name|messageClass
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
if|if
condition|(
name|smtpRcptTo
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|// If we have nobody to send this message to, then all of our
comment|// selection filters previously for this type of message were
comment|// unable to match a destination. Don't bother sending it.
name|logger
operator|.
name|atFine
argument_list|()
operator|.
name|log
argument_list|(
literal|"Not sending '%s': No recipients"
argument_list|,
name|messageClass
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
if|if
condition|(
name|notify
operator|.
name|accounts
argument_list|()
operator|.
name|isEmpty
argument_list|()
operator|&&
name|smtpRcptTo
operator|.
name|size
argument_list|()
operator|==
literal|1
operator|&&
name|rcptTo
operator|.
name|size
argument_list|()
operator|==
literal|1
operator|&&
name|rcptTo
operator|.
name|contains
argument_list|(
name|fromId
argument_list|)
condition|)
block|{
comment|// If the only recipient is also the sender, don't bother.
comment|//
name|logger
operator|.
name|atFine
argument_list|()
operator|.
name|log
argument_list|(
literal|"Not sending '%s': Sender is only recipient"
argument_list|,
name|messageClass
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
return|return
literal|true
return|;
block|}
comment|/** Schedule this message for delivery to the listed accounts. */
DECL|method|add (RecipientType rt, Collection<Account.Id> list)
specifier|protected
name|void
name|add
parameter_list|(
name|RecipientType
name|rt
parameter_list|,
name|Collection
argument_list|<
name|Account
operator|.
name|Id
argument_list|>
name|list
parameter_list|)
block|{
name|add
argument_list|(
name|rt
argument_list|,
name|list
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
comment|/** Schedule this message for delivery to the listed accounts. */
DECL|method|add (RecipientType rt, Collection<Account.Id> list, boolean override)
specifier|protected
name|void
name|add
parameter_list|(
name|RecipientType
name|rt
parameter_list|,
name|Collection
argument_list|<
name|Account
operator|.
name|Id
argument_list|>
name|list
parameter_list|,
name|boolean
name|override
parameter_list|)
block|{
for|for
control|(
specifier|final
name|Account
operator|.
name|Id
name|id
range|:
name|list
control|)
block|{
name|add
argument_list|(
name|rt
argument_list|,
name|id
argument_list|,
name|override
argument_list|)
expr_stmt|;
block|}
block|}
comment|/** Schedule this message for delivery to the listed address. */
DECL|method|addByEmail (RecipientType rt, Collection<Address> list)
specifier|protected
name|void
name|addByEmail
parameter_list|(
name|RecipientType
name|rt
parameter_list|,
name|Collection
argument_list|<
name|Address
argument_list|>
name|list
parameter_list|)
block|{
name|addByEmail
argument_list|(
name|rt
argument_list|,
name|list
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
comment|/** Schedule this message for delivery to the listed address. */
DECL|method|addByEmail (RecipientType rt, Collection<Address> list, boolean override)
specifier|protected
name|void
name|addByEmail
parameter_list|(
name|RecipientType
name|rt
parameter_list|,
name|Collection
argument_list|<
name|Address
argument_list|>
name|list
parameter_list|,
name|boolean
name|override
parameter_list|)
block|{
for|for
control|(
specifier|final
name|Address
name|id
range|:
name|list
control|)
block|{
name|add
argument_list|(
name|rt
argument_list|,
name|id
argument_list|,
name|override
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|add (RecipientType rt, UserIdentity who)
specifier|protected
name|void
name|add
parameter_list|(
name|RecipientType
name|rt
parameter_list|,
name|UserIdentity
name|who
parameter_list|)
block|{
name|add
argument_list|(
name|rt
argument_list|,
name|who
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
DECL|method|add (RecipientType rt, UserIdentity who, boolean override)
specifier|protected
name|void
name|add
parameter_list|(
name|RecipientType
name|rt
parameter_list|,
name|UserIdentity
name|who
parameter_list|,
name|boolean
name|override
parameter_list|)
block|{
if|if
condition|(
name|who
operator|!=
literal|null
operator|&&
name|who
operator|.
name|getAccount
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|add
argument_list|(
name|rt
argument_list|,
name|who
operator|.
name|getAccount
argument_list|()
argument_list|,
name|override
argument_list|)
expr_stmt|;
block|}
block|}
comment|/** Schedule delivery of this message to the given account. */
DECL|method|add (RecipientType rt, Account.Id to)
specifier|protected
name|void
name|add
parameter_list|(
name|RecipientType
name|rt
parameter_list|,
name|Account
operator|.
name|Id
name|to
parameter_list|)
block|{
name|add
argument_list|(
name|rt
argument_list|,
name|to
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
DECL|method|add (RecipientType rt, Account.Id to, boolean override)
specifier|protected
name|void
name|add
parameter_list|(
name|RecipientType
name|rt
parameter_list|,
name|Account
operator|.
name|Id
name|to
parameter_list|,
name|boolean
name|override
parameter_list|)
block|{
try|try
block|{
if|if
condition|(
operator|!
name|rcptTo
operator|.
name|contains
argument_list|(
name|to
argument_list|)
operator|&&
name|isVisibleTo
argument_list|(
name|to
argument_list|)
condition|)
block|{
name|rcptTo
operator|.
name|add
argument_list|(
name|to
argument_list|)
expr_stmt|;
name|add
argument_list|(
name|rt
argument_list|,
name|toAddress
argument_list|(
name|to
argument_list|)
argument_list|,
name|override
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|PermissionBackendException
name|e
parameter_list|)
block|{
name|logger
operator|.
name|atSevere
argument_list|()
operator|.
name|withCause
argument_list|(
name|e
argument_list|)
operator|.
name|log
argument_list|(
literal|"Error reading database for account: %s"
argument_list|,
name|to
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * @param to account.    * @throws PermissionBackendException    * @return whether this email is visible to the given account.    */
DECL|method|isVisibleTo (Account.Id to)
specifier|protected
name|boolean
name|isVisibleTo
parameter_list|(
name|Account
operator|.
name|Id
name|to
parameter_list|)
throws|throws
name|PermissionBackendException
block|{
return|return
literal|true
return|;
block|}
comment|/** Schedule delivery of this message to the given account. */
DECL|method|add (RecipientType rt, Address addr)
specifier|protected
name|void
name|add
parameter_list|(
name|RecipientType
name|rt
parameter_list|,
name|Address
name|addr
parameter_list|)
block|{
name|add
argument_list|(
name|rt
argument_list|,
name|addr
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
DECL|method|add (RecipientType rt, Address addr, boolean override)
specifier|protected
name|void
name|add
parameter_list|(
name|RecipientType
name|rt
parameter_list|,
name|Address
name|addr
parameter_list|,
name|boolean
name|override
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|!=
literal|null
operator|&&
name|addr
operator|.
name|getEmail
argument_list|()
operator|!=
literal|null
operator|&&
name|addr
operator|.
name|getEmail
argument_list|()
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|args
operator|.
name|validator
operator|.
name|isValid
argument_list|(
name|addr
operator|.
name|getEmail
argument_list|()
argument_list|)
condition|)
block|{
name|logger
operator|.
name|atWarning
argument_list|()
operator|.
name|log
argument_list|(
literal|"Not emailing %s (invalid email address)"
argument_list|,
name|addr
operator|.
name|getEmail
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|args
operator|.
name|emailSender
operator|.
name|canEmail
argument_list|(
name|addr
operator|.
name|getEmail
argument_list|()
argument_list|)
condition|)
block|{
name|logger
operator|.
name|atWarning
argument_list|()
operator|.
name|log
argument_list|(
literal|"Not emailing %s (prohibited by allowrcpt)"
argument_list|,
name|addr
operator|.
name|getEmail
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|smtpRcptTo
operator|.
name|add
argument_list|(
name|addr
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|override
condition|)
block|{
return|return;
block|}
operator|(
operator|(
name|EmailHeader
operator|.
name|AddressList
operator|)
name|headers
operator|.
name|get
argument_list|(
name|FieldName
operator|.
name|TO
argument_list|)
operator|)
operator|.
name|remove
argument_list|(
name|addr
operator|.
name|getEmail
argument_list|()
argument_list|)
expr_stmt|;
operator|(
operator|(
name|EmailHeader
operator|.
name|AddressList
operator|)
name|headers
operator|.
name|get
argument_list|(
name|FieldName
operator|.
name|CC
argument_list|)
operator|)
operator|.
name|remove
argument_list|(
name|addr
operator|.
name|getEmail
argument_list|()
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|rt
condition|)
block|{
case|case
name|TO
case|:
operator|(
operator|(
name|EmailHeader
operator|.
name|AddressList
operator|)
name|headers
operator|.
name|get
argument_list|(
name|FieldName
operator|.
name|TO
argument_list|)
operator|)
operator|.
name|add
argument_list|(
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|CC
case|:
operator|(
operator|(
name|EmailHeader
operator|.
name|AddressList
operator|)
name|headers
operator|.
name|get
argument_list|(
name|FieldName
operator|.
name|CC
argument_list|)
operator|)
operator|.
name|add
argument_list|(
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|BCC
case|:
break|break;
block|}
block|}
block|}
block|}
DECL|method|toAddress (Account.Id id)
specifier|private
name|Address
name|toAddress
parameter_list|(
name|Account
operator|.
name|Id
name|id
parameter_list|)
block|{
name|Optional
argument_list|<
name|Account
argument_list|>
name|accountState
init|=
name|args
operator|.
name|accountCache
operator|.
name|get
argument_list|(
name|id
argument_list|)
operator|.
name|map
argument_list|(
name|AccountState
operator|::
name|account
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|accountState
operator|.
name|isPresent
argument_list|()
condition|)
block|{
return|return
literal|null
return|;
block|}
name|Account
name|account
init|=
name|accountState
operator|.
name|get
argument_list|()
decl_stmt|;
name|String
name|e
init|=
name|account
operator|.
name|preferredEmail
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|account
operator|.
name|isActive
argument_list|()
operator|||
name|e
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
return|return
operator|new
name|Address
argument_list|(
name|account
operator|.
name|fullName
argument_list|()
argument_list|,
name|e
argument_list|)
return|;
block|}
DECL|method|setupSoyContext ()
specifier|protected
name|void
name|setupSoyContext
parameter_list|()
block|{
name|soyContext
operator|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
expr_stmt|;
name|footers
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
expr_stmt|;
name|soyContext
operator|.
name|put
argument_list|(
literal|"messageClass"
argument_list|,
name|messageClass
argument_list|)
expr_stmt|;
name|soyContext
operator|.
name|put
argument_list|(
literal|"footers"
argument_list|,
name|footers
argument_list|)
expr_stmt|;
name|soyContextEmailData
operator|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
expr_stmt|;
name|soyContextEmailData
operator|.
name|put
argument_list|(
literal|"settingsUrl"
argument_list|,
name|getSettingsUrl
argument_list|()
argument_list|)
expr_stmt|;
name|soyContextEmailData
operator|.
name|put
argument_list|(
literal|"instanceName"
argument_list|,
name|getInstanceName
argument_list|()
argument_list|)
expr_stmt|;
name|soyContextEmailData
operator|.
name|put
argument_list|(
literal|"gerritHost"
argument_list|,
name|getGerritHost
argument_list|()
argument_list|)
expr_stmt|;
name|soyContextEmailData
operator|.
name|put
argument_list|(
literal|"gerritUrl"
argument_list|,
name|getGerritUrl
argument_list|()
argument_list|)
expr_stmt|;
name|soyContext
operator|.
name|put
argument_list|(
literal|"email"
argument_list|,
name|soyContextEmailData
argument_list|)
expr_stmt|;
block|}
DECL|method|getInstanceName ()
specifier|private
name|String
name|getInstanceName
parameter_list|()
block|{
return|return
name|args
operator|.
name|instanceNameProvider
operator|.
name|get
argument_list|()
return|;
block|}
comment|/** Renders a soy template of kind="text". */
DECL|method|textTemplate (String name)
specifier|protected
name|String
name|textTemplate
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|configureRenderer
argument_list|(
name|name
argument_list|)
operator|.
name|renderText
argument_list|()
operator|.
name|get
argument_list|()
return|;
block|}
comment|/** Renders a soy template of kind="html". */
DECL|method|soyHtmlTemplate (String name)
specifier|protected
name|String
name|soyHtmlTemplate
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|configureRenderer
argument_list|(
name|name
argument_list|)
operator|.
name|renderHtml
argument_list|()
operator|.
name|get
argument_list|()
operator|.
name|toString
argument_list|()
return|;
block|}
comment|/** Configures a soy renderer for the given template name and rendering data map. */
DECL|method|configureRenderer (String templateName)
specifier|private
name|SoySauce
operator|.
name|Renderer
name|configureRenderer
parameter_list|(
name|String
name|templateName
parameter_list|)
block|{
return|return
name|args
operator|.
name|soySauce
operator|.
name|renderTemplate
argument_list|(
name|SOY_TEMPLATE_NAMESPACE
operator|+
name|templateName
argument_list|)
operator|.
name|setData
argument_list|(
name|soyContext
argument_list|)
return|;
block|}
DECL|method|removeUser (Account user)
specifier|protected
name|void
name|removeUser
parameter_list|(
name|Account
name|user
parameter_list|)
block|{
name|String
name|fromEmail
init|=
name|user
operator|.
name|preferredEmail
argument_list|()
decl_stmt|;
for|for
control|(
name|Iterator
argument_list|<
name|Address
argument_list|>
name|j
init|=
name|smtpRcptTo
operator|.
name|iterator
argument_list|()
init|;
name|j
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
if|if
condition|(
name|j
operator|.
name|next
argument_list|()
operator|.
name|getEmail
argument_list|()
operator|.
name|equals
argument_list|(
name|fromEmail
argument_list|)
condition|)
block|{
name|j
operator|.
name|remove
argument_list|()
expr_stmt|;
block|}
block|}
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|EmailHeader
argument_list|>
name|entry
range|:
name|headers
operator|.
name|entrySet
argument_list|()
control|)
block|{
comment|// Don't remove fromEmail from the "From" header though!
if|if
condition|(
name|entry
operator|.
name|getValue
argument_list|()
operator|instanceof
name|AddressList
operator|&&
operator|!
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|equals
argument_list|(
literal|"From"
argument_list|)
condition|)
block|{
operator|(
operator|(
name|AddressList
operator|)
name|entry
operator|.
name|getValue
argument_list|()
operator|)
operator|.
name|remove
argument_list|(
name|fromEmail
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|useHtml ()
specifier|protected
specifier|final
name|boolean
name|useHtml
parameter_list|()
block|{
return|return
name|args
operator|.
name|settings
operator|.
name|html
operator|&&
name|supportsHtml
argument_list|()
return|;
block|}
comment|/** Override this method to enable HTML in a subclass. */
DECL|method|supportsHtml ()
specifier|protected
name|boolean
name|supportsHtml
parameter_list|()
block|{
return|return
literal|false
return|;
block|}
block|}
end_class

end_unit

